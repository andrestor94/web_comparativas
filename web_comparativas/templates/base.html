<!doctype html>
{% if user %}
{% set _display_name = (user.name or user.full_name or user.nombre) %}
{% if not _display_name %}
{% set _email = user.email|default('') %}
{% set parts = _email|split('@') %}
{% set _alias = (parts[0] if parts|length > 0 else '') %}
{% set _alias = _alias|replace('.',' ')|replace('_',' ')|replace('-',' ') %}
{% set _display_name = _alias|title %}
{% endif %}
{% else %}
{% set _display_name = '' %}
{% endif %}
<html lang="es" data-user-role="{{ (user and (user.role or ''))|lower }}"
  data-user-display="{{ _display_name or 'Yo' }}">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#eeede8" />
  <title>{% block title %}Web Comparativas{% endblock %}</title>

  <!-- Google Fonts: Outfit -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Tema personalizado (global) + cache-busting -->
  <link rel="stylesheet" href="{{ url_for('static', path='css/app.theme.css') }}?v=20251209-pro">

  <style>
    /* SPLASH SCREEN (PREMIUM) */
    #splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #ffffff;
      z-index: 99999;
      /* Even higher */
      display: flex;
      /* Always visible initially */
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transition: opacity 0.6s cubic-bezier(0.16, 1, 0.3, 1), visibility 0.6s ease;
    }

    #splash-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
    }

    #splash-logo {
      width: 450px;
      max-width: 80vw;
      height: auto;
      opacity: 0;
      filter: blur(10px);
      transform: scale(0.95);
      animation: logo-premium-entry 1.2s cubic-bezier(0.19, 1, 0.22, 1) forwards;
      image-rendering: -webkit-optimize-contrast;
      backface-visibility: hidden;
      will-change: transform, opacity, filter;
    }

    .splash-loader {
      width: 60px;
      height: 3px;
      background: rgba(6, 64, 102, 0.1);
      border-radius: 99px;
      overflow: hidden;
      position: relative;
      opacity: 0;
      animation: fade-in-simple 0.8s ease-out 0.4s forwards;
    }

    .splash-loader::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 40%;
      background: #064066;
      /* var(--sa-azul) */
      border-radius: 99px;
      animation: loader-slide 1.5s infinite ease-in-out;
    }

    @keyframes logo-premium-entry {
      0% {
        opacity: 0;
        filter: blur(10px);
        transform: scale(0.95);
      }

      100% {
        opacity: 1;
        filter: blur(0);
        transform: scale(1);
      }
    }

    @keyframes fade-in-simple {
      to {
        opacity: 1;
      }
    }

    @keyframes loader-slide {
      0% {
        left: -40%;
      }

      50% {
        left: 100%;
      }

      100% {
        left: -40%;
      }
    }

    .splash-hidden {
      opacity: 0 !important;
      visibility: hidden;
      pointer-events: none;
    }
  </style>

  <!-- ========== Notificaciones SA (UI) ========== -->
  <style>
    /* ===== pill del usuario (header, arriba a la derecha) ===== */
    .top-user-pill {
      background-color: #6886c4;
      color: #ffffff;
      border-radius: 9999px;
      padding: 3px 12px 4px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      line-height: 1.1;
      white-space: nowrap;
    }

    .top-user-pill span,
    .top-user-pill i,
    .top-user-pill svg {
      color: #ffffff;
    }

    /* ===== Notificaciones SA ===== */
    #toast-root {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 4000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }

    .sa-toast {
      pointer-events: auto;
      background: var(--sa-blanco, #fff);
      color: var(--sa-text, #064066);
      border: 1px solid var(--sa-gris-borde, #e5e7eb);
      border-radius: 12px;
      box-shadow: var(--shadow-2, 0 10px 32px rgba(6, 64, 102, .12));
      padding: 12px 14px 10px;
      width: min(360px, 90vw);
      transform: translateY(8px);
      animation: sa-toast-in .18s ease-out both;
    }

    .sa-toast--out {
      animation: sa-toast-out .18s ease-in both;
    }

    .sa-toast__head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .sa-toast__title {
      font-weight: 700;
      font-size: 15px;
    }

    .sa-toast__body {
      font-size: 14px;
      margin-top: 4px;
    }

    .sa-toast__footer {
      margin-top: 8px;
    }

    .sa-toast__action {
      background: #eef2f7;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 6px 10px;
      font-weight: 600;
      cursor: pointer;
    }

    .sa-toast__close {
      background: transparent;
      border: 0;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      color: #64748b;
    }

    .sa-toast__bar {
      height: 3px;
      width: 100%;
      margin-top: 8px;
      transform-origin: left center;
      transform: scaleX(1);
      border-radius: 2px;
      opacity: .9;
    }

    @keyframes sa-toast-in {
      from {
        opacity: 0;
        transform: translateY(8px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    @keyframes sa-toast-out {
      from {
        opacity: 1;
        transform: translateY(0)
      }

      to {
        opacity: 0;
        transform: translateY(6px)
      }
    }

    #banner-root {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3500;
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: min(820px, 94vw);
    }

    .sa-banner {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--sa-gris-soft, #eef2f7);
      border: 1px solid var(--sa-gris-borde, #e5e7eb);
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: var(--shadow-1, 0 3px 14px rgba(6, 64, 102, .06));
    }

    .sa-banner__dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      flex: 0 0 auto;
    }

    .sa-banner__msg {
      color: var(--sa-text, #064066);
      font-size: 14px;
    }

    .sa-banner__close {
      margin-left: auto;
      background: transparent;
      border: 0;
      font-size: 18px;
      cursor: pointer;
      color: #64748b;
    }

    /* ====== Sidebar: toggler con caret (seguro) ====== */
    .nav-link-toggle {
      cursor: pointer;
      background: transparent;
      color: inherit;
      border: 0;
      text-align: left;
      width: 100%;
      padding: .375rem .75rem;
      border-radius: .375rem;
    }

    .nav-link-toggle .caret {
      font-size: .9rem;
      transition: transform .18s ease;
    }

    .nav-link-toggle[aria-expanded="true"] .caret {
      transform: rotate(90deg);
    }

    /* submen√∫ con sangr√≠a */
    .nav .submenu a.nav-link {
      padding-left: 1.75rem;
    }

    /* SIEM Sidebar Brand */
    .sidebar-brand-container {
      padding: 1rem 1rem;
      border-bottom: 1px solid var(--sa-gris-borde, #e5e7eb);
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .sidebar-logo {
      height: 58px;
      /* Increased from 42px for sharp visibility */
      width: auto;
      object-fit: contain;
      align-self: flex-start;
      margin-bottom: 0.25rem;
      /* Subtle entry animation */
      animation: fade-in-logo 0.8s ease-out forwards;

      /* Rendering fixes for pixelation */
      image-rendering: -webkit-optimize-contrast;
      transform: translateZ(0);
      /* Trigger GPU */
    }

    .sidebar-market-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--ink-400);
      font-weight: 700;
      margin-top: 2px;
    }

    @keyframes fade-in-logo {
      from {
        opacity: 0;
        transform: translateX(-5px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
  </style>
  <!-- ========== /Notificaciones SA (UI) ========== -->

  {% block extra_head %}{% endblock %}
  {% block page_skin %}{% endblock %}
</head>

<body class="{% block body_class %}{% endblock %}">
  <!-- SPLASH SCREEN ELEMENT (Universal) -->
  <div id="splash-screen">
    <div id="splash-content">
      <img id="splash-logo" src="{{ url_for('static', path='img/logo_siem_azul.png') }}"
        alt="SIEM - Sistema Integrado de Estimaci√≥n de Mercados" />
      <div class="splash-loader"></div>
    </div>
  </div>

  <script>
    (function () {
      const splash = document.getElementById('splash-screen');
      window.addEventListener('load', () => {
        setTimeout(() => {
          splash.classList.add('splash-hidden');
        }, 2200);
      });
    })();
  </script>

  <div class="app d-flex" style="min-height:100vh">
    <!-- Sidebar -->
    {% if user %}
    <aside class="sidebar" role="navigation" aria-label="Men√∫ lateral">
      <div class="sidebar-brand-container">
        <!-- Logo SIEM Blanco (contraste fondo oscuro) -->
        <img src="{{ url_for('static', path='img/logo_siem_blanco.png') }}" alt="SIEM" class="sidebar-logo">

        {% if market_context == 'private' %}
        <div class="sidebar-market-label" style="color: var(--sa-azul-alt, #5274ce);">Mercado Privado</div>
        {% else %}
        <div class="sidebar-market-label">Mercado P√∫blico</div>
        {% endif %}
      </div>

      {% if user %}
      {% set r = (user.role or user.rol or '')|lower %}
      {% else %}
      {% set r = '' %}
      {% endif %}

      <nav class="nav flex-column px-3 py-2 gap-1">

        {% if market_context == 'private' %}
        <!-- ================= MEN√ö MERCADO PRIVADO ================= -->

        <!-- Home -->
        <a href="/mercado-privado" class="nav-link {% if request.url.path == '/mercado-privado' %}active{% endif %}">
          Home
        </a>

        <!-- Dimensionamiento de mercado -->
        <a href="/mercado-privado/dimensiones"
          class="nav-link {% if request.url.path.startswith('/mercado-privado/dimensiones') %}active{% endif %}">
          Dimensionamiento
        </a>

        <!-- Reporte perfiles (Reutilizado) -->
        {% if user and r in ['admin','supervisor','auditor'] %}
        <a href="/mercado-privado/reporte-perfiles"
          class="nav-link {% if request.url.path.startswith('/mercado-privado/reporte-perfiles') %}active{% endif %}">
          Reporte perfiles
        </a>
        {% endif %}

        <!-- Mesa de ayuda (Reutilizado) -->
        {% if user and r in ['analista','supervisor','auditor'] %}
        {% set is_comments = request.url.path.startswith('/mercado-privado/comentarios') %}
        <a href="/mercado-privado/helpdesk"
          class="nav-link d-flex align-items-center justify-content-between {% if is_comments %}active{% endif %}"
          id="cmMenuLink" title="Mesa de ayuda">
          <span>Mesa de ayuda</span>
          <span class="ms-2">
            <span id="cmMenuBadge" class="badge rounded-pill bg-primary-subtle text-primary"
              style="display:none">0</span>
          </span>
        </a>
        {% endif %}

        <!-- Mi contrase√±a -->
        <a href="/mercado-privado/mi-password"
          class="nav-link {% if request.url.path.startswith('/mercado-privado/mi-password') %}active{% endif %}">
          Mi contrase√±a
        </a>

        {% else %}
        <!-- ================= MEN√ö MERCADO P√öBLICO (DEFAULT) ================= -->

        {% set _pending = total_pending|default(None) %}
        {% set _done = total_done|default(None) %}

        {# --- Abrir autom√°ticamente los submen√∫s si estamos en alguna de sus rutas --- #}
        {% set wc_expand =
        request.url.path.startswith('/mercado-publico/web-comparativas')
        or request.url.path.startswith('/cargas')
        or request.url.path == '/historial'
        or request.url.path.startswith('/tablero')
        or request.url.path.startswith('/grupos') %}

        {% set op_expand =
        request.url.path.startswith('/oportunidades')
        or request.url.path.startswith('/mercado-publico/oportunidades') %}

        <!-- Home Mercado P√∫blico -->
        <a href="/mercado-publico" class="nav-link {% if request.url.path == '/mercado-publico' %}active{% endif %}">
          Home
        </a>

        <!-- ====== Web Comparativa (submen√∫ colapsable) ====== -->
        <a class="nav-link nav-link-toggle d-flex align-items-center justify-content-between" data-bs-toggle="collapse"
          href="#wcMenu" role="button" aria-expanded="false" aria-controls="wcMenu">
          <span>Comparativa</span>
          <span class="caret">‚ñ∏</span>
        </a>

        <div id="wcMenu" class="collapse submenu">


          <!-- Secci√≥n: PRINCIPALES -->
          <div class="px-3 mt-3 mb-1 text-uppercase"
            style="font-size: 0.65rem; letter-spacing: 0.5px; font-weight: 700; color: rgba(255,255,255,0.65);">
            Principales
          </div>

          {% if user and r in ['admin','analista','supervisor'] %}
          <a href="/otras-fuentes/nueva"
            class="nav-link {% if request.url.path.startswith('/otras-fuentes/nueva') %}active{% endif %}">
            Nueva carga
          </a>
          {% endif %}

          <div class="px-3 mt-3 mb-1 text-uppercase"
            style="font-size: 0.65rem; letter-spacing: 0.5px; font-weight: 700; color: rgba(255,255,255,0.65);">
            Otras Fuentes
          </div>
          <a href="/otras-fuentes-externas"
            class="nav-link {% if request.url.path.startswith('/otras-fuentes-externas') %}active{% endif %}">
            Nueva carga
          </a>

          <!-- Separador -->
          <div class="my-2 border-top border-white opacity-10 mx-3"></div>

          {% if user and r in ['admin','analista','supervisor','auditor'] %}
          {% set is_hist =
          request.url.path.startswith('/cargas/historial')
          or request.url.path == '/historial'
          or (request.url.path.startswith('/cargas/') and not request.url.path.startswith('/cargas/nueva'))
          or request.url.path.startswith('/tablero/') %}
          <a href="/cargas/historial"
            class="nav-link d-flex align-items-center justify-content-between {% if is_hist %}active{% endif %}">
            <span>Historial</span>
            <span class="ms-2">
              {% if _pending is not none and _pending|int > 0 %}
              <span class="badge rounded-pill bg-warning-subtle text-warning">{{ _pending }}</span>
              {% endif %}
              {% if _done is not none and _done|int > 0 %}
              <span class="badge rounded-pill bg-success-subtle text-success ms-1">{{ _done }}</span>
              {% endif %}
            </span>
          </a>
          {% endif %}

          {% if user and r in ['admin','supervisor'] %}
          {% set is_groups = request.url.path.startswith('/grupos') %}
          <a href="/grupos" class="nav-link {% if is_groups %}active{% endif %}">
            Grupos
          </a>
          {% endif %}
        </div>
        <!-- ====== /Web Comparativa ====== -->

        <!-- ====== Oportunidades (submen√∫ colapsable) ====== -->
        {% if user and r in ['admin','analista','supervisor','auditor'] %}
        <a class="nav-link nav-link-toggle d-flex align-items-center justify-content-between" data-bs-toggle="collapse"
          href="#opMenu" role="button" aria-expanded="{{ 'true' if op_expand else 'false' }}" aria-controls="opMenu">
          <span>Oportunidades</span>
          <span class="caret">‚ñ∏</span>
        </a>

        <div id="opMenu" class="collapse submenu {% if op_expand %}show{% endif %}">
          <a href="/oportunidades/buscador"
            class="nav-link {% if request.url.path.startswith('/oportunidades/buscador') or request.url.path.startswith('/mercado-publico/oportunidades/buscador') %}active{% endif %}">
            Buscador
          </a>
          <a href="/oportunidades/dimensiones"
            class="nav-link {% if request.url.path.startswith('/oportunidades/dimensiones') or request.url.path.startswith('/mercado-publico/oportunidades/dimensiones') %}active{% endif %}">
            Dimensiones
          </a>
        </div>
        {% endif %}
        <!-- ====== /Oportunidades ====== -->

        <!-- Reporte perfiles -->
        {% if user and r in ['admin','supervisor','auditor'] %}
        <a href="/mercado-publico/reporte-perfiles"
          class="nav-link {% if request.url.path.startswith('/mercado-publico/reporte-perfiles') %}active{% endif %}">
          Reporte perfiles
        </a>
        {% endif %}

        <!-- Mesa de ayuda -->
        <!-- Mesa de ayuda (SIC) -->
        {% if user %}
        {% if (r in ['analista', 'supervisor', 'auditor']) %}
        <a href="/mercado-publico/helpdesk"
          class="nav-link d-flex align-items-center justify-content-between {% if request.url.path.startswith('/mercado-publico/helpdesk') %}active{% endif %}"
          title="Mesa de ayuda">
          <span>Mesa de ayuda</span>
        </a>
        {% elif (r == 'admin') %}
        <a href="/sic/helpdesk"
          class="nav-link d-flex align-items-center justify-content-between {% if request.url.path.startswith('/sic/helpdesk') %}active{% endif %}"
          title="Mesa de ayuda">
          <span>Mesa de ayuda (SIC)</span>
          <span class="ms-2">
            <i class="bi bi-box-arrow-up-right" style="font-size: 0.7em;"></i>
          </span>
        </a>
        {% endif %}
        {% endif %}







        <!-- Mi contrase√±a -->
        {% if user %}
        <a href="/mi/password" class="nav-link {% if request.url.path.startswith('/mi/password') %}active{% endif %}">
          Mi contrase√±a
        </a>
        {% endif %}

        {% endif %} <!-- End if market_context -->

      </nav>

      <div class="signout mt-auto px-3 py-3 border-top">
        {% if user %}
        <div class="small fw-semibold mb-2 text-muted px-1" style="font-size:0.7rem;">
          Volver a la selecci√≥n
        </div>
        {% if r != 'analista' or (user.access_scope or '') == 'todos' %}
        <a class="btn btn-outline-secondary w-100 mb-2 btn-sm" href="/switch-market">Cambiar Mercado</a>
        {% endif %}
        <a class="btn btn-outline-danger w-100 btn-sm" href="/logout">Salir</a>
        {% else %}
        <a class="btn btn-primary w-100" href="/login">Ingresar</a>
        {% endif %}
      </div>
    </aside>
    {% endif %}

    <!-- Main -->
    <main class="main flex-fill">
      <!-- Header -->
      <header class="header d-flex align-items-center gap-3 px-3 py-2 border-bottom bg-white">
        <div class="title h5 m-0">{% block header_title %}Panel{% endblock %}</div>

        <div class="d-none d-md-flex align-items-center gap-2">
          {% block toolbar_actions %}
          {% if user and (user.role or '')|lower in ['admin','supervisor']
          and request.url.path.startswith('/grupos')
          and request.url.path != '/grupos/nuevo' %}
          <a class="btn btn-sm btn-primary" href="/grupos/nuevo">+ Nuevo grupo</a>
          {% endif %}
          {% endblock %}
        </div>

        <div class="ms-auto d-flex align-items-center gap-3">



          <form class="search position-relative" role="search" aria-label="Buscar en historial" id="app-search-form">
            <input class="form-control form-control-sm pe-5" id="app-search-input" type="search" placeholder="Buscar‚Ä¶"
              aria-label="Buscar" value="{{ q|default('') }}" />
            <span class="position-absolute top-50 end-0 translate-middle-y pe-2 text-muted">üîé</span>
          </form>



          <div class="meta small text-muted d-flex flex-column flex-md-row gap-1 gap-md-2 align-items-md-center">

            <!-- Notificaciones Icon -->
            {% if user %}
            <div class="position-relative me-2" id="nav-notif-container">
              <a href="/notifications" class="text-secondary opacity-75 hover-opacity-100" title="Notificaciones">
                <i class="bi bi-bell-fill fs-5"></i>
                <span id="nav-notif-badge"
                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-white p-1"
                  style="display:none;font-size:0.6rem;">
                  <span class="visually-hidden">New alerts</span>
                </span>
              </a>
            </div>
            {% endif %}

            {% if user %}
            {% if user_display is defined %}
            <span>{{ user_display(user) }}</span>
            {% else %}
            <span>{{ _display_name or '‚Äî' }}</span>
            {% endif %}

            <!-- pill de rol -->
            <span class="top-user-pill">
              {{ (r or '')|capitalize }}
            </span>

            {# Se quit√≥ el link "Cambiar contrase√±a" de la barra superior #}

            <!-- Toggle Dark Mode (Tech/Pill) -->


            {% else %}
            Invitado
            {% endif %}
          </div>
        </div>
      </header>

      <div id="flash-container" class="px-3 pt-3"></div>

      <div class="px-3">
        {% block notifications %}{% endblock %}
      </div>

      <div class="px-3 py-3">
        {% block content %}{% endblock %}
      </div>
    </main>
  </div>



  <!-- Contenedores de notificaciones -->
  <div id="banner-root" aria-live="polite" aria-atomic="true"></div>
  <div id="toast-root" aria-live="polite" aria-atomic="true"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Notify (UI de toasts/banners) -->
  <script src="{{ url_for('static', path='js/notify.js') }}" defer></script>

  <script>
    // ====== Usuario (expuesto a JS global + data-attrs en <html>) ======
    (function () {
      const APP_USER = {
        role: {{ ((user and(user.role or user.rol or ''))| lower)| tojson
    }},
    display: { { (_display_name or 'Yo')| tojson } },
    email: { { (user and user.email or '')| tojson } }
      };
    window.APP_USER = APP_USER;

    const rootEl = document.documentElement;
    if (!rootEl.dataset.userRole) rootEl.dataset.userRole = APP_USER.role || '';
    if (!rootEl.dataset.userDisplay) rootEl.dataset.userDisplay = APP_USER.display || 'Yo';

    const wc = document.getElementById('wc-comments-panel');
    if (wc) {
      if (!wc.dataset.userRole) wc.dataset.userRole = APP_USER.role || '';
      if (!wc.dataset.userDisplay) wc.dataset.userDisplay = APP_USER.display || 'Yo';
    }
    }) ();

    // ====== Buscador superior ‚Üí historial ======
    (function () {
      const form = document.getElementById('app-search-form');
      const input = document.getElementById('app-search-input');
      if (!form || !input) return;

      function go() {
        const q = (input.value || '').trim();
        const url = q ? `/cargas/historial?q=${encodeURIComponent(q)}` : '/cargas/historial';
        window.location.href = url;
      }

      form.addEventListener('submit', function (e) { e.preventDefault(); go(); });
      input.addEventListener('keydown', function (e) { if (e.key === 'Enter') { e.preventDefault(); go(); } });
    })();

    // ====== Badge "Mesa de ayuda" (abiertos) ======
    (function () {
      // ... (existing code if any, irrelevant here, just place at end of script block)
    })();

    // ====== CONFIRMACION MANUAL (si el onclick inline falla) ======
    document.addEventListener('click', function (e) {
      if (e.target && e.target.closest('.btn-delete-group')) {
        e.preventDefault();
        const btn = e.target.closest('.btn-delete-group');
        const name = btn.dataset.name || 'este grupo';
        if (confirm(`¬øEliminar el grupo ${name}? Esta acci√≥n no se puede deshacer.`)) {
          window.location.href = btn.href;
        }
      }
      if (e.target && e.target.closest('.btn-remove-member')) {
        e.preventDefault();
        const btn = e.target.closest('.btn-remove-member');
        const name = btn.dataset.name || 'este usuario';
        if (confirm(`¬øQuitar a ${name} del grupo?`)) {
          window.location.href = btn.href;
        }
      }
    });

    (function () {
      const badge = document.getElementById('cmMenuBadge');
      const link = document.getElementById('cmMenuLink');
      if (!badge || !link) return;

      async function refresh() {
        try {
          const r = await fetch('/api/comments/inbox?status=open&page=1&page_size=1', {
            headers: { 'accept': 'application/json' }
          });
          if (!r.ok) return;
          const data = await r.json();

          const open = (data && typeof data.total === 'number')
            ? data.total
            : (Array.isArray(data) ? data.length : 0);

          if (open > 0) {
            badge.textContent = String(open);
            badge.style.display = '';
          } else {
            badge.style.display = 'none';
          }
          link.title = `Mesa de ayuda ¬∑ Abiertos: ${open}`;
        } catch { }
      }

      refresh();
      setInterval(refresh, 60000);
    })();

    // ====== Badge "Notificaciones" (System) ======
    (function () {
      const badge = document.getElementById('nav-notif-badge');
      if (!badge) return;

      async function checkNotifs() {
        try {
          const r = await fetch('/notifications/unread-count');
          if (!r.ok) return;
          const data = await r.json();
          const count = data.count || 0;

          if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.style.display = '';
          } else {
            badge.style.display = 'none';
          }
        } catch (e) { console.error('Error checking notifications', e); }
      }

      checkNotifs();
      // Poll every 30 seconds
      setInterval(checkNotifs, 30000);
    })();

    // ====== Helper global: Enter = enviar / Shift+Enter = salto ======
    (function () {
      function bindEnterSubmit(textarea, form) {
        if (!textarea || !form || textarea.dataset._enterBound) return;
        textarea.addEventListener('keydown', function (e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            const txt = (textarea.value || '').trim();
            if (!txt) return;
            if (typeof form.requestSubmit === 'function') form.requestSubmit();
            else form.submit();
          }
        });
        textarea.dataset._enterBound = '1';
      }
      window.bindEnterSubmit = bindEnterSubmit;

      const ta = document.getElementById('cmReplyBody');
      const fm = document.getElementById('cmReplyForm');
      if (ta && fm) bindEnterSubmit(ta, fm);

      document.addEventListener('shown.bs.offcanvas', function () {
        const t = document.getElementById('cmReplyBody');
        const f = document.getElementById('cmReplyForm');
        if (t && f) bindEnterSubmit(t, f);
      });
    })();
  </script>

  {# ===== Feedback reset_ok / reset_err (toasts o alerts) ===== #}
  {% if reset_ok %}
  <script>
    window.addEventListener('DOMContentLoaded', function () {
      var msg = 'Se resetearon los procesos correctamente.';
      if (window.Notify && Notify.toastSuccess) {
        Notify.toastSuccess('Reset completado', msg);
      } else {
        var box = document.getElementById('flash-container');
        if (box) {
          box.innerHTML =
            '<div class="alert alert-success alert-dismissible fade show" role="alert">'
            + msg +
            '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button></div>';
        }
      }
    });
  </script>
  {% endif %}

  {% if reset_err %}
  {% set _reset_err_msg = reset_err if reset_err is string else 'No se pudo resetear los procesos. Verific√° la
  contrase√±a e intent√° nuevamente.' %}
  <script>
    window.addEventListener('DOMContentLoaded', function () {
      var msg = {{ _reset_err_msg| tojson
    }};
    if (window.Notify && Notify.toastError) {
      Notify.toastError('No se pudo resetear', msg);
    } else {
      var box = document.getElementById('flash-container');
      if (box) {
        box.innerHTML =
          '<div class="alert alert-danger alert-dismissible fade show" role="alert">'
          + msg +
          '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button></div>';
      }
    }
    });
  </script>
  {% endif %}

  {% block extra_js %}{% endblock %}
</body>

</html>