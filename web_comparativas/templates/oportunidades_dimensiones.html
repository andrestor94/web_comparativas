{% extends "base.html" %}
{% block title %}Dimensiones{% endblock %}

{% block extra_head %}
<style>
  .muted{color:#6b7280;font-size:14px}
  .muted.small{font-size:13px}

  .card{
    background:var(--sa-blanco,#fff);
    border:1px solid var(--sa-gris-borde,#e5e7eb);
    border-radius:14px;
    padding:16px 18px;
    box-shadow:0 1px 2px rgba(15,23,42,.04);
    overflow:visible;
  }

  /* Campos compactos (mismo estilo que Buscador) */
  .field input,
  .field select{
    width:100%;
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:3px 8px;
    background:#fff;
    font-size:12px;
    height:28px;
  }

  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{
    border:1px solid #cbd5f5;
    background:#ffffff;
    border-radius:999px;
    padding:6px 10px;
    font-size:12px;
    cursor:pointer;
    transition:background .15s ease,border-color .15s ease,box-shadow .15s ease;
  }
  .chip:hover{
    border-color:#94a3ff;
    box-shadow:0 0 0 1px rgba(82,116,206,.16);
  }
  .chip.is-on{
    background:#dbeafe;
    border-color:#5274ce;
    color:#1f3a8a;
    box-shadow:0 0 0 1px rgba(82,116,206,.28);
  }

  /* RECTÁNGULO BASE DE TODOS LOS FILTROS (igual estilo que Buscador) */
  .filter-card{
    background:#f3f6fc;
    border:1px solid #c7d2fe;
    border-radius:12px;
    padding:6px 10px;
    min-height:56px;
    box-shadow:0 1px 2px rgba(15,23,42,.04);
  }
  .filter-card h5{
    font-size:10px;
    margin:0 0 4px;
    color:#1f2937;
    text-transform:uppercase;
    letter-spacing:.04em;
  }

  .filter-card--compact{
    padding:6px 10px;
    min-height:52px;
    display:flex;
    flex-direction:column;
    justify-content:center;
    border-color:#b4c6fc;
  }
  .filter-card--compact .field{margin-top:0}
  .filter-card--compact .field select{
    height:26px;
    font-size:12px;
  }

  /* Filtro Fecha */
  .filter-card--date{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .filter-card--date .dates-row{
    display:flex;
    gap:6px;
  }
  .filter-card--date input[type="date"]{
    flex:1 1 0;
    min-width:0;
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:3px 8px;
    background:#fff;
    font-size:12px;
    height:30px;
  }
  .range-wrap{position:relative;height:20px;margin-top:2px}
  .range-wrap input[type=range]{
    position:absolute;
    left:0;right:0;
    top:2px;
    width:100%;
    pointer-events:none;
    background:transparent;
    -webkit-appearance:none;
  }
  .range-wrap input[type=range]::-webkit-slider-thumb{
    pointer-events:auto;
    -webkit-appearance:none;
    height:14px;width:14px;
    border-radius:50%;
    background:var(--sa-azul-btn,#5274ce);
    border:2px solid #fff;
    box-shadow:0 0 0 1px rgba(0,0,0,.08);
  }
  .range-wrap input[type=range]::-moz-range-thumb{
    pointer-events:auto;
    height:14px;width:14px;
    border:0;
    border-radius:50%;
    background:var(--sa-azul-btn,#5274ce);
  }
  .range-track{
    position:absolute;
    left:0;right:0;
    top:8px;
    height:3px;
    background:#e5e7eb;
    border-radius:999px;
  }
  .range-fill{
    position:absolute;
    top:8px;
    height:3px;
    background:#c7d2fe;
    border-radius:999px;
  }

  /* KPI principal */
  .kpi-main{
    background:#eef2ff;
    border:1px solid #c7d2fe;
    border-radius:12px;
    padding:10px 12px;
    display:flex;
    flex-direction:column;
    justify-content:center;
  }
  .kpi-main h4{
    margin:0 0 4px;
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.04em;
    color:#4b5563;
  }
  .kpi-main .v{
    font-weight:800;
    font-size:26px;
    color:var(--sa-text,#064066);
  }
  .kpi-main .sub{
    font-size:11px;
    color:#6b7280;
  }

  /* Layout del dashboard de Dimensiones */
  .dim-dashboard{
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  /* Fila superior: fecha + KPI + filtros */
  .dim-row-top{
    display:grid;
    grid-template-columns:1.3fr 0.7fr 1fr 1fr 1fr;
    gap:10px;
  }

  /* Fila de estado (EMERGENCIA / REGULAR) */
  .dim-row-state{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }

  /* Bloque de gráficos medio: timeline + mapa (barras por provincia) */
  .dim-row-middle{
    display:grid;
    grid-template-columns:2fr 1.1fr;
    gap:12px;
    align-items:stretch;
  }

  /* Bloque inferior: treemap (tipo) + barras + pie */
  .dim-row-bottom{
    display:grid;
    grid-template-columns:1.2fr 1.4fr 1.1fr;
    gap:12px;
  }

  .chart-card{
    background:#f9fafb;
    border-radius:14px;
    border:1px solid #e5e7eb;
    padding:10px 12px;
    display:flex;
    flex-direction:column;
    gap:8px;
    height:100%;
  }
  .chart-card h3{
    margin:0;
    font-size:13px;
    font-weight:600;
    color:#111827;
  }
  .chart-card small{
    font-size:11px;
    color:#6b7280;
  }
  .chart-body{
    flex:1 1 auto;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
  }
  .chart-placeholder{
    width:100%;
    height:100%;
    min-height:140px;
    border-radius:10px;
    border:1px dashed #d1d5db;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    color:#9ca3af;
    text-align:center;
    padding:8px;
  }

  .map-placeholder{
    width:100%;
    height:100%;
    min-height:180px;
    border-radius:10px;
    border:1px dashed #d1d5db;
    background:#e5f0ff;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    color:#1f2937;
    text-align:center;
    padding:8px;
  }

  canvas{
    width:100% !important;
    height:100% !important;
  }

  /* Responsive */
  @media (max-width:1200px){
    .dim-row-top{
      grid-template-columns:1fr 1fr;
    }
    .dim-row-middle{
      grid-template-columns:1fr;
    }
    .dim-row-bottom{
      grid-template-columns:1fr;
    }
  }

  @media (max-width:768px){
    .dim-row-top,
    .dim-row-state{
      grid-template-columns:1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-xxl py-4">
  <h1 class="mb-1">Dimensiones</h1>
  <p class="muted small mb-3">
    Panel de análisis de oportunidades por dimensión (tiempo, plataforma, repartición, estado, tipo y provincia).
  </p>

  <div class="card" style="border-color:#c7d2fe;">
    <div class="dim-dashboard">

      {# =========================
         FILA SUPERIOR
         ========================= #}
      <div class="dim-row-top" aria-label="Filtros principales y KPI" role="group">
        <!-- Fecha -->
        <div class="filter-card filter-card--date" aria-labelledby="lblDimFecha">
          <h5 id="lblDimFecha">Fecha de apertura</h5>
          <div class="dates-row">
            <input id="dimDateFrom" type="date" aria-label="Fecha desde">
            <input id="dimDateTo" type="date" aria-label="Fecha hasta">
          </div>
          <div class="range-wrap" aria-hidden="true">
            <div class="range-track"></div>
            <div class="range-fill" id="dimDateFill"></div>
            <input type="range" id="dimRangeMin" min="0" max="100" value="0" step="1">
            <input type="range" id="dimRangeMax" min="0" max="100" value="100" step="1">
          </div>
        </div>

        <!-- KPI Procesos -->
        <div class="kpi-main" role="status" aria-live="polite">
          <h4>Procesos</h4>
          <div class="v" id="dimKpiProcesos">0</div>
          <div class="sub">Cantidad de procesos en el rango seleccionado</div>
        </div>

        <!-- Plataforma -->
        <div class="filter-card filter-card--compact">
          <h5>Plataforma</h5>
          <div class="field">
            <select id="dimPlataforma" aria-label="Filtrar por plataforma">
              <option value="">Todas</option>
            </select>
          </div>
        </div>

        <!-- Cuenta -->
        <div class="filter-card filter-card--compact">
          <h5>Cuenta</h5>
          <div class="field">
            <select id="dimCuenta" aria-label="Filtrar por cuenta">
              <option value="">Todas</option>
            </select>
          </div>
        </div>

        <!-- Repartición -->
        <div class="filter-card filter-card--compact">
          <h5>Repartición</h5>
          <div class="field">
            <select id="dimReparticion" aria-label="Filtrar por repartición">
              <option value="">Todas</option>
            </select>
          </div>
        </div>
      </div>

      {# =========================
         FILA ESTADO (EMERGENCIA / REGULAR)
         ========================= #}
      <div class="dim-row-state">
        <div class="filter-card">
          <h5>Repartición: PAMI u otras</h5>
          <div class="chips" id="dimSwPAMI" role="group" aria-label="Filtro PAMI u otras">
            <button type="button" class="chip is-on" data-val="todos" aria-pressed="true">Todas</button>
            <button type="button" class="chip" data-val="pami" aria-pressed="false">PAMI</button>
            <button type="button" class="chip" data-val="otras" aria-pressed="false">Otras reparticiones</button>
          </div>
        </div>

        <div class="filter-card">
          <h5>Estado</h5>
          <div class="chips" id="dimSwEstado" role="group" aria-label="Filtro de estado">
            <button type="button" class="chip is-on" data-val="todos" aria-pressed="true">Todos</button>
            <button type="button" class="chip" data-val="emergencia" aria-pressed="false">EMERGENCIA</button>
            <button type="button" class="chip" data-val="regular" aria-pressed="false">REGULAR</button>
          </div>
        </div>
      </div>

      {# =========================
         FILA MEDIA: LÍNEA DE TIEMPO + PROVINCIA
         ========================= #}
      <div class="dim-row-middle">
        <!-- Apertura de procesos en el tiempo -->
        <section class="chart-card" aria-labelledby="dimTitleTimeline">
          <header>
            <h3 id="dimTitleTimeline">Apertura de procesos en el tiempo</h3>
            <small>Distribución diaria de aperturas según el período seleccionado.</small>
          </header>
          <div class="chart-body">
            <div class="chart-placeholder" id="phTimeline">
              Aquí se mostrará el gráfico de barras por día (timeline).
            </div>
            <canvas id="dimChartTimeline" aria-label="Timeline de aperturas" role="img"></canvas>
          </div>
        </section>

        <!-- Procesos por provincia (barras) -->
        <section class="chart-card" aria-labelledby="dimTitleMap">
          <header>
            <h3 id="dimTitleMap">Procesos por provincia</h3>
            <small>Distribución de procesos por provincia en el período seleccionado.</small>
          </header>
          <div class="chart-body">
            <div class="map-placeholder" id="phProvincia">
              Mapa de Argentina / barras por provincia<br>
              (aquí luego incorporamos el mapa interactivo).
            </div>
            <canvas id="dimChartProvincia" aria-label="Procesos por provincia" role="img"></canvas>
          </div>
        </section>
      </div>

      {# =========================
         FILA INFERIOR: TIPO + BARRAS + PIE
         ========================= #}
      <div class="dim-row-bottom">
        <!-- Procesos por tipo (usamos Plataforma como proxy de tipo) -->
        <section class="chart-card" aria-labelledby="dimTitleTreemap">
          <header>
            <h3 id="dimTitleTreemap">Procesos por tipo</h3>
            <small>Distribución de procesos según la plataforma / tipo de procedimiento.</small>
          </header>
          <div class="chart-body">
            <div class="chart-placeholder" id="phTipo">
              Aquí se mostrará el gráfico por tipo de proceso.
            </div>
            <canvas id="dimChartTipo" aria-label="Procesos por tipo" role="img"></canvas>
          </div>
        </section>

        <!-- Procesos por repartición y estado (barras) -->
        <section class="chart-card" aria-labelledby="dimTitleBars">
          <header>
            <h3 id="dimTitleBars">Proceso por repartición y estado</h3>
            <small>Cantidad de procesos por repartición segmentados por estado.</small>
          </header>
          <div class="chart-body">
            <div class="chart-placeholder" id="phBars">
              Aquí se mostrará el gráfico de barras por repartición y estado.
            </div>
            <canvas id="dimChartBars" aria-label="Procesos por repartición y estado" role="img"></canvas>
          </div>
        </section>

        <!-- Procesos por estado (pie) -->
        <section class="chart-card" aria-labelledby="dimTitlePie">
          <header>
            <h3 id="dimTitlePie">Proceso por repartición y estado</h3>
            <small>Participación relativa por estado (EMERGENCIA / REGULAR).</small>
          </header>
          <div class="chart-body">
            <div class="chart-placeholder" id="phPie">
              Aquí se mostrará el gráfico de torta de estados.
            </div>
            <canvas id="dimChartPie" aria-label="Procesos por estado" role="img"></canvas>
          </div>
        </section>
      </div>

    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){
  // ---------- ELEMENTOS BASE ----------
  const elDateFrom      = document.getElementById("dimDateFrom");
  const elDateTo        = document.getElementById("dimDateTo");
  const elRangeFill     = document.getElementById("dimDateFill");
  const elRangeMin      = document.getElementById("dimRangeMin");
  const elRangeMax      = document.getElementById("dimRangeMax");

  const elKpiProcesos   = document.getElementById("dimKpiProcesos");

  const elPlataforma    = document.getElementById("dimPlataforma");
  const elCuenta        = document.getElementById("dimCuenta");
  const elReparticion   = document.getElementById("dimReparticion");

  const chipsPamiGroup  = document.getElementById("dimSwPAMI");
  const chipsEstadoGroup= document.getElementById("dimSwEstado");

  // Placeholders y canvases
  const phTimeline    = document.getElementById("phTimeline");
  const phProvincia   = document.getElementById("phProvincia");
  const phTipo        = document.getElementById("phTipo");
  const phBars        = document.getElementById("phBars");
  const phPie         = document.getElementById("phPie");

  const cvTimeline    = document.getElementById("dimChartTimeline");
  const cvProvincia   = document.getElementById("dimChartProvincia");
  const cvTipo        = document.getElementById("dimChartTipo");
  const cvBars        = document.getElementById("dimChartBars");
  const cvPie         = document.getElementById("dimChartPie");

  const state = {
    allRows: []  // datos crudos que vienen de /api/oportunidades/buscador
  };

  const fmtInt = new Intl.NumberFormat("es-AR");

  function formatInt(n){
    if (!Number.isFinite(n)) return "0";
    return fmtInt.format(n);
  }

  // ---------- FECHAS: 72 HS HÁBILES POR DEFECTO ----------
  function getLastBusinessDaysRange(nDays){
    const today = new Date();
    const end = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    let date = new Date(end);
    const collected = [];

    while(collected.length < nDays){
      const day = date.getDay(); // 0 dom, 6 sáb
      if(day !== 0 && day !== 6){
        collected.push(new Date(date));
      }
      date.setDate(date.getDate() - 1);
    }

    const from = collected[collected.length - 1];
    return { from, to: end };
  }

  function ensureDefaultDates(){
    if(!elDateFrom.value && !elDateTo.value){
      const range = getLastBusinessDaysRange(3); // 3 días hábiles ~ 72 hs
      const toISO   = d => d.toISOString().slice(0,10);

      elDateFrom.value = toISO(range.from);
      elDateTo.value   = toISO(range.to);
    }
  }

  // Slider visual simple
  function refreshRangeFill(){
    if(!elRangeFill) return;
    const minVal = Number(elRangeMin.value || 0);
    const maxVal = Number(elRangeMax.value || 100);
    const low = Math.min(minVal, maxVal);
    const high = Math.max(minVal, maxVal);
    elRangeFill.style.left  = low + "%";
    elRangeFill.style.width = (high - low) + "%";
  }

  // ---------- SELECTS DESDE DATOS ----------
  function populateSelectOptions(selectEl, values){
    if(!selectEl) return;
    const current = selectEl.value;
    while(selectEl.options.length > 1){
      selectEl.remove(1);
    }
    const arr = Array.from(values).filter(v => v && v.toString().trim() !== "");
    arr.sort((a,b)=> a.localeCompare(b, "es", {sensitivity:"base"}));
    for(const v of arr){
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      selectEl.appendChild(opt);
    }
    if(current && Array.from(selectEl.options).some(o => o.value === current)){
      selectEl.value = current;
    }
  }

  function buildFiltersFromRows(){
    const plats = new Set();
    const reps  = new Set();
    // Cuenta queda reservada para futuro
    for(const row of state.allRows){
      if(row.plataforma) plats.add(row.plataforma);
      if(row.comprador)  reps.add(row.comprador);
    }
    populateSelectOptions(elPlataforma, plats);
    populateSelectOptions(elReparticion, reps);
  }

  // ---------- ESTADO EMERGENCIA / REGULAR ----------
  function computeEstado(row){
    const desc = (row.descripcion || "").toString().toLowerCase();
    if(desc.includes("emergencia")) return "EMERGENCIA";
    return "REGULAR";
  }

  // ---------- PARSE DE FECHA DEVUELTA POR LA API (dd/mm/yyyy) ----------
  function parseApiDate(str){
    if(!str) return null;
    const t = String(str).trim();
    if(!t) return null;
    const parts = t.split("/");
    if(parts.length === 3){
      const d = parseInt(parts[0],10);
      const m = parseInt(parts[1],10) - 1;
      const y = parseInt(parts[2],10);
      if(!isNaN(d) && !isNaN(m) && !isNaN(y)){
        return new Date(y,m,d);
      }
    }
    const d2 = new Date(t);
    return isNaN(d2.getTime()) ? null : d2;
  }

  // ---------- CHART.JS INSTANCIAS ----------
  let chartTimeline = null;
  let chartProvincia = null;
  let chartTipo = null;
  let chartBars = null;
  let chartPie = null;

  function ensureChart(ctx, type, baseConfig, currentInstanceHolder){
    if(!window.Chart || !ctx) return null;
    if(currentInstanceHolder){
      currentInstanceHolder.data = baseConfig.data;
      currentInstanceHolder.options = baseConfig.options || {};
      currentInstanceHolder.update();
      return currentInstanceHolder;
    }
    return new Chart(ctx, {
      type: type,
      data: baseConfig.data,
      options: baseConfig.options || {}
    });
  }

  function togglePlaceholder(phEl, hasData){
    if(!phEl) return;
    phEl.style.display = hasData ? "none" : "flex";
  }

  // ---------- ACTUALIZAR GRÁFICOS ----------
  function updateCharts(rows){
    const hasData = rows && rows.length > 0;
    // Placeholders generales
    togglePlaceholder(phTimeline,  hasData);
    togglePlaceholder(phProvincia, hasData);
    togglePlaceholder(phTipo,      hasData);
    togglePlaceholder(phBars,      hasData);
    togglePlaceholder(phPie,       hasData);

    if(!hasData || !window.Chart){
      // Si no hay datos o no está Chart, destruimos si existían
      return;
    }

    // --- Timeline por fecha ---
    const byDate = new Map();
    for(const r of rows){
      const f = (r.fecha || "").toString().trim();
      if(!f) continue;
      byDate.set(f, (byDate.get(f) || 0) + 1);
    }
    const dateLabels = Array.from(byDate.keys())
      .sort((a,b)=>{
        const da = parseApiDate(a) || new Date(0);
        const db = parseApiDate(b) || new Date(0);
        return da - db;
      });
    const dateCounts = dateLabels.map(d=>byDate.get(d) || 0);

    if(cvTimeline){
      const ctxT = cvTimeline.getContext("2d");
      chartTimeline = ensureChart(ctxT, "bar", {
        data: {
          labels: dateLabels,
          datasets: [{
            label: "Procesos",
            data: dateCounts
          }]
        },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          scales:{
            x:{ticks:{autoSkip:true,maxTicksLimit:8}},
            y:{beginAtZero:true}
          },
          plugins:{
            legend:{display:false}
          }
        }
      }, chartTimeline);
    }

    // --- Procesos por provincia ---
    const byProv = new Map();
    for(const r of rows){
      const p = (r.provincia || "Sin provincia").toString().trim() || "Sin provincia";
      byProv.set(p, (byProv.get(p) || 0) + 1);
    }
    let provEntries = Array.from(byProv.entries())
      .sort((a,b)=>b[1] - a[1]);
    // Top 10 + "Otras"
    if(provEntries.length > 10){
      const top = provEntries.slice(0,10);
      const rest = provEntries.slice(10);
      const otrasCount = rest.reduce((acc,[,v])=>acc+v,0);
      top.push(["Otras", otrasCount]);
      provEntries = top;
    }
    const provLabels = provEntries.map(([k])=>k);
    const provCounts = provEntries.map(([,v])=>v);

    if(cvProvincia){
      const ctxP = cvProvincia.getContext("2d");
      chartProvincia = ensureChart(ctxP, "bar", {
        data:{
          labels: provLabels,
          datasets:[{
            label:"Procesos",
            data: provCounts
          }]
        },
        options:{
          indexAxis:"y",
          responsive:true,
          maintainAspectRatio:false,
          scales:{
            x:{beginAtZero:true}
          },
          plugins:{legend:{display:false}}
        }
      }, chartProvincia);
    }

    // --- Procesos por tipo (plataforma como proxy) ---
    const byPlat = new Map();
    for(const r of rows){
      const p = (r.plataforma || "Sin plataforma").toString().trim() || "Sin plataforma";
      byPlat.set(p, (byPlat.get(p) || 0) + 1);
    }
    let platEntries = Array.from(byPlat.entries())
      .sort((a,b)=>b[1]-a[1]);
    if(platEntries.length > 12){
      const top = platEntries.slice(0,12);
      const rest = platEntries.slice(12);
      const otras = rest.reduce((acc,[,v])=>acc+v,0);
      top.push(["Otras", otras]);
      platEntries = top;
    }
    const platLabels = platEntries.map(([k])=>k);
    const platCounts = platEntries.map(([,v])=>v);

    if(cvTipo){
      const ctxTipo = cvTipo.getContext("2d");
      chartTipo = ensureChart(ctxTipo, "bar", {
        data:{
          labels: platLabels,
          datasets:[{
            label:"Procesos",
            data: platCounts
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          scales:{y:{beginAtZero:true}},
          plugins:{legend:{display:false}}
        }
      }, chartTipo);
    }

    // --- Barras por repartición y estado ---
    const byRepState = new Map(); // key: comprador, value: {EMERGENCIA:x, REGULAR:y}
    for(const r of rows){
      const rep = (r.comprador || "Sin repartición").toString().trim() || "Sin repartición";
      const est = r._estado || computeEstado(r);
      if(!byRepState.has(rep)){
        byRepState.set(rep, {EMERGENCIA:0, REGULAR:0});
      }
      const bucket = byRepState.get(rep);
      if(est === "EMERGENCIA") bucket.EMERGENCIA += 1;
      else bucket.REGULAR += 1;
    }
    let repEntries = Array.from(byRepState.entries())
      .sort((a,b)=>{
        const at = a[1].EMERGENCIA + a[1].REGULAR;
        const bt = b[1].EMERGENCIA + b[1].REGULAR;
        return bt - at;
      });
    if(repEntries.length > 10){
      repEntries = repEntries.slice(0,10);
    }
    const repLabels = repEntries.map(([k])=>k);
    const repEmerg = repEntries.map(([,v])=>v.EMERGENCIA);
    const repReg   = repEntries.map(([,v])=>v.REGULAR);

    if(cvBars){
      const ctxBars = cvBars.getContext("2d");
      chartBars = ensureChart(ctxBars, "bar", {
        data:{
          labels: repLabels,
          datasets:[
            {
              label:"EMERGENCIA",
              data:repEmerg
            },
            {
              label:"REGULAR",
              data:repReg
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          scales:{
            x:{stacked:true},
            y:{stacked:true,beginAtZero:true}
          }
        }
      }, chartBars);
    }

    // --- Pie por estado global ---
    let totalEmerg = 0;
    let totalReg   = 0;
    for(const r of rows){
      const est = r._estado || computeEstado(r);
      if(est === "EMERGENCIA") totalEmerg++;
      else totalReg++;
    }

    if(cvPie){
      const ctxPie = cvPie.getContext("2d");
      chartPie = ensureChart(ctxPie, "pie", {
        data:{
          labels:["EMERGENCIA","REGULAR"],
          datasets:[{
            data:[totalEmerg, totalReg]
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false
        }
      }, chartPie);
    }
  }

  // ---------- APLICAR FILTROS UI SOBRE state.allRows ----------
  function applyUiFilters(){
    let rows = state.allRows.slice();

    const selPlataforma  = elPlataforma ? elPlataforma.value : "";
    const selCuenta      = elCuenta ? elCuenta.value : "";
    const selReparticion = elReparticion ? elReparticion.value : "";

    const chipPami = chipsPamiGroup
      ? chipsPamiGroup.querySelector(".chip.is-on")
      : null;
    const modePami = chipPami ? chipPami.dataset.val : "todos";

    const chipEstado = chipsEstadoGroup
      ? chipsEstadoGroup.querySelector(".chip.is-on")
      : null;
    const modeEstado = chipEstado ? chipEstado.dataset.val : "todos";

    let fromDate = null;
    let toDate = null;
    if(elDateFrom && elDateFrom.value){
      fromDate = new Date(elDateFrom.value); // yyyy-mm-dd
    }
    if(elDateTo && elDateTo.value){
      toDate = new Date(elDateTo.value);
      // incluímos todo el día
      toDate = new Date(toDate.getFullYear(), toDate.getMonth(), toDate.getDate(), 23,59,59,999);
    }

    rows = rows.filter(r => {
      const comprador = (r.comprador || "").toString();
      const compradorUpper = comprador.toUpperCase();
      const plataforma = (r.plataforma || "").toString();

      // Filtro por fechas (cliente)
      if(fromDate || toDate){
        const d = parseApiDate(r.fecha);
        if(!d) return false;
        if(fromDate && d < fromDate) return false;
        if(toDate && d > toDate) return false;
      }

      // Plataforma
      if(selPlataforma && plataforma !== selPlataforma) return false;

      // Cuenta (placeholder futuro)
      if(selCuenta && selCuenta !== ""){
        // TODO: cuando tengamos el campo en el API
      }

      // Repartición por select
      if(selReparticion && comprador !== selReparticion) return false;

      // PAMI / Otras
      if(modePami === "pami" && !compradorUpper.includes("PAMI")) return false;
      if(modePami === "otras" && compradorUpper.includes("PAMI")) return false;

      // Estado: EMERGENCIA / REGULAR
      const est = r._estado || computeEstado(r);
      if(modeEstado === "emergencia" && est !== "EMERGENCIA") return false;
      if(modeEstado === "regular" && est !== "REGULAR") return false;

      return true;
    });

    // KPI principal
    if(elKpiProcesos){
      elKpiProcesos.textContent = formatInt(rows.length);
    }

    // Actualizar gráficos con estos rows filtrados
    updateCharts(rows);
  }

  // ---------- CARGAR DATOS DESDE /api/oportunidades/buscador ----------
  async function loadData(){
    ensureDefaultDates();

    const params = new URLSearchParams();
    // No filtramos por fecha en el servidor: traemos todo y filtramos en cliente
    params.set("page_size", "5000");

    const url = "/api/oportunidades/buscador?" + params.toString();

    try{
      const resp = await fetch(url);
      if(!resp.ok){
        console.error("Dimensiones: error HTTP", resp.status);
        state.allRows = [];
        applyUiFilters();
        refreshRangeFill();
        return;
      }
      const data = await resp.json();
      if(!data || data.ok === false){
        console.warn("Dimensiones: respuesta sin datos válidos", data);
        state.allRows = [];
      } else {
        state.allRows = Array.isArray(data.rows) ? data.rows : [];
      }

      // Pre-calculamos un "estado" aproximado por fila
      state.allRows.forEach(r => {
        r._estado = computeEstado(r);
      });

      // Construimos opciones de filtros a partir de los datos
      buildFiltersFromRows();

      // Actualizamos KPI y gráficos
      applyUiFilters();

      // Refrescamos la barrita del rango (visual)
      refreshRangeFill();
    } catch(err){
      console.error("Dimensiones: error al cargar datos", err);
      state.allRows = [];
      applyUiFilters();
      refreshRangeFill();
    }
  }

  // ---------- LISTENERS DE UI ----------
  if(chipsPamiGroup){
    chipsPamiGroup.querySelectorAll(".chip").forEach(btn => {
      btn.addEventListener("click", () => {
        chipsPamiGroup.querySelectorAll(".chip").forEach(c => {
          c.classList.remove("is-on");
          c.setAttribute("aria-pressed","false");
        });
        btn.classList.add("is-on");
        btn.setAttribute("aria-pressed","true");
        applyUiFilters();
      });
    });
  }

  if(chipsEstadoGroup){
    chipsEstadoGroup.querySelectorAll(".chip").forEach(btn => {
      btn.addEventListener("click", () => {
        chipsEstadoGroup.querySelectorAll(".chip").forEach(c => {
          c.classList.remove("is-on");
          c.setAttribute("aria-pressed","false");
        });
        btn.classList.add("is-on");
        btn.setAttribute("aria-pressed","true");
        applyUiFilters();
      });
    });
  }

  if(elPlataforma){
    elPlataforma.addEventListener("change", () => {
      applyUiFilters();
    });
  }
  if(elCuenta){
    elCuenta.addEventListener("change", () => {
      applyUiFilters();
    });
  }
  if(elReparticion){
    elReparticion.addEventListener("change", () => {
      applyUiFilters();
    });
  }

  if(elDateFrom){
    elDateFrom.addEventListener("change", () => applyUiFilters());
  }
  if(elDateTo){
    elDateTo.addEventListener("change", () => applyUiFilters());
  }

  if(elRangeMin){
    elRangeMin.addEventListener("input", refreshRangeFill);
  }
  if(elRangeMax){
    elRangeMax.addEventListener("input", refreshRangeFill);
  }

  // ---------- INIT ----------
  ensureDefaultDates();
  refreshRangeFill();
  loadData();
});
</script>
{% endblock %}
