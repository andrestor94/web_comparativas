{% extends "base.html" %}
{% block title %}Dimensiones{% endblock %}

{% block extra_head %}
<style>
  .muted{color:#6b7280;font-size:14px}
  .muted.small{font-size:13px}

  .card{
    background:var(--sa-blanco,#fff);
    border:1px solid var(--sa-gris-borde,#e5e7eb);
    border-radius:14px;
    padding:16px 18px;
    box-shadow:0 1px 2px rgba(15,23,42,.04);
    overflow:visible;
  }

  /* Campos compactos (mismo estilo que Buscador) */
  .field input,
  .field select{
    width:100%;
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:3px 8px;
    background:#fff;
    font-size:12px;
    height:28px;
  }

  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{
    border:1px solid #cbd5f5;
    background:#ffffff;
    border-radius:999px;
    padding:6px 10px;
    font-size:12px;
    cursor:pointer;
    transition:background .15s ease,border-color .15s ease,box-shadow .15s ease;
  }
  .chip:hover{
    border-color:#94a3ff;
    box-shadow:0 0 0 1px rgba(82,116,206,.16);
  }
  .chip.is-on{
    background:#dbeafe;
    border-color:#5274ce;
    color:#1f3a8a;
    box-shadow:0 0 0 1px rgba(82,116,206,.28);
  }

  /* RECTÁNGULO BASE DE TODOS LOS FILTROS (igual estilo que Buscador) */
  .filter-card{
    background:#f3f6fc;
    border:1px solid #c7d2fe;
    border-radius:12px;
    padding:6px 10px;
    min-height:56px;
    box-shadow:0 1px 2px rgba(15,23,42,.04);
  }
  .filter-card h5{
    font-size:10px;
    margin:0 0 4px;
    color:#1f2937;
    text-transform:uppercase;
    letter-spacing:.04em;
  }

  .filter-card--compact{
    padding:6px 10px;
    min-height:52px;
    display:flex;
    flex-direction:column;
    justify-content:center;
    border-color:#b4c6fc;
  }
  .filter-card--compact .field{margin-top:0}
  .filter-card--compact .field select{
    height:26px;
    font-size:12px;
  }

  /* Filtro Fecha */
  .filter-card--date{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .filter-card--date .dates-row{
    display:flex;
    gap:6px;
  }
  .filter-card--date input[type="date"]{
    flex:1 1 0;
    min-width:0;
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:3px 8px;
    background:#fff;
    font-size:12px;
    height:30px;
  }
  .range-wrap{position:relative;height:20px;margin-top:2px}
  .range-wrap input[type=range]{
    position:absolute;
    left:0;right:0;
    top:2px;
    width:100%;
    pointer-events:none;
    background:transparent;
    -webkit-appearance:none;
  }
  .range-wrap input[type=range]::-webkit-slider-thumb{
    pointer-events:auto;
    -webkit-appearance:none;
    height:14px;width:14px;
    border-radius:50%;
    background:var(--sa-azul-btn,#5274ce);
    border:2px solid #fff;
    box-shadow:0 0 0 1px rgba(0,0,0,.08);
  }
  .range-wrap input[type=range]::-moz-range-thumb{
    pointer-events:auto;
    height:14px;width:14px;
    border:0;
    border-radius:50%;
    background:var(--sa-azul-btn,#5274ce);
  }
  .range-track{
    position:absolute;
    left:0;right:0;
    top:8px;
    height:3px;
    background:#e5e7eb;
    border-radius:999px;
  }
  .range-fill{
    position:absolute;
    top:8px;
    height:3px;
    background:#c7d2fe;
    border-radius:999px;
  }

  /* KPI principal */
  .kpi-main{
    background:#eef2ff;
    border:1px solid #c7d2fe;
    border-radius:12px;
    padding:10px 12px;
    display:flex;
    flex-direction:column;
    justify-content:center;
  }
  .kpi-main h4{
    margin:0 0 4px;
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.04em;
    color:#4b5563;
  }
  .kpi-main .v{
    font-weight:800;
    font-size:26px;
    color:var(--sa-text,#064066);
  }
  .kpi-main .sub{
    font-size:11px;
    color:#6b7280;
  }

  /* Layout del dashboard de Dimensiones */
  .dim-dashboard{
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  /* Fila superior: fecha + KPI + filtros */
  .dim-row-top{
    display:grid;
    grid-template-columns:1.3fr 0.7fr 1fr 1fr 1fr;
    gap:10px;
  }

  /* Fila de estado (PAMI / OTRAS + ESTADO) */
  .dim-row-state{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }

  /* Bloque de gráficos medio: timeline + mapa */
  .dim-row-middle{
    display:grid;
    grid-template-columns:2fr 1.1fr;
    gap:12px;
    align-items:stretch;
  }

  /* Bloque inferior: treemap + barras + pie */
  .dim-row-bottom{
    display:grid;
    grid-template-columns:1.2fr 1.4fr 1.1fr;
    gap:12px;
  }

  .chart-card{
    background:#f9fafb;
    border-radius:14px;
    border:1px solid #e5e7eb;
    padding:10px 12px;
    display:flex;
    flex-direction:column;
    gap:8px;
    height:100%;
  }
  .chart-card h3{
    margin:0;
    font-size:13px;
    font-weight:600;
    color:#111827;
  }
  .chart-card small{
    font-size:11px;
    color:#6b7280;
  }
  .chart-body{
    flex:1 1 auto;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
  }
  .chart-placeholder{
    width:100%;
    height:100%;
    min-height:140px;
    border-radius:10px;
    border:1px dashed #d1d5db;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    color:#9ca3af;
    text-align:center;
    padding:8px;
  }

  .map-placeholder{
    width:100%;
    height:100%;
    min-height:180px;
    border-radius:10px;
    border:1px dashed #d1d5db;
    background:#e5f0ff;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    color:#1f2937;
    text-align:center;
    padding:8px;
  }

  /* Por ahora ocultamos los placeholders para que no se superpongan con los charts */
  .chart-placeholder,
  .map-placeholder{
    display:none;
  }

  /* Responsive */
  @media (max-width:1200px){
    .dim-row-top{
      grid-template-columns:1fr 1fr;
    }
    .dim-row-middle{
      grid-template-columns:1fr;
    }
    .dim-row-bottom{
      grid-template-columns:1fr;
    }
  }

  @media (max-width:768px){
    .dim-row-top,
    .dim-row-state{
      grid-template-columns:1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-xxl py-4">
  <h1 class="mb-1">Dimensiones</h1>
  <p class="muted small mb-3">
    Panel de análisis de oportunidades por dimensión (tiempo, plataforma, repartición, estado, tipo y provincia).
  </p>

  <div class="card" style="border-color:#c7d2fe;">
    <div class="dim-dashboard">

      {# =========================
         FILA SUPERIOR
         ========================= #}
      <div class="dim-row-top" aria-label="Filtros principales y KPI" role="group">
        <!-- Fecha -->
        <div class="filter-card filter-card--date" aria-labelledby="lblDimFecha">
          <h5 id="lblDimFecha">Fecha de apertura</h5>
          <div class="dates-row">
            <input id="dimDateFrom" type="date" aria-label="Fecha desde">
            <input id="dimDateTo" type="date" aria-label="Fecha hasta">
          </div>
          <div class="range-wrap" aria-hidden="true">
            <div class="range-track"></div>
            <div class="range-fill" id="dimDateFill"></div>
            <input type="range" id="dimRangeMin" min="0" max="100" value="0" step="1">
            <input type="range" id="dimRangeMax" min="0" max="100" value="100" step="1">
          </div>
        </div>

        <!-- KPI Procesos -->
        <div class="kpi-main" role="status" aria-live="polite">
          <h4>Procesos</h4>
          <div class="v" id="dimKpiProcesos">0</div>
          <div class="sub">Cantidad de procesos en el rango seleccionado</div>
        </div>

        <!-- Plataforma -->
        <div class="filter-card filter-card--compact">
          <h5>Plataforma</h5>
          <div class="field">
            <select id="dimPlataforma" aria-label="Filtrar por plataforma">
              <option value="">Todas</option>
            </select>
          </div>
        </div>

        <!-- Cuenta -->
        <div class="filter-card filter-card--compact">
          <h5>Cuenta</h5>
          <div class="field">
            <select id="dimCuenta" aria-label="Filtrar por cuenta">
              <option value="">Todas</option>
            </select>
          </div>
        </div>

        <!-- Repartición -->
        <div class="filter-card filter-card--compact">
          <h5>Repartición</h5>
          <div class="field">
            <select id="dimReparticion" aria-label="Filtrar por repartición">
              <option value="">Todas</option>
            </select>
          </div>
        </div>
      </div>

      {# =========================
         FILA ESTADO (PAMI / OTRAS + ESTADO)
         ========================= #}
      <div class="dim-row-state">
        <div class="filter-card">
          <h5>Repartición: PAMI u otras</h5>
          <div class="chips" id="swPAMI" role="group" aria-label="Filtro PAMI u otras">
            <button type="button" class="chip is-on" data-val="todos" aria-pressed="true">Todas</button>
            <button type="button" class="chip" data-val="pami" aria-pressed="false">PAMI</button>
            <button type="button" class="chip" data-val="otras" aria-pressed="false">Otras reparticiones</button>
          </div>
        </div>

        <div class="filter-card">
          <h5>Estado</h5>
          <div class="chips" id="swEstado" role="group" aria-label="Filtro de estado">
            <button type="button" class="chip is-on" data-val="todos" aria-pressed="true">Todos</button>
            <button type="button" class="chip" data-val="emergencia" aria-pressed="false">EMERGENCIA</button>
            <button type="button" class="chip" data-val="regular" aria-pressed="false">REGULAR</button>
          </div>
        </div>
      </div>

      {# =========================
         FILA MEDIA: LÍNEA DE TIEMPO + MAPA
         ========================= #}
      <div class="dim-row-middle">
        <!-- Apertura de procesos en el tiempo -->
        <section class="chart-card" aria-labelledby="dimTitleTimeline">
          <header>
            <h3 id="dimTitleTimeline">Apertura de procesos en el tiempo</h3>
            <small>Distribución diaria de aperturas según el período seleccionado.</small>
          </header>
          <div class="chart-body">
            <div class="chart-placeholder" id="dimTimelinePlaceholder">
              Aquí se mostrará el gráfico de barras por día (timeline).
            </div>
            <canvas id="dimChartTimeline"></canvas>
          </div>
        </section>

        <!-- Procesos por provincia -->
        <section class="chart-card" aria-labelledby="dimTitleMap">
          <header>
            <h3 id="dimTitleMap">Procesos por provincia</h3>
            <small>Distribución de procesos según provincia.</small>
          </header>
          <div class="chart-body">
            <div class="map-placeholder" id="dimMapPlaceholder">
              Aquí se mostrará el gráfico por provincia.
            </div>
            <canvas id="dimChartProvincia"></canvas>
          </div>
        </section>
      </div>

      {# =========================
         FILA INFERIOR: TREEMAP + BARRAS + PIE
         ========================= #}
      <div class="dim-row-bottom">
        <!-- Procesos por tipo -->
        <section class="chart-card" aria-labelledby="dimTitleTreemap">
          <header>
            <h3 id="dimTitleTreemap">Procesos por tipo</h3>
            <small>Distribución de procesos según el tipo de procedimiento.</small>
          </header>
          <div class="chart-body">
            <div class="chart-placeholder" id="dimTiposPlaceholder">
              Aquí se mostrará el gráfico de procesos por tipo.
            </div>
            <canvas id="dimChartTipo"></canvas>
          </div>
        </section>

        <!-- Proceso por repartición y estado (barras stacked horizontales) -->
        <section class="chart-card" aria-labelledby="dimTitleBars">
          <header>
            <h3 id="dimTitleBars">Proceso por repartición y estado</h3>
            <small>Cantidad de procesos por repartición segmentados por estado.</small>
          </header>
          <div class="chart-body">
            <div class="chart-placeholder" id="dimBarsPlaceholder">
              Aquí se mostrará el gráfico de barras por repartición y estado.
            </div>
            <canvas id="dimChartRepEstado"></canvas>
          </div>
        </section>

        <!-- Proceso por repartición y estado (pie EMERGENCIA / REGULAR) -->
        <section class="chart-card" aria-labelledby="dimTitlePie">
          <header>
            <h3 id="dimTitlePie">Proceso por repartición y estado</h3>
            <small>Participación relativa por estado (EMERGENCIA / REGULAR).</small>
          </header>
          <div class="chart-body">
            <div class="chart-placeholder" id="dimPiePlaceholder">
              Aquí se mostrará el gráfico de torta de estados.
            </div>
            <canvas id="dimChartEstadoPie"></canvas>
          </div>
        </section>
      </div>

    </div>
  </div>
</div>

{# IMPORTANTÍSIMO: usamos el JS externo que ya tienes preparado #}
<script src="{{ url_for('static', path='oportunidades_dimensiones.js') }}"></script>
{% endblock %}
