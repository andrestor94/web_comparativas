{% extends "base.html" %}
{% block title %}Dimensiones{% endblock %}

{% block extra_head %}
<style>
  .muted{color:#6b7280;font-size:14px}
  .muted.small{font-size:13px}

  .card{
    background:var(--sa-blanco,#fff);
    border:1px solid var(--sa-gris-borde,#e5e7eb);
    border-radius:14px;
    padding:16px 18px;
    box-shadow:0 1px 2px rgba(15,23,42,.04);
    overflow:visible;
  }

  /* Campos compactos (mismo estilo que Buscador) */
  .field input,
  .field select{
    width:100%;
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:3px 8px;
    background:#fff;
    font-size:12px;
    height:28px;
  }

  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{
    border:1px solid #cbd5f5;
    background:#ffffff;
    border-radius:999px;
    padding:6px 10px;
    font-size:12px;
    cursor:pointer;
    transition:background .15s ease,border-color .15s ease,box-shadow .15s ease;
  }
  .chip:hover{
    border-color:#94a3ff;
    box-shadow:0 0 0 1px rgba(82,116,206,.16);
  }
  .chip.is-on{
    background:#dbeafe;
    border-color:#5274ce;
    color:#1f3a8a;
    box-shadow:0 0 0 1px rgba(82,116,206,.28);
  }

  /* RECTÁNGULO BASE DE TODOS LOS FILTROS (igual estilo que Buscador) */
  .filter-card{
    background:#f3f6fc;
    border:1px solid #c7d2fe;
    border-radius:12px;
    padding:6px 10px;
    min-height:56px;
    box-shadow:0 1px 2px rgba(15,23,42,.04);
  }
  .filter-card h5{
    font-size:10px;
    margin:0 0 4px;
    color:#1f2937;
    text-transform:uppercase;
    letter-spacing:.04em;
  }

  .filter-card--compact{
    padding:6px 10px;
    min-height:52px;
    display:flex;
    flex-direction:column;
    justify-content:center;
    border-color:#b4c6fc;
  }
  .filter-card--compact .field{margin-top:0}
  .filter-card--compact .field select{
    height:26px;
    font-size:12px;
  }

  /* Filtro Fecha */
  .filter-card--date{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .filter-card--date .dates-row{
    display:flex;
    gap:6px;
  }
  .filter-card--date input[type="date"]{
    flex:1 1 0;
    min-width:0;
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:3px 8px;
    background:#fff;
    font-size:12px;
    height:30px;
  }
  .range-wrap{position:relative;height:20px;margin-top:2px}
  .range-wrap input[type=range]{
    position:absolute;
    left:0;right:0;
    top:2px;
    width:100%;
    pointer-events:none;
    background:transparent;
    -webkit-appearance:none;
  }
  .range-wrap input[type=range]::-webkit-slider-thumb{
    pointer-events:auto;
    -webkit-appearance:none;
    height:14px;width:14px;
    border-radius:50%;
    background:var(--sa-azul-btn,#5274ce);
    border:2px solid #fff;
    box-shadow:0 0 0 1px rgba(0,0,0,.08);
  }
  .range-wrap input[type=range]::-moz-range-thumb{
    pointer-events:auto;
    height:14px;width:14px;
    border:0;
    border-radius:50%;
    background:var(--sa-azul-btn,#5274ce);
  }
  .range-track{
    position:absolute;
    left:0;right:0;
    top:8px;
    height:3px;
    background:#e5e7eb;
    border-radius:999px;
  }
  .range-fill{
    position:absolute;
    top:8px;
    height:3px;
    background:#c7d2fe;
    border-radius:999px;
  }

  /* KPI principal */
  .kpi-main{
    background:#eef2ff;
    border:1px solid #c7d2fe;
    border-radius:12px;
    padding:10px 12px;
    display:flex;
    flex-direction:column;
    justify-content:center;
  }
  .kpi-main h4{
    margin:0 0 4px;
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.04em;
    color:#4b5563;
  }
  .kpi-main .v{
    font-weight:800;
    font-size:26px;
    color:var(--sa-text,#064066);
  }
  .kpi-main .sub{
    font-size:11px;
    color:#6b7280;
  }

  /* Layout del dashboard de Dimensiones */
  .dim-dashboard{
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  /* Fila superior: fecha + KPI + filtros */
  .dim-row-top{
    display:grid;
    grid-template-columns:1.3fr 0.7fr 1fr 1fr 1fr;
    gap:10px;
  }

  /* Fila de estado (EMERGENCIA / REGULAR) */
  .dim-row-state{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }

  /* Bloque de gráficos medio: timeline + mapa */
  .dim-row-middle{
    display:grid;
    grid-template-columns:2fr 1.1fr;
    gap:12px;
    align-items:stretch;
  }

  /* Bloque inferior: treemap + barras + pie */
  .dim-row-bottom{
    display:grid;
    grid-template-columns:1.2fr 1.4fr 1.1fr;
    gap:12px;
  }

  .chart-card{
    background:#f9fafb;
    border-radius:14px;
    border:1px solid #e5e7eb;
    padding:10px 12px;
    display:flex;
    flex-direction:column;
    gap:8px;
    height:100%;
  }
  .chart-card h3{
    margin:0;
    font-size:13px;
    font-weight:600;
    color:#111827;
  }
  .chart-card small{
    font-size:11px;
    color:#6b7280;
  }
  .chart-body{
    flex:1 1 auto;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
  }
  .chart-placeholder{
    width:100%;
    height:100%;
    min-height:140px;
    border-radius:10px;
    border:1px dashed #d1d5db;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    color:#9ca3af;
    text-align:center;
    padding:8px;
  }

  .map-placeholder{
    width:100%;
    height:100%;
    min-height:180px;
    border-radius:10px;
    border:1px dashed #d1d5db;
    background:#e5f0ff;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    color:#1f2937;
    text-align:center;
    padding:8px;
  }

  /* Responsive */
  @media (max-width:1200px){
    .dim-row-top{
      grid-template-columns:1fr 1fr;
    }
    .dim-row-middle{
      grid-template-columns:1fr;
    }
    .dim-row-bottom{
      grid-template-columns:1fr;
    }
  }

  @media (max-width:768px){
    .dim-row-top,
    .dim-row-state{
      grid-template-columns:1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-xxl py-4">
  <h1 class="mb-1">Dimensiones</h1>
  <p class="muted small mb-3">
    Panel de análisis de oportunidades por dimensión (tiempo, plataforma, repartición, estado, tipo y provincia).
  </p>

  <div class="card" style="border-color:#c7d2fe;">
    <div class="dim-dashboard">

      {# =========================
         FILA SUPERIOR
         ========================= #}
      <div class="dim-row-top" aria-label="Filtros principales y KPI" role="group">
        <!-- Fecha -->
        <div class="filter-card filter-card--date" aria-labelledby="lblDimFecha">
          <h5 id="lblDimFecha">Fecha de apertura</h5>
          <div class="dates-row">
            <input id="dimDateFrom" type="date" aria-label="Fecha desde">
            <input id="dimDateTo" type="date" aria-label="Fecha hasta">
          </div>
          <div class="range-wrap" aria-hidden="true">
            <div class="range-track"></div>
            <div class="range-fill" id="dimDateFill"></div>
            <input type="range" id="dimRangeMin" min="0" max="100" value="0" step="1">
            <input type="range" id="dimRangeMax" min="0" max="100" value="100" step="1">
          </div>
        </div>

        <!-- KPI Procesos -->
        <div class="kpi-main" role="status" aria-live="polite">
          <h4>Procesos</h4>
          <div class="v" id="dimKpiProcesos">0</div>
          <div class="sub">Cantidad de procesos en el rango seleccionado</div>
        </div>

        <!-- Plataforma -->
        <div class="filter-card filter-card--compact">
          <h5>Plataforma</h5>
          <div class="field">
            <select id="dimPlataforma" aria-label="Filtrar por plataforma">
              <option value="">Todas</option>
            </select>
          </div>
        </div>

        <!-- Cuenta -->
        <div class="filter-card filter-card--compact">
          <h5>Cuenta</h5>
          <div class="field">
            <select id="dimCuenta" aria-label="Filtrar por cuenta">
              <option value="">Todas</option>
            </select>
          </div>
        </div>

        <!-- Repartición -->
        <div class="filter-card filter-card--compact">
          <h5>Repartición</h5>
          <div class="field">
            <select id="dimReparticion" aria-label="Filtrar por repartición">
              <option value="">Todas</option>
            </select>
          </div>
        </div>
      </div>

      {# =========================
         FILA ESTADO (PAMI / OTRAS + ESTADO)
         ========================= #}
      <div class="dim-row-state">
        <div class="filter-card">
          <h5>Repartición: PAMI u otras</h5>
          <div class="chips" id="dimSwPAMI" role="group" aria-label="Filtro PAMI u otras">
            <button type="button" class="chip is-on" data-val="todos" aria-pressed="true">Todas</button>
            <button type="button" class="chip" data-val="pami" aria-pressed="false">PAMI</button>
            <button type="button" class="chip" data-val="otras" aria-pressed="false">Otras reparticiones</button>
          </div>
        </div>

        <div class="filter-card">
          <h5>Estado</h5>
          <div class="chips" id="dimSwEstado" role="group" aria-label="Filtro de estado">
            <button type="button" class="chip is-on" data-val="todos" aria-pressed="true">Todos</button>
            <button type="button" class="chip" data-val="emergencia" aria-pressed="false">EMERGENCIA</button>
            <button type="button" class="chip" data-val="regular" aria-pressed="false">REGULAR</button>
          </div>
        </div>
      </div>

      {# =========================
         FILA MEDIA: LÍNEA DE TIEMPO + MAPA
         ========================= #}
      <div class="dim-row-middle">
        <!-- Apertura de procesos en el tiempo -->
        <section class="chart-card" aria-labelledby="dimTitleTimeline">
          <header>
            <h3 id="dimTitleTimeline">Apertura de procesos en el tiempo</h3>
            <small>Distribución diaria de aperturas según el período seleccionado.</small>
          </header>
          <div class="chart-body">
            <div class="chart-placeholder" id="dimTimelinePlaceholder">
              Aquí se mostrará el gráfico de barras por día (timeline).
            </div>
            <canvas id="dimChartTimeline" style="display:none;"></canvas>
          </div>
        </section>

        <!-- Procesos por provincia (mapa) -->
        <section class="chart-card" aria-labelledby="dimTitleMap">
          <header>
            <h3 id="dimTitleMap">Procesos por provincia</h3>
            <small>Mapa de Argentina coloreado según cantidad de procesos.</small>
          </header>
          <div class="chart-body">
            <div class="map-placeholder" id="dimMapPlaceholder">
              Mapa de Argentina<br>
              (aquí luego incorporamos el mapa interactivo).
            </div>
          </div>
        </section>
      </div>

      {# =========================
         FILA INFERIOR: TREEMAP + BARRAS + PIE
         ========================= #}
      <div class="dim-row-bottom">
        <!-- Procesos por tipo (treemap) -->
        <section class="chart-card" aria-labelledby="dimTitleTreemap">
          <header>
            <h3 id="dimTitleTreemap">Procesos por tipo</h3>
            <small>Distribución de procesos según el tipo de procedimiento.</small>
          </header>
          <div class="chart-body">
            <div class="chart-placeholder">
              Aquí se mostrará el treemap de tipos de proceso.
            </div>
            <!-- A futuro: <canvas id="dimChartTreemap"></canvas> -->
          </div>
        </section>

        <!-- Proceso por repartición y estado (barras) -->
        <section class="chart-card" aria-labelledby="dimTitleBars">
          <header>
            <h3 id="dimTitleBars">Proceso por repartición y estado</h3>
            <small>Cantidad de procesos por repartición segmentados por estado.</small>
          </header>
          <div class="chart-body">
            <div class="chart-placeholder" id="dimBarsPlaceholder">
              Aquí se mostrará el gráfico de barras por repartición y estado.
            </div>
            <canvas id="dimChartBars" style="display:none;"></canvas>
          </div>
        </section>

        <!-- Proceso por repartición y estado (pie) -->
        <section class="chart-card" aria-labelledby="dimTitlePie">
          <header>
            <h3 id="dimTitlePie">Proceso por repartición y estado</h3>
            <small>Participación relativa por estado (EMERGENCIA / REGULAR).</small>
          </header>
          <div class="chart-body">
            <div class="chart-placeholder" id="dimPiePlaceholder">
              Aquí se mostrará el gráfico de torta de estados.
            </div>
            <canvas id="dimChartPie" style="display:none;"></canvas>
          </div>
        </section>
      </div>

    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){
  // Elementos base
  const elDateFrom      = document.getElementById("dimDateFrom");
  const elDateTo        = document.getElementById("dimDateTo");
  const elRangeFill     = document.getElementById("dimDateFill");
  const elRangeMin      = document.getElementById("dimRangeMin");
  const elRangeMax      = document.getElementById("dimRangeMax");

  const elKpiProcesos   = document.getElementById("dimKpiProcesos");

  const elPlataforma    = document.getElementById("dimPlataforma");
  const elCuenta        = document.getElementById("dimCuenta");
  const elReparticion   = document.getElementById("dimReparticion");

  const chipsPamiGroup  = document.getElementById("dimSwPAMI");
  const chipsEstadoGroup= document.getElementById("dimSwEstado");

  // Canvases y placeholders de gráficos
  const canvasTimeline      = document.getElementById("dimChartTimeline");
  const canvasBars          = document.getElementById("dimChartBars");
  const canvasPie           = document.getElementById("dimChartPie");

  const placeholderTimeline = document.getElementById("dimTimelinePlaceholder");
  const placeholderBars     = document.getElementById("dimBarsPlaceholder");
  const placeholderPie      = document.getElementById("dimPiePlaceholder");

  // Instancias Chart.js
  let chartTimeline = null;
  let chartBars     = null;
  let chartPie      = null;

  const state = {
    allRows: []  // datos crudos que vienen de /api/oportunidades/buscador
  };

  const fmtInt = new Intl.NumberFormat("es-AR");

  function formatInt(n){
    if (!Number.isFinite(n)) return "0";
    return fmtInt.format(n);
  }

  // -----------------------------------------
  // 72 horas hábiles por defecto (como Buscador)
  // -----------------------------------------
  function getLastBusinessDaysRange(nDays){
    const today = new Date();
    const end = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    let date = new Date(end);
    let collected = [];

    while(collected.length < nDays){
      const day = date.getDay(); // 0 dom, 6 sáb
      if(day !== 0 && day !== 6){
        collected.push(new Date(date));
      }
      date.setDate(date.getDate() - 1);
    }

    const from = collected[collected.length - 1];
    return { from, to: end };
  }

  function ensureDefaultDates(){
    if(!elDateFrom.value && !elDateTo.value){
      const range = getLastBusinessDaysRange(3); // 3 días hábiles ~ 72 hs
      const toISO   = d => d.toISOString().slice(0,10);

      elDateFrom.value = toISO(range.from);
      elDateTo.value   = toISO(range.to);
    }
  }

  // Slider visual simple (llenar toda la barra por ahora)
  function refreshRangeFill(){
    if(!elRangeFill) return;
    const minVal = Number(elRangeMin.value || 0);
    const maxVal = Number(elRangeMax.value || 100);
    const low = Math.min(minVal, maxVal);
    const high = Math.max(minVal, maxVal);
    elRangeFill.style.left  = low + "%";
    elRangeFill.style.width = (high - low) + "%";
  }

  // -----------------------------------------
  // Construcción de filtros (selects) a partir de los rows
  // -----------------------------------------
  function populateSelectOptions(selectEl, values){
    if(!selectEl) return;
    const current = selectEl.value;
    // Mantener solo la primera opción ("Todas")
    while(selectEl.options.length > 1){
      selectEl.remove(1);
    }
    const arr = Array.from(values).filter(v => v && v.toString().trim() !== "");
    arr.sort((a,b)=> a.localeCompare(b, "es", {sensitivity:"base"}));
    for(const v of arr){
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      selectEl.appendChild(opt);
    }
    // Si el valor anterior sigue existiendo, lo mantenemos
    if(current && Array.from(selectEl.options).some(o => o.value === current)){
      selectEl.value = current;
    }
  }

  function buildFiltersFromRows(){
    const plats = new Set();
    const reps  = new Set();
    // Cuenta por ahora queda vacía (usamos "Todas")
    for(const row of state.allRows){
      if(row.plataforma) plats.add(row.plataforma);
      if(row.comprador)  reps.add(row.comprador);
    }
    populateSelectOptions(elPlataforma, plats);
    populateSelectOptions(elReparticion, reps);
  }

  // -----------------------------------------
  // Clasificación simple de estado (EMERGENCIA / REGULAR)
  // usando la descripción como aproximación
  // -----------------------------------------
  function computeEstado(row){
    const desc = (row.descripcion || "").toString().toLowerCase();
    if(desc.includes("emergencia")) return "EMERGENCIA";
    return "REGULAR";
  }

  // -----------------------------------------
  // Helpers para gráficos
  // -----------------------------------------
  function toggleChartVisibility(placeholder, canvas, hasData){
    if(!placeholder || !canvas) return;
    if(hasData){
      placeholder.style.display = "none";
      canvas.style.display = "block";
    }else{
      placeholder.style.display = "flex";
      canvas.style.display = "none";
    }
  }

  function updateTimelineChart(rows){
    if(chartTimeline){
      chartTimeline.destroy();
      chartTimeline = null;
    }
    if(!canvasTimeline) return;

    const counts = new Map();
    for(const r of rows){
      const f = r.fecha;
      if(!f) continue;
      counts.set(f, (counts.get(f) || 0) + 1);
    }
    const labels = Array.from(counts.keys()).sort();
    const data = labels.map(d => counts.get(d));

    if(labels.length === 0){
      toggleChartVisibility(placeholderTimeline, canvasTimeline, false);
      return;
    }

    toggleChartVisibility(placeholderTimeline, canvasTimeline, true);

    const ctx = canvasTimeline.getContext("2d");
    chartTimeline = new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: "Procesos",
          data: data
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: { autoSkip: true, maxTicksLimit: 10 }
          },
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0
            }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => `Procesos: ${ctx.parsed.y}`
            }
          }
        }
      }
    });
  }

  function updateBarsChart(rows){
    if(chartBars){
      chartBars.destroy();
      chartBars = null;
    }
    if(!canvasBars) return;

    const emerg = {};
    const reg   = {};
    for(const r of rows){
      const buyer = (r.comprador || "Sin repartición").toString();
      const est   = r._estado || computeEstado(r);
      if(est === "EMERGENCIA"){
        emerg[buyer] = (emerg[buyer] || 0) + 1;
      }else{
        reg[buyer] = (reg[buyer] || 0) + 1;
      }
    }

    // Total por repartición para ordenar
    const buyersSet = new Set([
      ...Object.keys(emerg),
      ...Object.keys(reg)
    ]);
    let buyers = Array.from(buyersSet);
    buyers.sort((a,b)=>{
      const ta = (emerg[a] || 0) + (reg[a] || 0);
      const tb = (emerg[b] || 0) + (reg[b] || 0);
      return tb - ta;
    });
    // Limitamos a top 8 para que no explote
    buyers = buyers.slice(0, 8);

    const dataEmerg = buyers.map(b => emerg[b] || 0);
    const dataReg   = buyers.map(b => reg[b] || 0);

    const hasData = buyers.length > 0 && (dataEmerg.some(v => v>0) || dataReg.some(v => v>0));
    if(!hasData){
      toggleChartVisibility(placeholderBars, canvasBars, false);
      return;
    }

    toggleChartVisibility(placeholderBars, canvasBars, true);

    const ctx = canvasBars.getContext("2d");
    chartBars = new Chart(ctx, {
      type: "bar",
      data: {
        labels: buyers,
        datasets: [
          {
            label: "EMERGENCIA",
            data: dataEmerg
          },
          {
            label: "REGULAR",
            data: dataReg
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            stacked: true,
            ticks: { autoSkip: true, maxTicksLimit: 8 }
          },
          y: {
            stacked: true,
            beginAtZero: true,
            ticks: { precision: 0 }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y}`
            }
          }
        }
      }
    });
  }

  function updatePieChart(rows){
    if(chartPie){
      chartPie.destroy();
      chartPie = null;
    }
    if(!canvasPie) return;

    let cntEmerg = 0;
    let cntReg   = 0;
    for(const r of rows){
      const est = r._estado || computeEstado(r);
      if(est === "EMERGENCIA") cntEmerg++;
      else cntReg++;
    }

    const hasData = (cntEmerg + cntReg) > 0;
    if(!hasData){
      toggleChartVisibility(placeholderPie, canvasPie, false);
      return;
    }

    toggleChartVisibility(placeholderPie, canvasPie, true);

    const ctx = canvasPie.getContext("2d");
    chartPie = new Chart(ctx, {
      type: "pie",
      data: {
        labels: ["EMERGENCIA", "REGULAR"],
        datasets: [{
          data: [cntEmerg, cntReg]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "bottom"
          },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const total = cntEmerg + cntReg || 1;
                const val   = ctx.parsed;
                const pct   = (val * 100 / total).toFixed(1);
                return `${ctx.label}: ${val} (${pct}%)`;
              }
            }
          }
        }
      }
    });
  }

  function updateAllCharts(rows){
    updateTimelineChart(rows);
    updateBarsChart(rows);
    updatePieChart(rows);
  }

  // -----------------------------------------
  // Aplicar filtros de UI sobre state.allRows
  // -----------------------------------------
  function applyUiFilters(){
    let rows = state.allRows.slice();

    const selPlataforma  = elPlataforma ? elPlataforma.value : "";
    const selCuenta      = elCuenta ? elCuenta.value : "";
    const selReparticion = elReparticion ? elReparticion.value : "";

    const chipPami = chipsPamiGroup
      ? chipsPamiGroup.querySelector(".chip.is-on")
      : null;
    const modePami = chipPami ? chipPami.dataset.val : "todos";

    const chipEstado = chipsEstadoGroup
      ? chipsEstadoGroup.querySelector(".chip.is-on")
      : null;
    const modeEstado = chipEstado ? chipEstado.dataset.val : "todos";

    rows = rows.filter(r => {
      const comprador = (r.comprador || "").toString();
      const compradorUpper = comprador.toUpperCase();
      const plataforma = (r.plataforma || "").toString();

      // Plataforma (servidor también filtra, pero esto refina)
      if(selPlataforma && plataforma !== selPlataforma) return false;

      // Cuenta (por ahora solo "Todas"; placeholder para futuro)
      if(selCuenta && selCuenta !== "") {
        // TODO: cuando tengamos el campo en el API, filtrar acá.
      }

      // Repartición por select
      if(selReparticion && comprador !== selReparticion) return false;

      // PAMI / Otras
      if(modePami === "pami" && !compradorUpper.includes("PAMI")) return false;
      if(modePami === "otras" && compradorUpper.includes("PAMI")) return false;

      // Estado: EMERGENCIA / REGULAR (clasificación simple)
      const est = r._estado || computeEstado(r);
      if(modeEstado === "emergencia" && est !== "EMERGENCIA") return false;
      if(modeEstado === "regular" && est !== "REGULAR") return false;

      return true;
    });

    // KPI principal
    if(elKpiProcesos){
      elKpiProcesos.textContent = formatInt(rows.length);
    }

    // Actualizamos gráficos con los rows filtrados
    updateAllCharts(rows);
  }

  // -----------------------------------------
  // Cargar datos desde /api/oportunidades/buscador
  // (mismos datos que usa Buscador)
  // -----------------------------------------
  async function loadData(){
    ensureDefaultDates();

    const params = new URLSearchParams();
    if(elDateFrom && elDateFrom.value) params.set("date_from", elDateFrom.value);
    if(elDateTo && elDateTo.value)     params.set("date_to", elDateTo.value);

    // Filtros server-side básicos (misma lógica que Buscador)
    if(elPlataforma && elPlataforma.value){
      params.set("platform", elPlataforma.value);
    }
    if(elReparticion && elReparticion.value){
      params.set("buyer", elReparticion.value);
    }
        // Provincia no está en la UI de este dashboard (se puede sumar a futuro)

    // IMPORTANTE: el backend sólo permite page_size hasta 200
    params.set("page_size", "200");

    const url = "/api/oportunidades/buscador?" + params.toString();

    try{
      const resp = await fetch(url);
      if(!resp.ok){
        console.error("Dimensiones: error HTTP", resp.status);
        return;
      }
      const data = await resp.json();
      if(!data || data.ok === false){
        console.warn("Dimensiones: respuesta sin datos válidos", data);
        state.allRows = [];
      } else {
        state.allRows = Array.isArray(data.rows) ? data.rows : [];
      }

      // Pre-calculamos un "estado" aproximado por fila
      state.allRows.forEach(r => {
        r._estado = computeEstado(r);
      });

      // Construimos opciones de filtros a partir de los datos
      buildFiltersFromRows();

      // Actualizamos KPI y gráficos
      applyUiFilters();

      // Refrescamos la barrita del rango (visual)
      refreshRangeFill();
    } catch(err){
      console.error("Dimensiones: error al cargar datos", err);
    }
  }

  // -----------------------------------------
  // Listeners de UI
  // -----------------------------------------
  if(chipsPamiGroup){
    chipsPamiGroup.querySelectorAll(".chip").forEach(btn => {
      btn.addEventListener("click", () => {
        chipsPamiGroup.querySelectorAll(".chip").forEach(c => {
          c.classList.remove("is-on");
          c.setAttribute("aria-pressed","false");
        });
        btn.classList.add("is-on");
        btn.setAttribute("aria-pressed","true");
        applyUiFilters();
      });
    });
  }

  if(chipsEstadoGroup){
    chipsEstadoGroup.querySelectorAll(".chip").forEach(btn => {
      btn.addEventListener("click", () => {
        chipsEstadoGroup.querySelectorAll(".chip").forEach(c => {
          c.classList.remove("is-on");
          c.setAttribute("aria-pressed","false");
        });
        btn.classList.add("is-on");
        btn.setAttribute("aria-pressed","true");
        applyUiFilters();
      });
    });
  }

  if(elPlataforma){
    elPlataforma.addEventListener("change", () => {
      // Re-cargamos desde el servidor con estos filtros
      loadData();
    });
  }
  if(elCuenta){
    elCuenta.addEventListener("change", () => {
      // De momento solo filtra en cliente
      applyUiFilters();
    });
  }
  if(elReparticion){
    elReparticion.addEventListener("change", () => {
      loadData();
    });
  }

  if(elDateFrom){
    elDateFrom.addEventListener("change", () => loadData());
  }
  if(elDateTo){
    elDateTo.addEventListener("change", () => loadData());
  }

  if(elRangeMin){
    elRangeMin.addEventListener("input", refreshRangeFill);
  }
  if(elRangeMax){
    elRangeMax.addEventListener("input", refreshRangeFill);
  }

  // -----------------------------------------
  // Init
  // -----------------------------------------
  ensureDefaultDates();
  refreshRangeFill();
  loadData();
});
</script>
{% endblock %}
