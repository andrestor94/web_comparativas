{% extends "base.html" %}
{% block title %}Seguimiento â€“ Proceso{% endblock %}

{% block extra_head %}
<style>
  /* === Variables & Base === */
  :root {
    --suizo-blue: #003366;
    --suizo-red: #E30613;
    --text-dark: #212529;
    --text-muted: #6c757d;
  }

  .text-suizo-blue {
    color: var(--suizo-blue);
  }

  .text-suizo-red {
    color: var(--suizo-red);
  }

  /* === Header Card === */
  .header-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    padding: 2rem;
    margin-bottom: 2rem;
    border-left: 5px solid var(--suizo-blue);
  }

  .header-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--suizo-blue);
    margin-bottom: 0.5rem;
  }

  .meta-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #f1f3f5;
  }

  .meta-item {
    display: flex;
    flex-direction: column;
  }

  .meta-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
    font-weight: 600;
    margin-bottom: 0.25rem;
  }

  .meta-value {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-dark);
  }

  /* === Stepper === */
  .stepper-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    padding: 3rem 1rem;
    margin-bottom: 2rem;
    overflow: hidden;
    /* Evitar scrollbar */
  }

  .stepper-container {
    position: relative;
    width: 100%;
    max-width: 1000px;
    margin: 0 auto;
  }

  .stepper-track {
    position: absolute;
    top: 20px;
    height: 4px;
    background-color: #e9ecef;
    z-index: 1;
    border-radius: 4px;
    left: 0;
    right: 0;
  }

  .stepper-progress-bar {
    position: absolute;
    top: 20px;
    height: 4px;
    background-color: var(--suizo-blue);
    z-index: 2;
    width: 0%;
    transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0, 51, 102, 0.2);
  }

  .stepper-items {
    position: relative;
    display: flex;
    justify-content: space-between;
    z-index: 3;
  }

  .step-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    position: relative;
  }

  .step-circle {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: #fff;
    border: 2px solid #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #adb5bd;
    font-weight: 700;
    font-size: 1rem;
    transition: all 0.3s ease;
    z-index: 4;
  }

  .step-label {
    margin-top: 1rem;
    font-size: 0.85rem;
    color: var(--text-muted);
    font-weight: 500;
    text-align: center;
    max-width: 120px;
    line-height: 1.3;
    transition: color 0.3s ease;
  }

  /* Estados Stepper */
  .step-item.current .step-circle {
    border-color: var(--suizo-blue);
    color: var(--suizo-blue);
    background: #fff;
    box-shadow: 0 0 0 4px rgba(0, 51, 102, 0.1);
    transform: scale(1.1);
  }

  .step-item.current .step-label {
    color: var(--suizo-blue);
    font-weight: 700;
  }

  .step-item.done .step-circle {
    background: var(--suizo-blue);
    border-color: var(--suizo-blue);
    color: #fff;
  }

  .step-item.done .step-label {
    color: var(--suizo-blue);
    font-weight: 600;
  }

  .step-item.error .step-circle {
    border-color: var(--suizo-red);
    color: var(--suizo-red);
  }

  .step-item.error .step-label {
    color: var(--suizo-red);
  }

  @keyframes pulse-blue {
    0% {
      box-shadow: 0 0 0 0 rgba(0, 51, 102, 0.4);
    }

    70% {
      box-shadow: 0 0 0 10px rgba(0, 51, 102, 0);
    }

    100% {
      box-shadow: 0 0 0 0 rgba(0, 51, 102, 0);
    }
  }

  .step-item.current .step-circle {
    animation: pulse-blue 2s infinite;
  }

  /* === Modern Buttons === */
  .btn-suizo-primary {
    background-color: var(--suizo-blue);
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    box-shadow: 0 4px 6px rgba(0, 51, 102, 0.2);
    transition: all 0.2s ease;
  }

  .btn-suizo-primary:hover:not(.disabled) {
    background-color: #002244;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 51, 102, 0.25);
    color: #fff;
  }

  .btn-suizo-primary.disabled {
    background-color: #aeb9cc;
    box-shadow: none;
    cursor: not-allowed;
  }

  .btn-suizo-secondary {
    background-color: transparent;
    border: 2px solid #dee2e6;
    color: var(--text-muted);
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .btn-suizo-secondary:hover {
    border-color: var(--suizo-blue);
    color: var(--suizo-blue);
    background: #f8f9fa;
  }

  .btn-suizo-outline-red {
    background-color: transparent;
    border: 2px solid #f8d7da;
    color: var(--suizo-red);
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
  }

  .btn-suizo-outline-red:hover {
    background-color: #fff5f5;
    border-color: var(--suizo-red);
  }

  .btn-icon-gap {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* Utils */
  .tiny {
    font-size: 0.85rem;
  }

  details.debug summary {
    cursor: pointer;
    color: var(--text-muted);
    font-size: 0.8rem;
  }

  /* Badges para el grid */
  .status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 99px;
    font-size: 0.85rem;
    font-weight: 600;
    background: #f8f9fa;
    color: #495057;
  }

  .status-badge.ok {
    background: #d3f9d8;
    color: #0b7285;
  }

  .status-badge.err {
    background: #ffe3e3;
    color: #c92a2a;
  }

  .status-badge.info {
    background: #e7f5ff;
    color: #1864ab;
  }
</style>
{% endblock %}

{% block content %}
{% set U = upload if upload is defined else up %}
<div class="container py-5">

  {# ðŸ‘‡ Header Section #}
  <div class="header-card">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
      <div>
        <div class="text-uppercase text-muted fw-bold"
          style="font-size:0.75rem; letter-spacing:1px; margin-bottom:4px;">
          Detalle del Proceso
        </div>
        <h1 class="header-title">
          Proceso NÂ° {{ U.proceso_nro or (U.id|string) }}
        </h1>
      </div>

      <div class="text-end">
        <span id="headerStatusBadge" class="status-badge info">Cargando...</span>
      </div>
    </div>

    <div class="meta-grid">
      <div class="meta-item">
        <span class="meta-label">Fecha Apertura</span>
        <span class="meta-value">{{ U.apertura_fecha or "â€”" }}</span>
      </div>
      <div class="meta-item">
        <span class="meta-label">Plataforma</span>
        <span class="meta-value" id="metaAdapter">{{ U.platform_hint or "â€”" }}</span>
      </div>
      <div class="meta-item">
        <span class="meta-label">ActualizaciÃ³n</span>
        <span class="meta-value">
          <span id="lastUpd">â€”</span> <small id="lastUpdRel" class="text-muted fw-normal">(-)</small>
        </span>
      </div>
    </div>
  </div>

  {# ðŸ‘‡ Aviso Duplicado #}
  {% if dup %}
  <div class="alert alert-warning d-flex align-items-center gap-3 shadow-sm border-0"
    style="border-radius:12px; background:#fff3cd; color:#664d03;">
    <i class="bi bi-exclamation-triangle-fill fs-4"></i>
    <div>
      <strong>Proceso duplicado.</strong> Te mostramos el registro existente.
    </div>
  </div>
  {% endif %}

  <div id="errorBanner" class="alert alert-danger d-flex align-items-center gap-3 shadow-sm border-0 d-none"
    style="border-radius:12px;">
    <i class="bi bi-x-circle-fill fs-4"></i>
    <div>OcurriÃ³ un error. RevisÃ¡ el diagnÃ³stico abajo o reintentÃ¡.</div>
  </div>

  {# ðŸ‘‡ Stepper Section #}
  <div class="stepper-card">
    <div class="stepper-container">
      <div class="stepper-track" id="stepperTrack"></div>
      <div class="stepper-progress-bar" id="tlFill"></div>
      <div class="stepper-items" id="stepper"></div>
    </div>

    <div class="text-center mt-4 text-muted tiny" id="noStepsMsg" style="display:none;">
      No se pudo cargar el progreso.
    </div>
  </div>

  {# ðŸ‘‡ Actions Section #}
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-5">

    <div class="d-flex flex-wrap gap-3">
      <a id="btnDashboard" class="btn btn-suizo-primary btn-icon-gap disabled" href="/tablero/{{ U.id }}"
        aria-disabled="true">
        <i class="bi bi-bar-chart-fill"></i> Ver Tablero
      </a>

      <a id="btnDownload" class="btn btn-suizo-secondary btn-icon-gap disabled" href="/descargas/{{ U.id }}"
        aria-disabled="true">
        <i class="bi bi-file-earmark-excel"></i> Descargar Excel
      </a>

      {% if user and (user.role or '').lower() == 'admin' %}
      <a id="btnOriginal" class="btn btn-suizo-secondary btn-icon-gap" href="/cargas/{{ U.id }}/original"
        target="_blank">
        <i class="bi bi-file-earmark-zip"></i> Archivo Original
      </a>
      {% endif %}

      <button id="btnRefresh" type="button" class="btn btn-suizo-secondary btn-icon-gap">
        <i class="bi bi-arrow-clockwise"></i> Refrescar
      </button>
    </div>

    {% if user and (user.role or '').lower() == 'admin' %}
    <div class="d-flex gap-2 p-2 rounded bg-white shadow-sm border">
      <button id="btnPrev" class="btn btn-sm btn-link text-muted text-decoration-none">
        <i class="bi bi-chevron-left"></i> Retroceder
      </button>
      <div class="vr"></div>
      <button id="btnNext" class="btn btn-sm btn-link text-suizo-blue text-decoration-none fw-bold">
        Avanzar <i class="bi bi-chevron-right"></i>
      </button>
    </div>
    {% endif %}
  </div>

  <div class="d-flex justify-content-between align-items-center mt-3">
    <div class="form-check form-switch text-muted tiny">
      <input class="form-check-input" type="checkbox" id="toggleAutoRedir" style="cursor:pointer;">
      <label class="form-check-label" for="toggleAutoRedir" style="cursor:pointer;">
        Abrir tablero automÃ¡ticamente al finalizar
      </label>
    </div>
    <details class="debug">
      <summary>DiagnÃ³stico tÃ©cnico</summary>
      <pre class="mt-2 p-3 bg-light rounded border" id="dbgJson"
        style="font-size:0.75rem; white-space:pre-wrap; max-height:200px; overflow:auto;"></pre>
    </details>
  </div>

</div>

<script>
  /* ===================== Setup y utilidades ===================== */
  const uploadId = Number({{ U.id or 0 }});
  const PROC_LABEL = {{ (U.proceso_nro or("NÂ° " ~U.id))| tojson }};

  // Elements
  const stepper = document.getElementById("stepper");
  const tlFill = document.getElementById("tlFill");
  const stepperTrack = document.getElementById("stepperTrack");

  const btnDash = document.getElementById("btnDashboard");
  const btnDown = document.getElementById("btnDownload");
  const btnRef = document.getElementById("btnRefresh");

  const headerStatusBadge = document.getElementById("headerStatusBadge");
  const metaAdapter = document.getElementById("metaAdapter");

  const lastUpd = document.getElementById("lastUpd");
  const lastUpdRel = document.getElementById("lastUpdRel");
  const errorBanner = document.getElementById("errorBanner");
  const dbgJson = document.getElementById("dbgJson");
  const noStepsMsg = document.getElementById("noStepsMsg");

  const btnPrev = document.getElementById("btnPrev");
  const btnNext = document.getElementById("btnNext");

  const params = new URLSearchParams(location.search);

  // Auto Redir Logic
  const toggleAutoRedir = document.getElementById("toggleAutoRedir");
  // 1. URL priority, 2. LocalStorage, 3. Default false
  const urlAuto = params.get("autoredir") === "1";
  const storedAuto = localStorage.getItem("status_autoredir") === "true";
  let shouldAutoRedir = urlAuto || storedAuto;

  // Update UI & Storage
  if (toggleAutoRedir) {
    toggleAutoRedir.checked = shouldAutoRedir;
    toggleAutoRedir.addEventListener("change", (e) => {
      shouldAutoRedir = e.target.checked;
      localStorage.setItem("status_autoredir", shouldAutoRedir);
    });
  }

  // State
  let lastState = { index: 0, status: "pending", steps: [] };
  let notifiedDone = false; // Prevents duplicate done notifications

  const STATUS_LABEL = {
    pending: "Pendiente",
    classifying: "Validado",
    processing: "Procesando",
    reviewing: "En revisiÃ³n",
    dashboard: "Tablero Listo",
    done: "Finalizado",
    error: "Error"
  };

  const FALLBACK_STEPS = [
    { key: "pending", label: "Pendiente" },
    { key: "classifying", label: "Validado" },
    { key: "processing", label: "Procesando" },
    { key: "reviewing", label: "RevisiÃ³n" },
    { key: "dashboard", label: "Tablero" },
    { key: "done", label: "Finalizado" }
  ];

  /* ===================== Render Logic ===================== */

  function updateHeader(data) {
    const s = String(data.status || "").toLowerCase();
    const label = STATUS_LABEL[s] || s;

    headerStatusBadge.textContent = label;
    headerStatusBadge.className = "status-badge";

    if (["dashboard", "done"].includes(s)) headerStatusBadge.classList.add("ok");
    else if (s === "error") headerStatusBadge.classList.add("err");
    else headerStatusBadge.classList.add("info");

    metaAdapter.textContent = data.adapter || "â€”";

    // Normalized Button State
    const isReady = !!data.normalized_ready;
    if (isReady) {
      btnDown.classList.remove("disabled");
      btnDown.removeAttribute("aria-disabled");
    } else {
      btnDown.classList.add("disabled");
      btnDown.setAttribute("aria-disabled", "true");
    }
  }

  function renderSteps(data) {
    lastState = data && data.ok ? data : (data || lastState);
    const steps = (lastState.steps && lastState.steps.length) ? lastState.steps : FALLBACK_STEPS;

    // Update Header
    updateHeader(lastState);

    // Clear & Rebuild Stepper
    stepper.innerHTML = "";
    noStepsMsg.style.display = (steps.length > 0) ? "none" : "block";

    const idx = Number(lastState.index != null ? lastState.index : 0);
    const status = String(lastState.status || "").toLowerCase();
    const isError = status === "error";
    const isDone = status === "done" || status === "dashboard";

    steps.forEach((s, i) => {
      const el = document.createElement("div");

      const past = i < idx;
      const current = i === idx;

      let cls = "step-item";
      if (past || (current && isDone)) cls += " done";
      else if (current) cls += " current";
      if (current && isError) cls += " error";
      el.className = cls;

      // Icons
      let icon = (i + 1);
      if (current && isError) icon = '<i class="bi bi-exclamation-lg"></i>';
      else if (past || (current && isDone)) icon = '<i class="bi bi-check-lg" style="font-size:1.4rem"></i>';

      el.innerHTML = `
        <div class="step-circle" title="${s.label || s.key}">${icon}</div>
        <div class="step-label">${s.label || s.key}</div>
      `;
      stepper.appendChild(el);
    });

    // --- ALIGNMENT FIX ---
    // Calculate the center position of the first and last step
    const stepCount = steps.length || 1;
    const halfStepPercent = (100 / stepCount) / 2;

    // Adjust Track & Bar Layout
    stepperTrack.style.left = `${halfStepPercent}%`;
    stepperTrack.style.width = `${100 - (100 / stepCount)}%`;

    tlFill.style.left = `${halfStepPercent}%`;

    // Calculate Fill %
    // We want 0% to be just a dot at start, 100% to fill the whole line
    const totalSegments = stepCount - 1;
    let pct = 0;
    if (totalSegments > 0) {
      pct = (idx / totalSegments) * 100;
    }
    pct = Math.max(0, Math.min(100, pct));
    // Scale width relative to the constrained track width
    // Actually tlFill is positioned same as track, so width=100% means full track
    // But since `idx` is 0-based index steps, we map 0..totalSegments -> 0..100%
    // Note: If isDone, we might want full 100% even if index is last
    tlFill.style.width = `calc(${100 - (100 / stepCount)}% * ${pct / 100})`;


    // Dashboard Button
    if (lastState.can_open_dashboard) {
      btnDash.classList.remove("disabled");
      btnDash.removeAttribute("aria-disabled");
      // Use dynamic flag
      if (shouldAutoRedir && lastState.dashboard_url) window.location.replace(lastState.dashboard_url);
    } else {
      btnDash.classList.add("disabled");
      btnDash.setAttribute("aria-disabled", "true");
    }

    // Admin buttons state
    if (btnPrev) btnPrev.disabled = (idx <= 0);
    if (btnNext) btnNext.disabled = (idx >= stepCount - 1);

    toggleError(isError);
    setLastUpd();
  }

  /* ===================== Time & Utils ===================== */
  let lastUpdateTs = null;
  function setLastUpd() {
    const d = new Date();
    lastUpdateTs = d;
    lastUpd.textContent = d.toLocaleTimeString();
    lastUpdRel.textContent = `(justo ahora)`;
  }
  function fmtRel(d) {
    const s = Math.max(0, ((Date.now() - d) / 1000) | 0);
    if (s < 5) return "justo ahora";
    if (s < 60) return `${s}s`;
    const m = (s / 60) | 0; if (m < 60) return `${m}m`;
    return `${(m / 60) | 0}h`;
  }
  setInterval(() => { if (lastUpdateTs) lastUpdRel.textContent = `(${fmtRel(lastUpdateTs)})`; }, 5000);
  function toggleError(show) { errorBanner.classList.toggle("d-none", !show); }

  /* ===================== Notificaciones (Fix Duplicate) ===================== */
  let currentBanner = null;
  function showBanner(msg, type = "info", sticky = true) {
    if (!window.Notify) return;
    try { if (currentBanner?.remove) currentBanner.remove(); } catch { }
    currentBanner = window.Notify.banner({ message: msg, type, sticky });
  }

  function handleNotify(prevStatus, newStatus, data) {
    if (!window.Notify) return;
    const s = String(newStatus || "").toLowerCase();

    // 1) Done/Dashboard (Only once)
    if (s === "done" || s === "dashboard") {
      if (notifiedDone) return; // Prevent duplicate
      notifiedDone = true;
      try { if (currentBanner?.remove) currentBanner.remove(); } catch { }

      const url = data.dashboard_url || `/tablero/${uploadId}`;
      window.Notify.toast({
        type: "success",
        title: "Â¡Proceso Finalizado!",
        message: `${PROC_LABEL} estÃ¡ listo para visualizar.`,
        actionText: "Ver Tablero",
        onAction: () => location.href = url
      });
      return;
    }

    // 2) Error
    if (s === "error") {
      notifiedDone = false; // Reset if error occurs after done (weird but possible)
      window.Notify.toast({
        type: "error",
        title: "Error Detectado",
        message: "Hubo un problema procesando el archivo.",
        actionText: "Reintentar",
        onAction: () => location.reload()
      });
      return;
    }

    // 3) Progress
    const human = STATUS_LABEL[s] || s;
    const msg = `${PROC_LABEL}: Estado actual ${human}.`;
    // Only show banner if status changed
    if (prevStatus !== s) {
      showBanner(msg, "info", true);
    }
  }

  /* ===================== Polling ===================== */
  let delay = 1000, maxDelay = 5000, stopped = false;

  async function fetchStatusAndRender() {
    try {
      const r = await fetch(`/api/cargas/${uploadId}/status`, { cache: "no-store" });
      if (r.ok) {
        const j = await r.json();
        if (j && j.ok) {
          const prev = lastState.status;
          renderSteps(j);
          dbgJson.textContent = JSON.stringify(j, null, 2);

          handleNotify(prev, String(j.status || "").toLowerCase(), j);

          if (["done", "dashboard", "error"].includes(String(j.status))) {
            stopped = true;
          }
        }
      }
    } catch (e) { console.error(e); }
  }

  async function tick() {
    await fetchStatusAndRender();
    if (!stopped) setTimeout(tick, delay);
  }

  // Event Listeners
  btnRef.addEventListener("click", () => { stopped = false; tick(); });
  document.addEventListener("visibilitychange", () => { if (!document.hidden) tick(); });

  // Admin Controls
  async function move(action) {
    const fd = new FormData(); fd.append("action", action);
    await fetch(`/api/cargas/${uploadId}/avance`, { method: "POST", body: fd });
    tick();
  }
  if (btnPrev) btnPrev.addEventListener("click", () => move("prev"));
  if (btnNext) btnNext.addEventListener("click", () => move("next"));

  // Init
  window.addEventListener("DOMContentLoaded", () => {
    // Initial Render
    renderSteps({ steps: FALLBACK_STEPS, index: 0, status: "pending" });
    tick();
  });
</script>
{% endblock %}