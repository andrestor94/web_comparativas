{% extends "base.html" %}
{% block title %}{{ 'Nuevo usuario' if is_new else 'Editar usuario' }} – Web Comparativas{% endblock %}

{% block content %}

<div class="d-flex justify-content-center">
  <div class="card" style="max-width:720px; width:100%;">
    <div class="card-body">
      <h2 class="mb-4">{{ 'Nuevo usuario' if is_new else 'Editar usuario' }}</h2>

      {# ====== Mensajes globales de error (crear/editar) ====== #}
      {% if error %}
        <div class="alert alert-danger mb-4">{{ error }}</div>
      {% elif errors %}
        <div class="alert alert-danger mb-4">
          <ul class="m-0">
            {% for e in errors %}<li>{{ e }}</li>{% endfor %}
          </ul>
        </div>
      {% endif %}

      {# ====== Feedback de cambio de contraseña (via querystring) ====== #}
      {% if perror == 'short' %}
        <div class="alert alert-warning mb-4">La nueva contraseña debe tener al menos 8 caracteres.</div>
      {% elif perror == 'nomatch' %}
        <div class="alert alert-warning mb-4">Las contraseñas no coinciden.</div>
      {% elif perror == 'fail' %}
        <div class="alert alert-danger mb-4">No se pudo actualizar la contraseña. Intenta nuevamente.</div>
      {% elif pok %}
        <div class="alert alert-success mb-4">Contraseña actualizada correctamente.</div>
      {% endif %}

      {# ---------- Form principal: crear/editar ---------- #}
      <form method="post" action="/usuarios/{{ 'nuevo' if is_new else form.id }}/actualizar" class="grid gap-3 mb-4" autocomplete="off">

        <div class="span-12">
          <label class="form-label" for="email">Email</label>
          <input
            class="input"
            id="email"
            type="email"
            name="email"
            value="{{ form.email or '' }}"
            {% if not allow_edit_email %}readonly{% endif %}
            {% if is_new %}required{% endif %}
          >
          {% if allow_edit_email %}
            <div class="text-subtle small mt-1">Puedes modificarlo si lo necesitas.</div>
          {% else %}
            <div class="text-subtle small mt-1">El email no puede modificarse aquí.</div>
          {% endif %}
        </div>

        <div class="span-12">
          <label class="form-label" for="name">Nombre completo</label>
          <input
            class="input"
            id="name"
            name="name"
            value="{{ (form.full_name or form.name or form.nombre) or '' }}"
            required
            placeholder="Nombre y apellido"
          >
        </div>

        {# ====== Unidad de Negocio (actualizado) ====== #}
        {% set bu_opts = (business_units if business_units is defined else [
          'Productos Hospitalarios',
          'Estética Médica y Reconstructiva',
          'Tratamientos Especiales',
          'Otros'
        ]) %}
        {% set bu_val = (form.unit_business or 'Otros') %}
        <div class="span-12">
          <label class="form-label" for="unit_business">Unidad de Negocio</label>
          <select class="select" id="unit_business" name="unit_business" required>
            {% for opt in bu_opts %}
              <option value="{{ opt }}" {% if opt == bu_val %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
          <div class="text-subtle small mt-1">Clasifica al usuario según la unidad de negocio a la que pertenece.</div>
        </div>

        <div class="span-12">
          <label class="form-label" for="role">Rol</label>
          {% set r = (form.role or '')|lower %}
          {# Normaliza 'visor' heredado como 'auditor' #}
          {% if r == 'visor' %}{% set r = 'auditor' %}{% endif %}
          <select class="select" id="role" name="role" required>
            <option value="admin"      {% if r=='admin' %}selected{% endif %}>Administrador</option>
            <option value="supervisor" {% if r=='supervisor' %}selected{% endif %}>Supervisor</option>
            <option value="analista"   {% if r=='analista' %}selected{% endif %}>Analista</option>
            <option value="auditor"    {% if r=='auditor' %}selected{% endif %}>Auditor</option>
          </select>
          <div class="text-subtle small mt-1">
            • <strong>Administrador:</strong> acceso total.<br>
            • <strong>Supervisor:</strong> puede cargar y ver todo, sin crear usuarios.<br>
            • <strong>Analista:</strong> puede cargar y ver solo sus procesos.<br>
            • <strong>Auditor:</strong> solo lectura de todos los procesos.
          </div>
        </div>

        <div class="span-12 d-flex gap-2">
          <a class="btn btn-ghost" href="/usuarios">Volver</a>
          <button class="btn btn-primary" type="submit">{{ 'Crear' if is_new else 'Guardar' }}</button>
        </div>

      </form>

      {# ---------- Cambiar contraseña (solo edición) ---------- #}
      {% if not is_new and form and form.id %}
      <div class="card card-muted mt-4">
        <div class="card-body">
          <h6 class="mb-3">Cambiar contraseña</h6>
          <form method="post" action="/usuarios/{{ form.id }}/password" class="grid gap-2" style="grid-template-columns: 1fr 1fr auto;">
            <div class="span-1">
              <input class="input" name="nueva" type="password" minlength="8" placeholder="Nueva contraseña" required>
            </div>
            <div class="span-1">
              <input class="input" name="confirmar" type="password" minlength="8" placeholder="Confirmar contraseña" required>
            </div>
            <div class="span-1 d-flex justify-content-end">
              <button class="btn btn-primary" type="submit">Actualizar</button>
            </div>
          </form>
          <div class="text-subtle small mt-1">Mínimo 8 caracteres.</div>
        </div>
      </div>
      {% endif %}

    </div>
  </div>
</div>

{% endblock %}
