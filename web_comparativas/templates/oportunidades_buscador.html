{% extends "base.html" %}
{% block title %}Buscador{% endblock %}

{% block extra_head %}
<style>
  .muted{color:#6b7280;font-size:14px}
  .muted.small{font-size:13px}
  .card{
    background:var(--sa-blanco,#fff);
    border:1px solid var(--sa-gris-borde,#e5e7eb);
    border-radius:14px;
    padding:16px 18px;
    box-shadow:0 1px 2px rgba(15,23,42,.04);
    overflow:visible; /* deja salir los desplegables */
  }
  .btn{
    background:var(--sa-azul-btn,#5274ce);
    color:#fff;
    border:0;
    border-radius:10px;
    padding:8px 12px;
    cursor:pointer;
    font-size:14px;
  }
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn-link{
    background:transparent;
    border:0;
    color:var(--sa-azul-btn,#5274ce);
    cursor:pointer;
    font-size:14px;
  }
  .stack{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

  /* Campos mÃ¡s compactos */
  .field input,
  .field select{
    width:100%;
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:3px 8px;
    background:#fff;
    font-size:12px;
    height:28px;
  }

  .badges>span{
    display:inline-block;
    background:#eef2f7;
    border:1px solid #e5e7eb;
    padding:4px 8px;
    border-radius:999px;
    font-size:12px;
    margin-left:6px;
  }

  /* Toast closable */
  .toast{
    border:1px solid #a7f3d0;
    background:#ecfdf5;
    color:#065f46;
    padding:8px 12px;
    border-radius:10px;
    margin-bottom:12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    font-size:14px;
  }
  .toast-close{
    border:0;
    background:transparent;
    cursor:pointer;
    font-size:16px;
    line-height:1;
    color:#065f46;
    opacity:.7;
  }
  .toast-close:hover{opacity:1;}

  /* --------- Upload (sin dropzone) --------- */
  .upload-card{display:flex;flex-direction:column;gap:10px}
  .upload-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:16px;
  }
  .upload-title{font-size:16px;font-weight:600;margin:0;color:#111827}
  .upload-meta{text-align:right;font-size:12px}
  .upload-meta .badges{margin-top:4px}

  .upload-grid{
    display:grid;
    grid-template-columns:minmax(0,1fr) auto;
    gap:12px;
    align-items:center;
  }
  .upload-file .field{width:100%}
  .upload-actions{
    display:flex;
    align-items:center;
    justify-content:flex-end;
    gap:10px;
  }

  /* Barra superior: filtros + KPI */
  .topbar{
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .filters-grid{
    display:grid;
    grid-template-columns:1.2fr repeat(4,minmax(0,1fr));
    gap:8px;
    overflow:visible;
    margin-bottom:6px;
  }

  .filter-card{
    background:#f8fafc;
    border:1px solid var(--sa-gris-borde,#e5e7eb);
    border-radius:12px;
    padding:6px 8px;
  }
  .filter-card h5{
    font-size:10px;
    margin:0 0 4px;
    color:#4b5563;
  }

  /* Fecha compacta */
  .filter-card--fecha{
    padding:4px 8px 6px;
    min-height:90px;
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .date-row{
    display:flex;
    gap:6px;
    align-items:center;
  }
  .date-field{
    flex:1;
    display:flex;
    align-items:center;
    gap:4px;
    font-size:11px;
    color:#4b5563;
  }
  .date-field span{
    white-space:nowrap;
  }
  .date-field input[type="date"]{
    height:26px;
    font-size:12px;
    padding:2px 6px;
  }

  /* VersiÃ³n compacta para Plataforma / Operador / Cuenta / ReparticiÃ³n */
  .filter-card--compact{
    padding:4px 8px;
    min-height:70px;
    display:flex;
    flex-direction:column;
    justify-content:center;  /* centra tÃ­tulo + select */
    gap:4px;
  }
  .filter-card--compact .field{
    margin-top:0;
  }
  .filter-card--compact .field select{
    height:26px;
    font-size:12px;
  }

  .mini-kpi{
    background:#f8fafc;
    border:1px solid var(--sa-gris-borde,#e5e7eb);
    border-radius:12px;
    padding:4px 8px;
  }
  .mini-kpi h4{
    margin:0 0 2px;
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.04em;
    color:#4b5563;
  }
  .mini-kpi .v{
    font-weight:800;
    font-size:20px;
    color:var(--sa-text,#064066);
  }

  .search-card{
    display:grid;
    grid-template-columns:minmax(0,3fr) auto;
    gap:10px;
    align-items:center;
  }

  /* Barra de bÃºsqueda */
  .searchbox{position:relative}
  .searchbox input{
    width:100%;
    height:40px;
    padding:10px 38px 10px 34px;
    border:1px solid #e5e7eb;
    border-radius:12px;
    font-size:14px;
  }
  .searchbox .ico{
    position:absolute;
    left:10px;
    top:50%;
    transform:translateY(-50%);
    opacity:.55;
  }
  .searchbox .clear{
    position:absolute;
    right:8px;
    top:50%;
    transform:translateY(-50%);
    border:0;
    background:transparent;
    cursor:pointer;
    opacity:.65;
    font-size:14px;
  }

  /* Slider doble compacto */
  .range-wrap{
    position:relative;
    height:22px;
    margin-top:0;
  }
  .range-wrap input[type=range]{
    position:absolute;
    left:0;right:0;
    top:4px;
    width:100%;
    pointer-events:none;
    background:transparent;
    -webkit-appearance:none;
  }
  .range-wrap input[type=range]::-webkit-slider-thumb{
    pointer-events:auto;
    -webkit-appearance:none;
    height:14px;width:14px;
    border-radius:50%;
    background:var(--sa-azul-btn,#5274ce);
    border:2px solid #fff;
    box-shadow:0 0 0 1px rgba(0,0,0,.08);
  }
  .range-wrap input[type=range]::-moz-range-thumb{
    pointer-events:auto;
    height:14px;width:14px;
    border:0;
    border-radius:50%;
    background:var(--sa-azul-btn,#5274ce);
  }
  .range-track{
    position:absolute;
    left:0;right:0;
    top:8px;
    height:4px;
    background:#e5e7eb;
    border-radius:999px;
  }
  .range-fill{
    position:absolute;
    top:8px;
    height:4px;
    background:#c7d2fe;
    border-radius:999px;
  }

  /* Chips */
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{
    border:1px solid #e5e7eb;
    background:#fff;
    border-radius:999px;
    padding:6px 10px;
    font-size:12px;
    cursor:pointer;
  }
  .chip.is-on{
    background:#e0e7ff;
    border-color:#c7d2fe;
    color:#1f3a8a;
  }

  /* Tabla */
  .table-wrap{
    overflow:auto;
    max-height:55vh;
    border:1px solid var(--sa-gris-borde,#e5e7eb);
    border-radius:12px;
  }
  table.table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
    table-layout:fixed;
  }
  .table th,.table td{
    border-bottom:1px solid var(--sa-gris-borde,#e5e7eb);
    padding:6px 10px;
    vertical-align:middle;
    line-height:1.2;
  }
  .table th{
    background:#f8fafc;
    position:sticky;
    top:0;
    z-index:1;
    text-align:left;
  }

  .table th:nth-child(1), .table td:nth-child(1){
    width:9ch;
    white-space:nowrap;
  }
  .table th:nth-child(2), .table td:nth-child(2){
    width:24%;
  }
  .table th:nth-child(3), .table td:nth-child(3){
    width:30%;
  }
  .table th:nth-child(4), .table td:nth-child(4){
    width:15ch;
    white-space:nowrap;
  }
  .table th:nth-child(5), .table td:nth-child(5){
    width:12ch;
    white-space:nowrap;
  }
  .table th:nth-child(6), .table td:nth-child(6){
    width:10ch;
    white-space:nowrap;
    text-align:center;
  }

  .table td{
    max-height:38px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }

  .link-ico{text-decoration:none}
  .link-ico:hover{text-decoration:underline}

  /* PaginaciÃ³n */
  .pager{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-top:10px;
    gap:12px;
    flex-wrap:wrap;
  }
  .pill{
    display:inline-block;
    border:1px solid #e5e7eb;
    background:#f8fafc;
    border-radius:999px;
    padding:3px 8px;
    font-size:12px;
  }

  .page-size-select{
    border:1px solid #e5e7eb;
    background:#f8fafc;
    border-radius:999px;
    padding:2px 6px;
    font-size:12px;
    height:28px;
  }

  .loading{
    display:none;
    align-items:center;
    gap:8px;
    font-size:14px;
    color:#374151;
  }
  .loading.show{display:flex}

  @media (max-width:1200px){
    .filters-grid{grid-template-columns:1fr 1fr}
    .search-card{grid-template-columns:1fr}
    .upload-grid{grid-template-columns:1fr}
    .upload-meta{text-align:left}
    .upload-actions{justify-content:flex-start}
  }
</style>
{% endblock %}

{% block content %}
<div class="container-xxl py-4">
  <h1 class="mb-1">Buscador</h1>

  <!-- RegiÃ³n de avisos accesible -->
  <div aria-live="polite" aria-atomic="true">
    {% if toast %}
    <div id="oppToast" class="toast" role="status">
      <span>âœ… {{ toast }}</span>
      <button type="button" class="toast-close" aria-label="Cerrar aviso">&times;</button>
    </div>
    {% endif %}
  </div>

  <!-- Upload -->
  <div class="card mb-4 upload-card">
    <div class="upload-header">
      <div>
        <h2 class="upload-title">Archivo - Reporte de Oportunidades</h2>
      </div>

      <div class="upload-meta">
        <div class="badges" aria-label="Estado del maestro">
          {% if opp.has_file %}
            <span>Ãšltima act.: {{ opp.last_updated_str }}</span>
            {% if opp.rows is not none %}<span>Filas: {{ opp.rows }}</span>{% endif %}
          {% else %}
            <span>Sin archivo</span>
          {% endif %}
        </div>
      </div>
    </div>

    <form
      class="upload-grid"
      action="/oportunidades/buscador/upload"
      method="post"
      enctype="multipart/form-data"
      aria-label="Cargar archivo maestro de oportunidades"
    >
      <div class="upload-file">
        <label for="oppFile" class="muted small" style="font-weight:600">Archivo (.xlsx / .xls)</label>
        <div class="field">
          <input id="oppFile" type="file" name="file" accept=".xlsx,.xls" />
        </div>
      </div>

      <div class="upload-actions">
        <button class="btn" type="submit" id="btnUpload">Subir y reemplazar</button>

        <div class="loading" id="upLoading" role="status" aria-live="polite">
          <span>Procesandoâ€¦</span>
        </div>

        <button
          class="btn-link"
          type="button"
          id="btnDownloadCurrent"
          title="Descargar maestro actual"
          hidden
        >
          Descargar actual
        </button>
      </div>
    </form>
  </div>

  <!-- Dashboard -->
  <div class="card" style="border-color:#c7d2fe;">
    <div class="topbar mb-3">
      <div class="filters-grid" role="group" aria-label="Filtros de bÃºsqueda">
        <!-- Fecha -->
        <div class="filter-card filter-card--fecha" aria-labelledby="lblFecha">
          <h5 id="lblFecha">Fecha</h5>

          <div class="date-row">
            <label class="date-field">
              <span>Desde</span>
              <input id="fDateFrom" type="date" aria-label="Fecha desde">
            </label>
            <label class="date-field">
              <span>Hasta</span>
              <input id="fDateTo" type="date" aria-label="Fecha hasta">
            </label>
          </div>

          <div class="range-wrap" aria-hidden="false" aria-label="Rango de fechas (slider)">
            <div class="range-track"></div>
            <div class="range-fill" id="dateFill"></div>
            <input type="range" id="fRangeMin" min="0" max="100" value="0" step="1" aria-label="LÃ­mite inferior">
            <input type="range" id="fRangeMax" min="0" max="100" value="100" step="1" aria-label="LÃ­mite superior">
          </div>

          <div class="stack" style="justify-content:space-between;margin-top:2px">
            <span class="pill" id="lblFrom">â€”</span>
            <span class="pill" id="lblTo">â€”</span>
          </div>
        </div>

        <!-- Plataforma -->
        <div class="filter-card filter-card--compact">
          <h5>Plataforma</h5>
          <div class="field">
            <select id="fPlataforma" aria-label="Filtrar por plataforma">
              <option value="">Todas</option>
            </select>
          </div>
        </div>

        <!-- Operador -->
        <div class="filter-card filter-card--compact">
          <h5>Operador</h5>
          <div class="field">
            <select id="fOperador" aria-label="Filtrar por operador">
              <option value="">Todos</option>
            </select>
          </div>
        </div>

        <!-- Cuenta -->
        <div class="filter-card filter-card--compact">
          <h5>Cuenta</h5>
          <div class="field">
            <select id="fCuenta" aria-label="Filtrar por cuenta">
              <option value="">Todas</option>
            </select>
          </div>
        </div>

        <!-- ReparticiÃ³n -->
        <div class="filter-card filter-card--compact">
          <h5>ReparticiÃ³n</h5>
          <div class="field">
            <select id="fReparticion" aria-label="Filtrar por reparticiÃ³n">
              <option value="">Todas</option>
            </select>
          </div>
        </div>

        <!-- PAMI / Otras -->
        <div class="filter-card" style="grid-column:1 / span 2">
          <h5>ReparticiÃ³n: PAMI u Otras</h5>
          <div class="chips" id="swPAMI" role="group" aria-label="Filtro PAMI">
            <button type="button" class="chip is-on" data-val="todos" aria-pressed="true">Todos</button>
            <button type="button" class="chip" data-val="pami" aria-pressed="false">PAMI</button>
            <button type="button" class="chip" data-val="otras" aria-pressed="false">Otras</button>
          </div>
        </div>

        <!-- Estado -->
        <div class="filter-card" style="grid-column:3 / span 2">
          <h5>Estado</h5>
          <div class="chips" id="swEstado" role="group" aria-label="Filtro estado">
            <button type="button" class="chip is-on" data-val="todos" aria-pressed="true">Todos</button>
            <button type="button" class="chip" data-val="emergencia" aria-pressed="false">Emergencia</button>
            <button type="button" class="chip" data-val="regular" aria-pressed="false">Regular</button>
          </div>
        </div>

        <!-- KPI Procesos -->
        <div class="mini-kpi" role="status" aria-live="polite"
             aria-label="Cantidad de procesos filtrados"
             style="grid-column:5;align-self:stretch;">
          <h4>Procesos</h4>
          <div class="v" id="kProcesos">0</div>
        </div>
      </div>

      <!-- Buscar -->
      <div class="filter-card search-card" style="margin-top:6px">
        <div class="searchbox">
          <span class="ico" aria-hidden="true">ðŸ”Ž</span>
          <input id="fBuscar" placeholder="Buscar por objetoâ€¦" autocomplete="off" aria-label="Buscar por objeto">
          <button class="clear" id="fClear" type="button" title="Limpiar bÃºsqueda" aria-label="Limpiar bÃºsqueda">âœ•</button>
        </div>
        <div class="stack" style="justify-content:flex-end">
          <button class="btn" id="btnAplicar" type="button">Aplicar filtros</button>
          <button class="btn-link" id="btnLimpiar" type="button" title="Restablecer filtros">Limpiar</button>
          <button class="btn-link" id="btnExport" type="button" title="Exportar resultados visibles a CSV">Exportar CSV</button>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="table-wrap" role="region" aria-label="Resultados de oportunidades">
      <table class="table" id="oppTable" role="table">
        <thead>
          <tr role="row">
            <th scope="col">NÃºmero</th>
            <th scope="col">ReparticiÃ³n</th>
            <th scope="col">Objeto</th>
            <th scope="col">Apertura</th>
            <th scope="col">Tipo</th>
            <th scope="col">Enlace de pliego</th>
          </tr>
        </thead>
        <tbody id="oppTBody">
          {% for row in table_rows %}
          {% set numero =
              row.get('NÃºmero')
              or row.get('NÂ° Proceso')
              or row.get('Nro Proceso')
              or row.get('Proceso')
          %}
          {% set reparticion =
              row.get('ReparticiÃ³n')
              or row.get('Comprador')
              or row.get('Entidad Contratante')
              or row.get('Organismo')
          %}
          {% set objeto =
              row.get('Objeto')
              or row.get('Objeto / DescripciÃ³n')
              or row.get('DescripciÃ³n')
          %}
          {% set apertura_txt =
              row.get('Apertura')
              or row.get('Fecha LÃ­mite')
              or row.get('Fecha de Cierre')
              or row.get('Fecha de Apertura')
              or row.get('Fecha')
          %}
          {% set tipo =
              row.get('Tipo')
              or row.get('Modalidad')
              or row.get('Procedimiento')
          %}
          {% set plataforma =
              row.get('Plataforma')
              or row.get('Portal')
          %}
          {% set operador =
              row.get('Operador')
              or row.get('Responsable')
          %}
          {% set cuenta =
              row.get('Cuenta')
              or row.get('NÃºmero')
          %}
          {% set uape =
              row.get('NÂ° UAPE')
              or row.get('Unidad Compra')
              or row.get('Cod. UAPE')
          %}
          {% set estado_raw =
              row.get('Estado')
              or row.get('Tipo Proceso')
              or row.get('CarÃ¡cter')
          %}
          {% set enlace =
              row.get('Enlace de pliego')
              or row.get('Enlace')
              or row.get('URL')
              or row.get('Link')
          %}

          <tr
            data-numero="{{ numero|e }}"
            data-reparticion="{{ reparticion|e }}"
            data-objeto="{{ objeto|e }}"
            data-apertura="{{ apertura_txt|e }}"
            data-tipo="{{ tipo|e }}"
            data-plataforma="{{ plataforma|e }}"
            data-operador="{{ operador|e }}"
            data-cuenta="{{ cuenta|e }}"
            data-uape="{{ uape|e }}"
            data-estado="{{ estado_raw|e }}"
          >
            <td title="{{ numero }}">{{ numero }}</td>
            <td title="{{ reparticion }}">{{ reparticion }}</td>
            <td title="{{ objeto }}">{{ objeto }}</td>
            <td title="{{ apertura_txt }}">{{ apertura_txt }}</td>
            <td title="{{ tipo }}">{{ tipo }}</td>
            <td>
              {% if enlace %}
                <a class="link-ico"
                   href="{{ enlace }}"
                   target="_blank"
                   rel="noopener noreferrer"
                   title="Abrir pliego en nueva pestaÃ±a">ðŸ”—</a>
              {% else %}
                <span class="muted">â€”</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}

          {% if table_rows|length == 0 %}
            <tr><td class="muted" colspan="6">Sin resultados para los filtros actuales.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- PaginaciÃ³n -->
    <div class="pager" role="navigation" aria-label="PaginaciÃ³n">
      <div class="muted">
        Mostrando <span id="showFrom">0</span>â€“<span id="showTo">0</span> de <span id="totalFound">0</span>
      </div>

      <div class="stack" style="align-items:center">
        <span class="muted small">Filas por pÃ¡gina:</span>
        <select id="pageSizeSelect" class="page-size-select">
          {% set _ps = page_size or 20 %}
          <option value="20"  {% if _ps == 20  %}selected{% endif %}>20</option>
          <option value="50"  {% if _ps == 50  %}selected{% endif %}>50</option>
          <option value="100" {% if _ps == 100 %}selected{% endif %}>100</option>
          <option value="200" {% if _ps == 200 %}selected{% endif %}>200</option>
        </select>
      </div>

      <div class="stack">
        <button class="btn" id="prevPage" type="button" disabled>Anterior</button>
        <span class="muted">PÃ¡gina <span id="curPage">1</span> / <span id="maxPage">1</span></span>
        <button class="btn" id="nextPage" type="button" disabled>Siguiente</button>
      </div>
    </div>
  </div>
</div>

<!-- Config inicial para el JS -->
<script>
  window.OPP_UI = {
    pageSize: {{ page_size or 20 }},
    initialDateFrom: null,
    initialDateTo: null,
    els: {
      file: 'oppFile',
      drop: 'oppDrop',
      btnUpload: 'btnUpload',
      upLoading: 'upLoading',
      buscar: 'fBuscar',
      clear: 'fClear',
      aplicar: 'btnAplicar',
      limpiar: 'btnLimpiar',
      export: 'btnExport',
      downloadCurrent: 'btnDownloadCurrent',
      plataforma: 'fPlataforma',
      operador: 'fOperador',
      cuenta: 'fCuenta',
      reparticion: 'fReparticion',
      swPAMI: 'swPAMI',
      swEstado: 'swEstado',
      dateFrom: 'fDateFrom',
      dateTo: 'fDateTo',
      rMin: 'fRangeMin',
      rMax: 'fRangeMax',
      rFill: 'dateFill',
      lblFrom: 'lblFrom',
      lblTo: 'lblTo',
      kProcesos: 'kProcesos',
      table: 'oppTable',
      tbody: 'oppTBody',
      pagerPrev: 'prevPage',
      pagerNext: 'nextPage',
      showFrom: 'showFrom',
      showTo: 'showTo',
      totalFound: 'totalFound',
      curPage: 'curPage',
      maxPage: 'maxPage',
      pageSizeSelect: 'pageSizeSelect'
    }
  };

  document.addEventListener('DOMContentLoaded', function () {
    var toast = document.getElementById('oppToast');
    if (toast) {
      var btn = toast.querySelector('.toast-close');
      if (btn) {
        btn.addEventListener('click', function () {
          toast.style.display = 'none';
        });
      }
    }

    var sel = document.getElementById('pageSizeSelect');
    if (sel) {
      sel.addEventListener('change', function () {
        var v = parseInt(this.value, 10) || 20;
        if (window.OPP_UI) {
          window.OPP_UI.pageSize = v;
        }
        if (window.OPP && typeof window.OPP.refreshPageSize === 'function') {
          window.OPP.refreshPageSize(v);
        } else {
          document.dispatchEvent(
            new CustomEvent('opp:pageSizeChanged', { detail: { pageSize: v } })
          );
        }
      });
    }
  });
</script>
<script src="{{ url_for('static', path='/js/oportunidades_buscador.js') }}" defer></script>
{% endblock %}
