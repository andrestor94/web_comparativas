{% extends "base.html" %}
{% block title %}Oportunidades ‚Äì Buscador{% endblock %}

{% block extra_head %}
<style>
  /* ====== Layout & tokens ====== */
  .muted{color:#6b7280}
  .card{background:var(--sa-blanco,#fff);border:1px solid var(--sa-gris-borde,#e5e7eb);border-radius:14px;padding:18px}
  .btn{background:var(--sa-azul-btn,#5274ce);color:#fff;border:0;border-radius:10px;padding:8px 14px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn-link{background:transparent;border:0;color:var(--sa-azul-btn,#5274ce);cursor:pointer}
  .stack{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .field input,.field select{width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:9px 10px;background:#fff}
  .badges>span{display:inline-block;background:#eef2f7;border:1px solid #e5e7eb;padding:4px 8px;border-radius:999px;font-size:12px;margin-left:6px}

  /* ====== KPIs ====== */
  .kpis{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:12px}
  .kpi{background:var(--sa-blanco,#fff);border:1px solid var(--sa-gris-borde,#e5e7eb);border-radius:12px;padding:14px}
  .kpi h4{margin:0;font-size:12px;color:#446;opacity:.8}
  .kpi .v{font-size:22px;font-weight:700;margin-top:4px;color:var(--sa-text,#064066)}

  /* ====== Filtros estilo ‚Äútarjetas‚Äù ====== */
  .filters-grid{display:grid;grid-template-columns:320px repeat(4,minmax(0,1fr));gap:12px}
  .filter-card{background:#f8fafc;border:1px solid var(--sa-gris-borde,#e5e7eb);border-radius:14px;padding:12px}
  .filter-card h5{font-size:12px;margin:0 0 6px;color:#4b5563}
  .search-card{grid-column:1/-1;display:grid;grid-template-columns:1fr 140px;gap:10px}
  .searchbox{position:relative}
  .searchbox input{width:100%;padding:10px 38px 10px 36px;border:1px solid #e5e7eb;border-radius:12px}
  .searchbox .ico{position:absolute;left:10px;top:50%;transform:translateY(-50%);opacity:.55}
  .searchbox .clear{position:absolute;right:8px;top:50%;transform:translateY(-50%);border:0;background:transparent;cursor:pointer;opacity:.65}

  /* ====== Slider de fechas (dos manijas) ====== */
  .range-wrap{position:relative;height:36px}
  .range-wrap input[type=range]{position:absolute;left:0;right:0;top:12px;width:100%;pointer-events:none;background:transparent;-webkit-appearance:none}
  .range-wrap input[type=range]::-webkit-slider-thumb{pointer-events:auto;-webkit-appearance:none;height:16px;width:16px;border-radius:50%;background:var(--sa-azul-btn,#5274ce);border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.08)}
  .range-wrap input[type=range]::-moz-range-thumb{pointer-events:auto;height:16px;width:16px;border:0;border-radius:50%;background:var(--sa-azul-btn,#5274ce)}
  .range-track{position:absolute;left:0;right:0;top:19px;height:4px;background:#e5e7eb;border-radius:999px}
  .range-fill{position:absolute;top:19px;height:4px;background:#c7d2fe;border-radius:999px}

  /* ====== Tabla ====== */
  .table-wrap{overflow:auto;max-height:55vh;border:1px solid var(--sa-gris-borde,#e5e7eb);border-radius:12px}
  table.table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid var(--sa-gris-borde,#e5e7eb);padding:9px 10px;vertical-align:top}
  .table th{background:#f8fafc;position:sticky;top:0;z-index:1;text-align:left}
  .link-ico{text-decoration:none}
  .link-ico:hover{text-decoration:underline}

  /* ====== Paginaci√≥n/estado ====== */
  .pager{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
  .pill{display:inline-block;border:1px solid #e5e7eb;background:#f8fafc;border-radius:999px;padding:4px 10px;font-size:12px}
  @media (max-width:1200px){
    .filters-grid{grid-template-columns:1fr 1fr}
  }
</style>
{% endblock %}

{% block content %}
<div class="container-xxl py-4">
  <h1 class="mb-3">Oportunidades ¬∑ Buscador</h1>
  <p class="muted">Primero carg√° el archivo maestro (Excel). Cada carga <b>reemplaza</b> el anterior.</p>

  {% if toast %}
  <div style="border:1px solid #a7f3d0;background:#ecfdf5;color:#065f46;padding:10px 12px;border-radius:10px;margin-bottom:12px;">
    ‚úÖ {{ toast }}
  </div>
  {% endif %}

  <!-- Upload -->
  <div class="card mb-4">
    <form class="stack" action="/oportunidades/buscador/upload" method="post" enctype="multipart/form-data">
      <input type="file" name="file" accept=".xlsx,.xls" />
      <button class="btn" type="submit">Subir y reemplazar</button>
      <div class="badges">
        {% if opp.has_file %}
          <span>√öltima act.: {{ opp.last_updated_str }}</span>
          {% if opp.rows is not none %}<span>Filas: {{ opp.rows }}</span>{% endif %}
        {% else %}
          <span>Sin archivo</span>
        {% endif %}
      </div>
    </form>
    <p class="muted" style="margin:8px 0 0;">Solo .xlsx/.xls. Al subir, el archivo anterior se elimina y se usa como fuente del dashboard.</p>
  </div>

  <!-- Dashboard -->
  <div class="card" style="border-color:#c7d2fe;">
    <h2 class="mb-3">Dashboard</h2>

    <!-- KPIs -->
    <div class="kpis mb-3">
      <div class="kpi"><h4>Total oportunidades</h4><div class="v">{{ kpis.total_rows }}</div></div>
      <div class="kpi"><h4>Compradores</h4><div class="v">{{ kpis.buyers }}</div></div>
      <div class="kpi"><h4>Plataformas</h4><div class="v">{{ kpis.platforms }}</div></div>
      <div class="kpi"><h4>Provincias/Municipios</h4><div class="v">{{ kpis.provinces }}</div></div>
      <div class="kpi"><h4>Presupuesto total</h4><div class="v">$ {{ "{:,.2f}".format(kpis.budget_total).replace(",", "X").replace(".", ",").replace("X", ".") }}</div></div>
      <div class="kpi"><h4>Rango de fechas</h4><div class="v">{{ kpis.date_min }}‚Äì{{ kpis.date_max }}</div></div>
    </div>

    <!-- FILTROS ‚Äúoriginal‚Äù -->
    <div class="filters-grid mb-3">
      <!-- Fecha: doble manija -->
      <div class="filter-card">
        <h5>Fecha</h5>
        <div class="stack" style="justify-content:space-between">
          <input id="fDateFrom" type="date" style="width:48%">
          <input id="fDateTo" type="date" style="width:48%">
        </div>
        <div class="range-wrap" style="margin-top:8px">
          <div class="range-track"></div>
          <div class="range-fill" id="dateFill"></div>
          <input type="range" id="fRangeMin" min="0" max="100" value="0" step="1">
          <input type="range" id="fRangeMax" min="0" max="100" value="100" step="1">
        </div>
        <div class="stack" style="justify-content:space-between;margin-top:6px">
          <span class="pill" id="lblFrom">‚Äî</span>
          <span class="pill" id="lblTo">‚Äî</span>
        </div>
      </div>

      <!-- Plataforma -->
      <div class="filter-card">
        <h5>Plataforma</h5>
        <div class="field"><select id="fPlataforma"><option value="">Todas</option></select></div>
      </div>

      <!-- Operador -->
      <div class="filter-card">
        <h5>Operador</h5>
        <div class="field"><select id="fOperador"><option value="">Todos</option></select></div>
      </div>

      <!-- Cuenta (N¬∞ UAPE) -->
      <div class="filter-card">
        <h5>Cuenta</h5>
        <div class="field"><select id="fCuenta"><option value="">Todas</option></select></div>
      </div>

      <!-- Repartici√≥n -->
      <div class="filter-card">
        <h5>Repartici√≥n</h5>
        <div class="field"><select id="fReparticion"><option value="">Todas</option></select></div>
      </div>

      <!-- Buscar por Objeto -->
      <div class="filter-card search-card">
        <div class="searchbox">
          <span class="ico">üîé</span>
          <input id="fBuscar" placeholder="Buscar por objeto‚Ä¶">
          <button class="clear" id="fClear" title="Limpiar">‚úï</button>
        </div>
        <div class="stack" style="justify-content:flex-end">
          <button class="btn" id="btnAplicar" type="button">Aplicar filtros</button>
          <button class="btn-link" id="btnLimpiar" type="button">Limpiar</button>
        </div>
      </div>
    </div>

    <!-- TABLA -->
    <div class="table-wrap">
      <table class="table" id="oppTable">
        <thead>
          <tr>
            <th>N√∫mero</th>
            <th>Repartici√≥n</th>
            <th>Objeto</th>
            <th>Apertura</th>
            <th>Tipo</th>
            <th>Enlace de pliego</th>
          </tr>
        </thead>
        <tbody id="oppTBody">
          {% for row in table_rows %}
          <tr
            data-numero="{{ row.get('N√∫mero','')|e }}"
            data-reparticion="{{ row.get('Repartici√≥n','')|e }}"
            data-objeto="{{ row.get('Objeto','')|e }}"
            data-apertura="{{ row.get('Apertura','')|e }}"
            data-tipo="{{ row.get('Tipo','')|e }}"
            data-plataforma="{{ row.get('Plataforma','')|e }}"
            data-operador="{{ row.get('Operador','')|e }}"
            data-cuenta="{{ row.get('N¬∞ UAPE','')|e }}"
          >
            <td>{{ row.get('N√∫mero','') }}</td>
            <td>{{ row.get('Repartici√≥n','') }}</td>
            <td>{{ row.get('Objeto','') }}</td>
            <td>{{ row.get('Apertura','') }}</td>
            <td>{{ row.get('Tipo','') }}</td>
            <td>
              {% set link = row.get('Enlace de pliego','') %}
              {% if link %}
                <a class="link-ico" href="{{ link }}" target="_blank" rel="noopener">üîó</a>
              {% else %}
                <span class="muted">‚Äî</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
          {% if table_rows|length == 0 %}
            <tr><td class="muted" colspan="6">Sin resultados para los filtros actuales.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- PAGINACI√ìN / ESTADO -->
    <div class="pager">
      <div class="muted">
        Mostrando <span id="showFrom">0</span>‚Äì<span id="showTo">0</span> de <span id="totalFound">0</span>
      </div>
      <div class="stack">
        <button class="btn" id="prevPage" type="button">Anterior</button>
        <span class="muted">P√°gina <span id="curPage">1</span> / <span id="maxPage">1</span></span>
        <button class="btn" id="nextPage" type="button">Siguiente</button>
      </div>
    </div>
  </div>
</div>

<!-- Config inicial para el JS -->
<script>
  window.OPP_UI = {
    pageSize: {{ page_size or 20 }},
    // Si quer√©s forzar un rango inicial, pod√©s completar estas dos l√≠neas:
    initialDateFrom: null,
    initialDateTo: null
  };
</script>
<script src="{{ url_for('static', path='/js/oportunidades_buscador.js') }}"></script>
{% endblock %}
