{% extends "base.html" %}
{% block title %}Buscador{% endblock %}

{% block extra_head %}
<style>
  .muted{color:#6b7280;font-size:14px}
  .muted.small{font-size:13px}
  .card{
    background:var(--sa-blanco,#fff);
    border:1px solid var(--sa-gris-borde,#e5e7eb);
    border-radius:14px;
    padding:16px 18px;
    box-shadow:0 1px 2px rgba(15,23,42,.04);
  }
  .btn{
    background:var(--sa-azul-btn,#5274ce);
    color:#fff;
    border:0;
    border-radius:10px;
    padding:8px 12px;
    cursor:pointer;
    font-size:14px;
  }
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn-link{
    background:transparent;
    border:0;
    color:var(--sa-azul-btn,#5274ce);
    cursor:pointer;
    font-size:14px;
  }
  .stack{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .field input,.field select{
    width:100%;
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:8px 10px;
    background:#fff;
    font-size:14px;
  }
  .badges>span{
    display:inline-block;
    background:#eef2f7;
    border:1px solid #e5e7eb;
    padding:4px 8px;
    border-radius:999px;
    font-size:12px;
    margin-left:6px;
  }

  /* --------- Upload limpio --------- */
  .upload-card{display:flex;flex-direction:column;gap:10px}
  .upload-header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:16px;
  }
  .upload-title{font-size:16px;font-weight:600;margin:0;color:#111827}
  .upload-sub{margin:2px 0 0;font-size:13px}
  .upload-meta{text-align:right;font-size:12px}
  .upload-meta .badges{margin-top:4px}
  .upload-grid{
    display:grid;
    grid-template-columns:minmax(0,3fr) auto;
    gap:12px;
    align-items:center;
  }
  /* Ocultamos la columna de drag & drop para no mostrar el bloque grande */
  .upload-drop{display:none}
  .upload-file .field{width:100%}
  .upload-actions{
    display:flex;
    align-items:center;
    justify-content:flex-end;
    gap:10px;
  }
  .upload-footer{margin:4px 0 0;font-size:12px}

  /* Barra superior: filtros a la izquierda y Procesos a la derecha */
  .topbar{
    display:grid;
    grid-template-columns:minmax(0,1fr) 150px;
    gap:12px;
    align-items:flex-start;
  }
  .mini-kpi{
    background:#f8fafc;
    border:1px solid var(--sa-gris-borde,#e5e7eb);
    border-radius:12px;
    padding:8px 10px;
  }
  .mini-kpi h4{
    margin:0 0 2px;
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.04em;
    color:#4b5563;
  }
  .mini-kpi .v{
    font-weight:800;
    font-size:20px;
    color:var(--sa-text,#064066);
  }

  /* Filtros: Fecha mÃ¡s ancha, resto mÃ¡s compacto */
  .filters-grid{
    display:grid;
    grid-template-columns:1.4fr repeat(4,0.9fr);
    gap:10px;
  }
  .filter-card{
    background:#f8fafc;
    border:1px solid var(--sa-gris-borde,#e5e7eb);
    border-radius:12px;
    padding:10px;
  }
  .filter-card h5{
    font-size:12px;
    margin:0 0 6px;
    color:#4b5563;
  }

  .search-card{
    grid-column:1/-1;
    display:grid;
    grid-template-columns:minmax(0,3fr) auto;
    gap:10px;
    align-items:center;
  }

  /* Barra de bÃºsqueda: Ã­conos centrados */
  .searchbox{position:relative}
  .searchbox input{
    width:100%;
    height:42px;
    padding:10px 38px 10px 34px;
    border:1px solid #e5e7eb;
    border-radius:12px;
    font-size:14px;
  }
  .searchbox .ico{
    position:absolute;
    left:10px;
    top:50%;
    transform:translateY(-50%);
    opacity:.55;
  }
  .searchbox .clear{
    position:absolute;
    right:8px;
    top:50%;
    transform:translateY(-50%);
    border:0;
    background:transparent;
    cursor:pointer;
    opacity:.65;
    font-size:14px;
  }

  /* Zona drag-and-drop (se mantiene por JS, pero ya no se usa visualmente) */
  .dropzone{
    border:1px dashed #c7d2fe;
    background:#f8fafc;
    border-radius:12px;
    padding:10px 12px;
    font-size:13px;
  }
  .dropzone.is-drag{background:#eef2ff;border-color:#94a3b8}

  /* Slider doble compacto */
  .range-wrap{position:relative;height:32px}
  .range-wrap input[type=range]{
    position:absolute;
    left:0;right:0;
    top:10px;
    width:100%;
    pointer-events:none;
    background:transparent;
    -webkit-appearance:none;
  }
  .range-wrap input[type=range]::-webkit-slider-thumb{
    pointer-events:auto;
    -webkit-appearance:none;
    height:14px;width:14px;
    border-radius:50%;
    background:var(--sa-azul-btn,#5274ce);
    border:2px solid #fff;
    box-shadow:0 0 0 1px rgba(0,0,0,.08);
  }
  .range-wrap input[type=range]::-moz-range-thumb{
    pointer-events:auto;
    height:14px;width:14px;
    border:0;
    border-radius:50%;
    background:var(--sa-azul-btn,#5274ce);
  }
  .range-track{
    position:absolute;
    left:0;right:0;
    top:16px;
    height:4px;
    background:#e5e7eb;
    border-radius:999px;
  }
  .range-fill{
    position:absolute;
    top:16px;
    height:4px;
    background:#c7d2fe;
    border-radius:999px;
  }

  /* Chips (switches) */
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{
    border:1px solid #e5e7eb;
    background:#fff;
    border-radius:999px;
    padding:6px 10px;
    font-size:12px;
    cursor:pointer;
  }
  .chip.is-on{
    background:#e0e7ff;
    border-color:#c7d2fe;
    color:#1f3a8a;
  }

  /* Tabla */
  .table-wrap{
    overflow:auto;
    max-height:55vh;
    border:1px solid var(--sa-gris-borde,#e5e7eb);
    border-radius:12px;
  }
  table.table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
  }
  .table th,.table td{
    border-bottom:1px solid var(--sa-gris-borde,#e5e7eb);
    padding:8px 10px;
    vertical-align:top;
  }
  .table th{
    background:#f8fafc;
    position:sticky;
    top:0;
    z-index:1;
    text-align:left;
  }

  /* Anchos de columnas:
     - NÃºmero, Tipo y Enlace mÃ¡s angostos
     - ReparticiÃ³n y Objeto con mÃ¡s espacio
  */
  .table th:nth-child(1), .table td:nth-child(1){
    width:8ch;
    white-space:nowrap;
  }
  .table th:nth-child(2), .table td:nth-child(2){
    width:26%;
  }
  .table th:nth-child(3), .table td:nth-child(3){
    width:26%;
  }
  .table th:nth-child(4), .table td:nth-child(4){
    width:14ch;
    white-space:nowrap;
  }
  .table th:nth-child(5), .table td:nth-child(5){
    width:10ch;
    white-space:nowrap;
  }
  .table th:nth-child(6), .table td:nth-child(6){
    width:8ch;
    text-align:center;
    white-space:nowrap;
  }

  .link-ico{text-decoration:none}
  .link-ico:hover{text-decoration:underline}

  /* PaginaciÃ³n */
  .pager{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-top:10px;
    gap:12px;
  }
  .pill{
    display:inline-block;
    border:1px solid #e5e7eb;
    background:#f8fafc;
    border-radius:999px;
    padding:3px 8px;
    font-size:12px;
  }

  /* Estado de carga */
  .loading{
    display:none;
    align-items:center;
    gap:8px;
    font-size:14px;
    color:#374151;
  }
  .loading.show{display:flex}

  @media (max-width:1200px){
    .topbar{grid-template-columns:1fr}
    .filters-grid{grid-template-columns:1fr 1fr}
    .search-card{grid-template-columns:1fr}
    .upload-grid{grid-template-columns:1fr}
    .upload-meta{text-align:left}
    .upload-actions{justify-content:flex-start}
  }
</style>
{% endblock %}

{% block content %}
<div class="container-xxl py-3">
  <h1 class="mb-1">Buscador</h1>
  <p class="muted small">Primero cargÃ¡ el archivo maestro (Excel). Cada carga <b>reemplaza</b> el anterior.</p>

  <!-- RegiÃ³n de avisos accesible -->
  <div aria-live="polite" aria-atomic="true">
    {% if toast %}
    <div style="border:1px solid #a7f3d0;background:#ecfdf5;color:#065f46;padding:10px 12px;border-radius:10px;margin-bottom:12px;">
      âœ… {{ toast }}
    </div>
    {% endif %}
  </div>

  <!-- Upload -->
  <div class="card mb-4 upload-card">
    <div class="upload-header">
      <div>
        <h2 class="upload-title">Archivo maestro</h2>
        <p class="muted upload-sub">
          SubÃ­ un Excel con las oportunidades. Cada carga <b>reemplaza</b> el archivo anterior.
        </p>
      </div>

      <div class="upload-meta">
        <div class="badges" aria-label="Estado del maestro">
          {% if opp.has_file %}
            <span>Ãšltima act.: {{ opp.last_updated_str }}</span>
            {% if opp.rows is not none %}<span>Filas: {{ opp.rows }}</span>{% endif %}
          {% else %}
            <span>Sin archivo</span>
          {% endif %}
        </div>
      </div>
    </div>

    <form
      class="upload-grid"
      action="/oportunidades/buscador/upload"
      method="post"
      enctype="multipart/form-data"
      aria-label="Cargar archivo maestro de oportunidades"
    >
      <!-- Mantengo el div para JS, pero oculto visualmente via CSS -->
      <div class="upload-drop">
        <div class="dropzone" id="oppDrop" aria-hidden="true"></div>
      </div>

      <div class="upload-file">
        <label for="oppFile" class="muted small" style="font-weight:600">Archivo (.xlsx / .xls)</label>
        <div class="field">
          <input id="oppFile" type="file" name="file" accept=".xlsx,.xls" />
        </div>
      </div>

      <div class="upload-actions">
        <button class="btn" type="submit" id="btnUpload">Subir y reemplazar</button>

        <div class="loading" id="upLoading" role="status" aria-live="polite">
          <span>Procesandoâ€¦</span>
        </div>

        <button
          class="btn-link"
          type="button"
          id="btnDownloadCurrent"
          title="Descargar maestro actual"
          hidden
        >
          Descargar actual
        </button>
      </div>
    </form>

    <p class="muted upload-footer">
      Al subir, el archivo anterior se elimina y se usa como fuente del dashboard.
    </p>
  </div>

  <!-- Dashboard -->
  <div class="card" style="border-color:#c7d2fe;">
    <div class="topbar mb-3">
      <!-- Filtros (ahora a la izquierda) -->
      <div>
        <div class="filters-grid" role="group" aria-label="Filtros de bÃºsqueda">
          <!-- Fecha -->
          <div class="filter-card" aria-labelledby="lblFecha">
            <h5 id="lblFecha">Fecha</h5>
            <div class="stack" style="justify-content:space-between">
              <input id="fDateFrom" type="date" style="width:48%" aria-label="Fecha desde">
              <input id="fDateTo" type="date" style="width:48%" aria-label="Fecha hasta">
            </div>
            <div class="range-wrap" style="margin-top:6px" aria-hidden="false" aria-label="Rango de fechas (slider)">
              <div class="range-track"></div>
              <div class="range-fill" id="dateFill"></div>
              <input type="range" id="fRangeMin" min="0" max="100" value="0" step="1" aria-label="LÃ­mite inferior">
              <input type="range" id="fRangeMax" min="0" max="100" value="100" step="1" aria-label="LÃ­mite superior">
            </div>
            <div class="stack" style="justify-content:space-between;margin-top:6px">
              <span class="pill" id="lblFrom">â€”</span>
              <span class="pill" id="lblTo">â€”</span>
            </div>
          </div>

          <div class="filter-card">
            <h5>Plataforma</h5>
            <div class="field">
              <select id="fPlataforma" aria-label="Filtrar por plataforma">
                <option value="">Todas</option>
              </select>
            </div>
          </div>

          <div class="filter-card">
            <h5>Operador</h5>
            <div class="field">
              <select id="fOperador" aria-label="Filtrar por operador">
                <option value="">Todos</option>
              </select>
            </div>
          </div>

          <div class="filter-card">
            <h5>Cuenta</h5>
            <div class="field">
              <select id="fCuenta" aria-label="Filtrar por cuenta">
                <option value="">Todas</option>
              </select>
            </div>
          </div>

          <div class="filter-card">
            <h5>ReparticiÃ³n</h5>
            <div class="field">
              <select id="fReparticion" aria-label="Filtrar por reparticiÃ³n">
                <option value="">Todas</option>
              </select>
            </div>
          </div>

          <!-- Switches -->
          <div class="filter-card" style="grid-column:1 / span 2">
            <h5>ReparticiÃ³n: PAMI u Otras</h5>
            <div class="chips" id="swPAMI" role="group" aria-label="Filtro PAMI">
              <button type="button" class="chip is-on" data-val="todos" aria-pressed="true">Todos</button>
              <button type="button" class="chip" data-val="pami" aria-pressed="false">PAMI</button>
              <button type="button" class="chip" data-val="otras" aria-pressed="false">Otras</button>
            </div>
          </div>

          <div class="filter-card" style="grid-column:3 / span 2">
            <h5>Estado</h5>
            <div class="chips" id="swEstado" role="group" aria-label="Filtro estado">
              <button type="button" class="chip is-on" data-val="todos" aria-pressed="true">Todos</button>
              <button type="button" class="chip" data-val="emergencia" aria-pressed="false">Emergencia</button>
              <button type="button" class="chip" data-val="regular" aria-pressed="false">Regular</button>
            </div>
          </div>
        </div>

        <!-- Buscar -->
        <div class="filter-card search-card" style="margin-top:10px">
          <div class="searchbox">
            <span class="ico" aria-hidden="true">ðŸ”Ž</span>
            <input id="fBuscar" placeholder="Buscar por objetoâ€¦" autocomplete="off" aria-label="Buscar por objeto">
            <button class="clear" id="fClear" type="button" title="Limpiar bÃºsqueda" aria-label="Limpiar bÃºsqueda">âœ•</button>
          </div>
          <div class="stack" style="justify-content:flex-end">
            <button class="btn" id="btnAplicar" type="button">Aplicar filtros</button>
            <button class="btn-link" id="btnLimpiar" type="button" title="Restablecer filtros">Limpiar</button>
            <button class="btn-link" id="btnExport" type="button" title="Exportar resultados visibles a CSV">Exportar CSV</button>
          </div>
        </div>
      </div>

      <!-- KPI Procesos (ahora a la derecha) -->
      <div class="mini-kpi" role="status" aria-live="polite" aria-label="Cantidad de procesos filtrados">
        <h4>Procesos</h4>
        <div class="v" id="kProcesos">0</div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="table-wrap" role="region" aria-label="Resultados de oportunidades">
      <table class="table" id="oppTable" role="table">
        <thead>
          <tr role="row">
            <th scope="col">NÃºmero</th>
            <th scope="col">ReparticiÃ³n</th>
            <th scope="col">Objeto</th>
            <th scope="col">Apertura</th>
            <th scope="col">Tipo</th>
            <th scope="col">Enlace de pliego</th>
          </tr>
        </thead>
        <tbody id="oppTBody">
          {% for row in table_rows %}
          {# Normalizamos las columnas para distintos nombres posibles #}
          {% set numero =
              row.get('NÃºmero')
              or row.get('NÂ° Proceso')
              or row.get('Nro Proceso')
              or row.get('Proceso')
          %}
          {% set reparticion =
              row.get('ReparticiÃ³n')
              or row.get('Comprador')
              or row.get('Entidad Contratante')
              or row.get('Organismo')
          %}
          {% set objeto =
              row.get('Objeto')
              or row.get('Objeto / DescripciÃ³n')
              or row.get('DescripciÃ³n')
          %}
          {% set apertura_txt =
              row.get('Apertura')
              or row.get('Fecha LÃ­mite')
              or row.get('Fecha de Cierre')
              or row.get('Fecha de Apertura')
              or row.get('Fecha')
          %}
          {% set tipo =
              row.get('Tipo')
              or row.get('Modalidad')
              or row.get('Procedimiento')
          %}
          {% set plataforma =
              row.get('Plataforma')
              or row.get('Portal')
          %}
          {% set operador =
              row.get('Operador')
              or row.get('Responsable')
          %}

          {# 
            - cuenta => se usa en el filtro "Cuenta" (columna NÃºmero en tu Excel)
            - uape   => se usa para contar Procesos (columna NÂ° UAPE)
          #}
          {% set cuenta =
              row.get('Cuenta')
              or row.get('NÃºmero')
          %}
          {% set uape =
              row.get('NÂ° UAPE')
              or row.get('Unidad Compra')
              or row.get('Cod. UAPE')
          %}

          {% set estado_raw =
              row.get('Estado')
              or row.get('Tipo Proceso')
              or row.get('CarÃ¡cter')
          %}
          {% set enlace =
              row.get('Enlace de pliego')
              or row.get('Enlace')
              or row.get('URL')
              or row.get('Link')
          %}

          <tr
            data-numero="{{ numero|e }}"
            data-reparticion="{{ reparticion|e }}"
            data-objeto="{{ objeto|e }}"
            data-apertura="{{ apertura_txt|e }}"
            data-tipo="{{ tipo|e }}"
            data-plataforma="{{ plataforma|e }}"
            data-operador="{{ operador|e }}"
            data-cuenta="{{ cuenta|e }}"
            data-uape="{{ uape|e }}"
            data-estado="{{ estado_raw|e }}"
          >
            <td>{{ numero }}</td>
            <td>{{ reparticion }}</td>
            <td>{{ objeto }}</td>
            <td>{{ apertura_txt }}</td>
            <td>{{ tipo }}</td>
            <td>
              {% if enlace %}
                <a class="link-ico"
                   href="{{ enlace }}"
                   target="_blank"
                   rel="noopener noreferrer"
                   title="Abrir pliego en nueva pestaÃ±a">ðŸ”—</a>
              {% else %}
                <span class="muted">â€”</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}

          {% if table_rows|length == 0 %}
            <tr><td class="muted" colspan="6">Sin resultados para los filtros actuales.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- PaginaciÃ³n -->
    <div class="pager" role="navigation" aria-label="PaginaciÃ³n">
      <div class="muted">
        Mostrando <span id="showFrom">0</span>â€“<span id="showTo">0</span> de <span id="totalFound">0</span>
      </div>
      <div class="stack">
        <button class="btn" id="prevPage" type="button" disabled>Anterior</button>
        <span class="muted">PÃ¡gina <span id="curPage">1</span> / <span id="maxPage">1</span></span>
        <button class="btn" id="nextPage" type="button" disabled>Siguiente</button>
      </div>
    </div>
  </div>
</div>

<!-- Config inicial para el JS -->
<script>
  window.OPP_UI = {
    pageSize: {{ page_size or 20 }},
    initialDateFrom: null,
    initialDateTo: null,
    els: {
      file: 'oppFile',
      drop: 'oppDrop',
      btnUpload: 'btnUpload',
      upLoading: 'upLoading',
      buscar: 'fBuscar',
      clear: 'fClear',
      aplicar: 'btnAplicar',
      limpiar: 'btnLimpiar',
      export: 'btnExport',
      downloadCurrent: 'btnDownloadCurrent',
      plataforma: 'fPlataforma',
      operador: 'fOperador',
      cuenta: 'fCuenta',
      reparticion: 'fReparticion',
      swPAMI: 'swPAMI',
      swEstado: 'swEstado',
      dateFrom: 'fDateFrom',
      dateTo: 'fDateTo',
      rMin: 'fRangeMin',
      rMax: 'fRangeMax',
      rFill: 'dateFill',
      lblFrom: 'lblFrom',
      lblTo: 'lblTo',
      kProcesos: 'kProcesos',
      table: 'oppTable',
      tbody: 'oppTBody',
      pagerPrev: 'prevPage',
      pagerNext: 'nextPage',
      showFrom: 'showFrom',
      showTo: 'showTo',
      totalFound: 'totalFound',
      curPage: 'curPage',
      maxPage: 'maxPage'
    }
  };
</script>
<script src="{{ url_for('static', path='/js/oportunidades_buscador.js') }}" defer></script>
{% endblock %}
