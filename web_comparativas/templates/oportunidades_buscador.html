{% extends "base.html" %}
{% block title %}Oportunidades â€“ Buscador{% endblock %}

{% block extra_head %}
<style>
  .muted{color:#6b7280}
  .card{background:var(--sa-blanco,#fff);border:1px solid var(--sa-gris-borde,#e5e7eb);border-radius:14px;padding:16px}
  .btn{background:var(--sa-azul-btn,#5274ce);color:#fff;border:0;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn-link{background:transparent;border:0;color:var(--sa-azul-btn,#5274ce);cursor:pointer}
  .stack{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .field input,.field select{width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;background:#fff}
  .badges>span{display:inline-block;background:#eef2f7;border:1px solid #e5e7eb;padding:4px 8px;border-radius:999px;font-size:12px;margin-left:6px}

  /* Barra superior: Procesos + filtros compactos */
  .topbar{display:grid;grid-template-columns:160px 1fr;gap:12px}
  .mini-kpi{background:#f8fafc;border:1px solid var(--sa-gris-borde,#e5e7eb);border-radius:12px;padding:10px}
  .mini-kpi h4{margin:0 0 4px;font-size:12px;color:#4b5563}
  .mini-kpi .v{font-weight:800;font-size:22px;color:var(--sa-text,#064066)}

  .filters-grid{display:grid;grid-template-columns:280px repeat(4,minmax(0,1fr));gap:10px}
  .filter-card{background:#f8fafc;border:1px solid var(--sa-gris-borde,#e5e7eb);border-radius:12px;padding:10px}
  .filter-card h5{font-size:12px;margin:0 0 6px;color:#4b5563}
  .search-card{grid-column:1/-1;display:grid;grid-template-columns:1fr 160px;gap:10px}
  .searchbox{position:relative}
  .searchbox input{width:100%;padding:10px 38px 10px 36px;border:1px solid #e5e7eb;border-radius:12px}
  .searchbox .ico{position:absolute;left:10px;top:50%;transform:translateY(-50%);opacity:.55}
  .searchbox .clear{position:absolute;right:8px;top:50%;transform:translateY(-50%);border:0;background:transparent;cursor:pointer;opacity:.65}

  /* Slider doble compacto */
  .range-wrap{position:relative;height:32px}
  .range-wrap input[type=range]{position:absolute;left:0;right:0;top:10px;width:100%;pointer-events:none;background:transparent;-webkit-appearance:none}
  .range-wrap input[type=range]::-webkit-slider-thumb{pointer-events:auto;-webkit-appearance:none;height:14px;width:14px;border-radius:50%;background:var(--sa-azul-btn,#5274ce);border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.08)}
  .range-wrap input[type=range]::-moz-range-thumb{pointer-events:auto;height:14px;width:14px;border:0;border-radius:50%;background:var(--sa-azul-btn,#5274ce)}
  .range-track{position:absolute;left:0;right:0;top:16px;height:4px;background:#e5e7eb;border-radius:999px}
  .range-fill{position:absolute;top:16px;height:4px;background:#c7d2fe;border-radius:999px}

  /* Switches (botonera de 3 estados) */
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
  .chip.is-on{background:#e0e7ff;border-color:#c7d2fe;color:#1f3a8a}

  /* Tabla */
  .table-wrap{overflow:auto;max-height:55vh;border:1px solid var(--sa-gris-borde,#e5e7eb);border-radius:12px}
  table.table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid var(--sa-gris-borde,#e5e7eb);padding:8px 10px;vertical-align:top}
  .table th{background:#f8fafc;position:sticky;top:0;z-index:1;text-align:left}
  .link-ico{text-decoration:none}
  .link-ico:hover{text-decoration:underline}

  .pager{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
  .pill{display:inline-block;border:1px solid #e5e7eb;background:#f8fafc;border-radius:999px;padding:3px 8px;font-size:12px}
  @media (max-width:1200px){.topbar{grid-template-columns:1fr}.filters-grid{grid-template-columns:1fr 1fr}}
</style>
{% endblock %}

{% block content %}
<div class="container-xxl py-4">
  <h1 class="mb-3">Oportunidades Â· Buscador</h1>
  <p class="muted">Primero cargÃ¡ el archivo maestro (Excel). Cada carga <b>reemplaza</b> el anterior.</p>

  {% if toast %}
  <div style="border:1px solid #a7f3d0;background:#ecfdf5;color:#065f46;padding:10px 12px;border-radius:10px;margin-bottom:12px;">
    âœ… {{ toast }}
  </div>
  {% endif %}

  <!-- Upload -->
  <div class="card mb-4">
    <form class="stack" action="/oportunidades/buscador/upload" method="post" enctype="multipart/form-data">
      <input type="file" name="file" accept=".xlsx,.xls" />
      <button class="btn" type="submit">Subir y reemplazar</button>
      <div class="badges">
        {% if opp.has_file %}
          <span>Ãšltima act.: {{ opp.last_updated_str }}</span>
          {% if opp.rows is not none %}<span>Filas: {{ opp.rows }}</span>{% endif %}
        {% else %}
          <span>Sin archivo</span>
        {% endif %}
      </div>
    </form>
    <p class="muted" style="margin:8px 0 0;">Solo .xlsx/.xls. Al subir, el archivo anterior se elimina y se usa como fuente del dashboard.</p>
  </div>

  <!-- Dashboard: sin KPIs. Procesos + Filtros compactos -->
  <div class="card" style="border-color:#c7d2fe;">
    <div class="topbar mb-3">
      <!-- KPI Procesos (Ãºnicos NÂ° UAPE del conjunto filtrado) -->
      <div class="mini-kpi">
        <h4>Procesos</h4>
        <div class="v" id="kProcesos">0</div>
      </div>

      <!-- Filtros -->
      <div>
        <div class="filters-grid">
          <!-- Fecha -->
          <div class="filter-card">
            <h5>Fecha</h5>
            <div class="stack" style="justify-content:space-between">
              <input id="fDateFrom" type="date" style="width:48%">
              <input id="fDateTo" type="date" style="width:48%">
            </div>
            <div class="range-wrap" style="margin-top:6px">
              <div class="range-track"></div>
              <div class="range-fill" id="dateFill"></div>
              <input type="range" id="fRangeMin" min="0" max="100" value="0" step="1">
              <input type="range" id="fRangeMax" min="0" max="100" value="100" step="1">
            </div>
            <div class="stack" style="justify-content:space-between;margin-top:6px">
              <span class="pill" id="lblFrom">â€”</span>
              <span class="pill" id="lblTo">â€”</span>
            </div>
          </div>

          <div class="filter-card">
            <h5>Plataforma</h5>
            <div class="field"><select id="fPlataforma"><option value="">Todas</option></select></div>
          </div>

          <div class="filter-card">
            <h5>Operador</h5>
            <div class="field"><select id="fOperador"><option value="">Todos</option></select></div>
          </div>

          <div class="filter-card">
            <h5>Cuenta</h5>
            <div class="field"><select id="fCuenta"><option value="">Todas</option></select></div>
          </div>

          <div class="filter-card">
            <h5>ReparticiÃ³n</h5>
            <div class="field"><select id="fReparticion"><option value="">Todas</option></select></div>
          </div>

          <!-- Switches -->
          <div class="filter-card" style="grid-column:1 / span 2">
            <h5>ReparticiÃ³n: PAMI u Otras</h5>
            <div class="chips" id="swPAMI">
              <button type="button" class="chip is-on" data-val="todos">Todos</button>
              <button type="button" class="chip" data-val="pami">PAMI</button>
              <button type="button" class="chip" data-val="otras">Otras</button>
            </div>
          </div>

          <div class="filter-card" style="grid-column:3 / span 2">
            <h5>Estado</h5>
            <div class="chips" id="swEstado">
              <button type="button" class="chip is-on" data-val="todos">Todos</button>
              <button type="button" class="chip" data-val="emergencia">Emergencia</button>
              <button type="button" class="chip" data-val="regular">Regular</button>
            </div>
          </div>
        </div>

        <!-- Buscar -->
        <div class="filter-card search-card" style="margin-top:10px">
          <div class="searchbox">
            <span class="ico">ðŸ”Ž</span>
            <input id="fBuscar" placeholder="Buscar por objetoâ€¦">
            <button class="clear" id="fClear" title="Limpiar">âœ•</button>
          </div>
          <div class="stack" style="justify-content:flex-end">
            <button class="btn" id="btnAplicar" type="button">Aplicar filtros</button>
            <button class="btn-link" id="btnLimpiar" type="button">Limpiar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="table-wrap">
      <table class="table" id="oppTable">
        <thead>
          <tr>
            <th>NÃºmero</th>
            <th>ReparticiÃ³n</th>
            <th>Objeto</th>
            <th>Apertura</th>
            <th>Tipo</th>
            <th>Enlace de pliego</th>
          </tr>
        </thead>
        <tbody id="oppTBody">
          {% for row in table_rows %}
          <tr
            data-numero="{{ row.get('NÃºmero','')|e }}"
            data-reparticion="{{ row.get('ReparticiÃ³n','')|e }}"
            data-objeto="{{ row.get('Objeto','')|e }}"
            data-apertura="{{ row.get('Apertura','')|e }}"
            data-tipo="{{ row.get('Tipo','')|e }}"
            data-plataforma="{{ row.get('Plataforma','')|e }}"
            data-operador="{{ row.get('Operador','')|e }}"
            data-cuenta="{{ row.get('NÂ° UAPE','')|e }}"
            data-estado="{{ row.get('Estado','')|e }}"
          >
            <td>{{ row.get('NÃºmero','') }}</td>
            <td>{{ row.get('ReparticiÃ³n','') }}</td>
            <td>{{ row.get('Objeto','') }}</td>
            <td>{{ row.get('Apertura','') }}</td>
            <td>{{ row.get('Tipo','') }}</td>
            <td>
              {% set link = row.get('Enlace de pliego','') %}
              {% if link %}
                <a class="link-ico" href="{{ link }}" target="_blank" rel="noopener">ðŸ”—</a>
              {% else %}
                <span class="muted">â€”</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
          {% if table_rows|length == 0 %}
            <tr><td class="muted" colspan="6">Sin resultados para los filtros actuales.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- PaginaciÃ³n -->
    <div class="pager">
      <div class="muted">
        Mostrando <span id="showFrom">0</span>â€“<span id="showTo">0</span> de <span id="totalFound">0</span>
      </div>
      <div class="stack">
        <button class="btn" id="prevPage" type="button">Anterior</button>
        <span class="muted">PÃ¡gina <span id="curPage">1</span> / <span id="maxPage">1</span></span>
        <button class="btn" id="nextPage" type="button">Siguiente</button>
      </div>
    </div>
  </div>
</div>

<!-- Config inicial para el JS -->
<script>
  window.OPP_UI = {
    pageSize: {{ page_size or 20 }},
    initialDateFrom: null,
    initialDateTo: null
  };
</script>
<script src="{{ url_for('static', path='/js/oportunidades_buscador.js') }}"></script>
{% endblock %}
