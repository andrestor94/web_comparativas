{% extends "base.html" %}
{% block title %}Inicio – Web Comparativas{% endblock %}

{# Normalizo el rol una sola vez #}
{% set r = (user.role or user.rol or '')|lower %}

{# Acciones rápidas en el header (únicas) #}
{% block toolbar_actions %}
  {% if r in ['admin','analista','supervisor'] %}
    <a class="btn btn-sm btn-primary" href="/cargas/nueva">+ Nueva carga</a>
  {% endif %}
  <a class="btn btn-sm btn-outline-secondary" href="/cargas/historial">Ver historial</a>
  {% if r == 'admin' %}
    <a class="btn btn-sm btn-ghost" href="/usuarios">Usuarios</a>
  {% endif %}
{% endblock %}

{# Avisos compactos en el top #}
{% block notifications %}
  {% if recent_done and recent_done|length > 0 %}
    <div class="alert alert-success alert-dismissible fade show mt-2" role="alert">
      <strong>Listos recientemente:</strong>
      {% for up in recent_done[:3] %}
        <span class="ms-2">• <a href="/tablero/{{ up.id }}" class="alert-link">
          {{ up.proceso_nro or up.id }}
        </a></span>
      {% endfor %}
      {% if recent_done|length > 3 %}
        <span class="ms-2">… <a href="#notificaciones" class="alert-link">ver todas</a></span>
      {% endif %}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
  {% endif %}
{% endblock %}

{% block content %}

<!-- ======= PANEL INICIAL ======= -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="m-0">Panel inicial</h2>
</div>

{# Mensajes de feedback del reset #}
{% if reset_ok %}
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    Procesos reseteados correctamente.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
  </div>
{% elif reset_err %}
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    {{ reset_err }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
  </div>
{% endif %}

<!-- ======= TARJETAS HORIZONTALES ======= -->
<style>
  .kpi-card {
    flex: 1;
    min-width: 200px;
    background: var(--bs-card-bg);
    border-radius: 0.75rem;
    box-shadow: var(--bs-box-shadow-sm);
    padding: 1rem 1.25rem;
    transition: 0.2s ease;
  }
  .kpi-card:hover { transform: translateY(-2px); }
  .kpi-grid { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem; }
  .kpi-title { font-size: 0.875rem; color: var(--bs-secondary); }
  .kpi-value { font-size: 2rem; font-weight: 700; }
  .kpi-sub { font-size: 0.875rem; color: var(--bs-secondary); }

  .action-buttons { display: flex; justify-content: flex-end; gap: 0.5rem; }
</style>

{# ===== KPIs OPORTUNIDADES ===== #}
<div class="d-flex justify-content-between align-items-center mb-2">
  <h5 class="m-0">Oportunidades</h5>
  <a class="btn btn-sm btn-ghost" href="/oportunidades/buscador">Ir al buscador</a>
</div>
<div class="kpi-grid mb-3">
  <div class="kpi-card text-center">
    <div class="kpi-title">Total</div>
    <div class="kpi-value text-primary">{{ opp_total }}</div>
    <div class="kpi-sub">Oportunidades cargadas</div>
  </div>
  <div class="kpi-card text-center">
    <div class="kpi-title">Aceptadas</div>
    <div class="kpi-value text-success">{{ opp_accepted }}</div>
    <div class="kpi-sub">Marcadas como aceptadas</div>
  </div>
  <div class="kpi-card text-center">
    <div class="kpi-title">No vistas</div>
    <div class="kpi-value text-warning">{{ opp_unseen }}</div>
    <div class="kpi-sub">Sin evaluar todavía</div>
  </div>
</div>

{# ===== KPIs PROCESOS ===== #}
<div class="d-flex justify-content-between align-items-center mb-2">
  <h5 class="m-0">Procesos</h5>
</div>
<div class="kpi-grid">
  <div class="kpi-card text-center">
    <div class="kpi-title">Pendientes</div>
    <div class="kpi-value">{{ total_pending }}</div>
    <div class="kpi-sub">Procesos por terminar o revisar</div>
  </div>
  <div class="kpi-card text-center">
    <div class="kpi-title">Completados</div>
    <div class="kpi-value text-success">{{ total_done }}</div>
    <div class="kpi-sub">Procesos listos</div>
  </div>
  <div class="kpi-card text-center">
    <div class="kpi-title">Total cargas</div>
    <div class="kpi-value text-primary">{{ total_all }}</div>
    <div class="kpi-sub">Historial completo</div>
  </div>
</div>
<!-- ======= FIN TARJETAS ======= -->

<div class="grid" style="gap: 16px; grid-template-columns: repeat(12,1fr);">
  <div class="span-12">
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="m-0">Últimos procesados</h5>
          <a class="btn btn-sm btn-ghost" href="/cargas/historial">Ver todos</a>
        </div>

        {% if not last_done or last_done|length == 0 %}
          <div class="text-subtle py-3">Aún no hay cargas completadas.</div>
        {% else %}
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th style="width:90px">ID</th>
                  <th>Proceso</th>
                  <th>Archivo</th>
                  <th style="width:130px">Estado</th>
                  <th class="text-end" style="width:180px">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for up in last_done %}
                  {% set st = (up.status or '')|lower %}
                  <tr>
                    <td>{{ up.id }}</td>
                    <td>
                      <div class="fw-semibold">{{ up.proceso_nro or '—' }}</div>
                      <div class="text-subtle small">
                        {{ up.platform_hint or '' }} {% if up.buyer_hint %}· {{ up.buyer_hint }}{% endif %}
                      </div>
                    </td>
                    <td class="text-truncate" title="{{ up.original_filename }}">{{ up.original_filename or '—' }}</td>
                    <td>
                      <span class="badge bg-success-subtle text-success">
                        {{ step_labels.get(st, 'Listo')|capitalize }}
                      </span>
                    </td>
                    <td class="text-end">
                      <div class="action-buttons">
                        <a class="btn btn-sm btn-primary" href="/tablero/{{ up.id }}">Abrir tablero</a>
                        <a class="btn btn-sm btn-outline-secondary" href="/cargas/{{ up.id }}">Ver estado</a>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% if (total_all|int == 0) %}
  <div class="alert alert-info mt-3" role="alert">
    {% if r in ['admin','analista','supervisor'] %}
      ¡Bienvenido! Aún no hay cargas. Comenzá con tu primera
      <a href="/cargas/nueva" class="alert-link">Nueva carga</a>.
    {% else %}
      ¡Bienvenido! Aún no hay cargas disponibles para mostrar en tu cuenta.
      Accedé al <a href="/cargas/historial" class="alert-link">Historial</a> para ver procesos cuando existan.
    {% endif %}
  </div>
{% endif %}

{# Modal de reseteo de procesos (solo admin) #}
{% if r == 'admin' %}
<div class="modal fade" id="modalResetUploads" tabindex="-1" aria-labelledby="modalResetUploadsLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="/admin/reset_uploads">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="modalResetUploadsLabel">Resetear procesos</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p class="mb-3">
            Esta acción está pensada para limpiar procesos de prueba o rearmar el entorno.
            Los procesos seleccionados se eliminarán de forma permanente.
          </p>
          <p class="small text-muted mb-3">
            Para continuar, confirmá tu contraseña de administrador.
          </p>
          <div class="mb-3">
            <label for="resetPasswordInput" class="form-label">Contraseña</label>
            <input type="password"
                   class="form-control"
                   id="resetPasswordInput"
                   name="password_confirm"
                   autocomplete="current-password"
                   required>
          </div>
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">
            Sí, resetear procesos
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}
