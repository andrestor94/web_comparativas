{% extends "base.html" %}
{% block title %}Inicio – Web Comparativas{% endblock %}

{# Normalizo el rol una sola vez #}
{% set r = (user.role or user.rol or '')|lower %}

{# Acciones rápidas en el header (home sin botones) #}
{% block toolbar_actions %}{% endblock %}

{# Avisos compactos en el top #}
{% block notifications %}
  {% if recent_done and recent_done|length > 0 %}
    <div class="alert alert-success alert-dismissible fade show mt-2" role="alert">
      <strong>Listos recientemente:</strong>
      {% for up in recent_done[:3] %}
        <span class="ms-2">• <a href="/tablero/{{ up.id }}" class="alert-link">
          {{ up.proceso_nro or up.id }}
        </a></span>
      {% endfor %}
      {% if recent_done|length > 3 %}
        <span class="ms-2">… <a href="#notificaciones" class="alert-link">ver todas</a></span>
      {% endif %}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
  {% endif %}
{% endblock %}

{% block content %}

<!-- ======= PANEL INICIAL ======= -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="m-0">Inicio</h2>
</div>

{# Mensajes de feedback del reset #}
{% if reset_ok %}
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    Procesos reseteados correctamente.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
  </div>
{% elif reset_err %}
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    {{ reset_err }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
  </div>
{% endif %}

<!-- ======= TARJETAS HORIZONTALES ======= -->
<style>
  :root{
    /* fallback por si no está definido en base.html */
    --sa-azul:       var(--brand-azul, #064066);
    --sa-azul-alt:   var(--brand-azul-alt, #5274ce);
    --sa-azul-claro: var(--brand-azul-claro, #6886c4);
    --sa-panel-bg:   #f9fafb;
    --sa-borde-soft: #e5e7eb;
  }

  .panel-section{
    background: var(--sa-panel-bg);
    border-radius: 18px;
    padding: 1.25rem 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 3px rgba(15,23,42,0.08);
    border: 1px solid var(--sa-borde-soft);
  }

  .panel-section + .panel-section{
    margin-top: 0.75rem;
  }

  .panel-opp{
    border-top: 4px solid var(--sa-azul-alt);
  }

  .panel-proc{
    border-top: 4px solid var(--sa-azul);
  }

  .panel-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:0.75rem;
  }

  .panel-title{
    font-size:1rem;
    font-weight:600;
    color:var(--sa-azul);
  }

  .panel-subtitle{
    font-size:0.8rem;
    color:#6b7280;
  }

  .kpi-card {
    flex: 1;
    min-width: 220px;
    background: #ffffff;
    border-radius: 0.9rem;
    box-shadow: 0 1px 2px rgba(15,23,42,0.06);
    padding: 0.9rem 1.1rem;
    transition: 0.18s ease;
    border: 1px solid #e5e7eb;
  }

  .kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(15,23,42,0.10);
  }

  .kpi-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .kpi-title {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: .04em;
    color: #6b7280;
    margin-bottom: 0.25rem;
  }

  .kpi-value {
    font-size: 1.9rem;
    font-weight: 700;
    line-height: 1.1;
  }

  .kpi-sub {
    font-size: 0.8rem;
    color: #6b7280;
    margin-top: 0.15rem;
  }

  /* acentos de color */
  .panel-opp .kpi-value{
    color: var(--sa-azul-alt);
  }

  .panel-opp .kpi-card:nth-child(3) .kpi-value{
    color: #d97706; /* No vistas en ámbar suave */
  }

  .panel-proc .kpi-card:nth-child(1) .kpi-value{
    color: var(--sa-azul);
  }
  .panel-proc .kpi-card:nth-child(2) .kpi-value{
    color: #16a34a; /* completados en verde */
  }
  .panel-proc .kpi-card:nth-child(3) .kpi-value{
    color: var(--sa-azul-claro);
  }

  .action-buttons { 
    display: flex; 
    justify-content: flex-end; 
    gap: 0.5rem; 
  }
</style>

{# ===== KPIs OPORTUNIDADES ===== #}
<div class="panel-section panel-opp">
  <div class="panel-header">
    <div>
      <div class="panel-title">Oportunidades</div>
      <div class="panel-subtitle">Resumen rápido del archivo de oportunidades cargado</div>
    </div>
    <a class="btn btn-sm btn-ghost" href="/oportunidades/buscador">Ir al buscador</a>
  </div>
  <div class="kpi-grid">
    <div class="kpi-card text-center">
      <div class="kpi-title">Total</div>
      <div class="kpi-value" id="kOppTotal">{{ opp_total }}</div>
      <div class="kpi-sub">Oportunidades cargadas</div>
    </div>
    <div class="kpi-card text-center">
      <div class="kpi-title">Aceptadas</div>
      <div class="kpi-value" id="kOppAccepted">{{ opp_accepted }}</div>
      <div class="kpi-sub">Marcadas como aceptadas</div>
    </div>
    <div class="kpi-card text-center">
      <div class="kpi-title">No vistas</div>
      <div class="kpi-value" id="kOppUnseen">{{ opp_unseen }}</div>
      <div class="kpi-sub">Sin evaluar todavía</div>
    </div>
  </div>
</div>

{# ===== KPIs PROCESOS ===== #}
<div class="panel-section panel-proc">
  <div class="panel-header">
    <div>
      <div class="panel-title">Procesos</div>
      <div class="panel-subtitle">Estado general de las cargas de Mercado Público</div>
    </div>
  </div>
  <div class="kpi-grid">
    <div class="kpi-card text-center">
      <div class="kpi-title">Pendientes</div>
      <div class="kpi-value">{{ total_pending }}</div>
      <div class="kpi-sub">Procesos por terminar o revisar</div>
    </div>
    <div class="kpi-card text-center">
      <div class="kpi-title">Completados</div>
      <div class="kpi-value">{{ total_done }}</div>
      <div class="kpi-sub">Procesos listos</div>
    </div>
    <div class="kpi-card text-center">
      <div class="kpi-title">Total cargas</div>
      <div class="kpi-value">{{ total_all }}</div>
      <div class="kpi-sub">Historial completo</div>
    </div>
  </div>
</div>
<!-- ======= FIN TARJETAS ======= -->

<div class="grid" style="gap: 16px; grid-template-columns: repeat(12,1fr);">
  <div class="span-12">
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="m-0">Últimos procesados</h5>
          <a class="btn btn-sm btn-ghost" href="/cargas/historial">Ver todos</a>
        </div>

        {% if not last_done or last_done|length == 0 %}
          <div class="text-subtle py-3">Aún no hay cargas completadas.</div>
        {% else %}
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th style="width:90px">ID</th>
                  <th>Proceso</th>
                  <th>Archivo</th>
                  <th style="width:130px">Estado</th>
                  <th class="text-end" style="width:180px">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for up in last_done %}
                  {% set st = (up.status or '')|lower %}
                  <tr>
                    <td>{{ up.id }}</td>
                    <td>
                      <div class="fw-semibold">{{ up.proceso_nro or '—' }}</div>
                      <div class="text-subtle small">
                        {{ up.platform_hint or '' }} {% if up.buyer_hint %}· {{ up.buyer_hint }}{% endif %}
                      </div>
                    </td>
                    <td class="text-truncate" title="{{ up.original_filename }}">{{ up.original_filename or '—' }}</td>
                    <td>
                      <span class="badge bg-success-subtle text-success">
                        {{ step_labels.get(st, 'Listo')|capitalize }}
                      </span>
                    </td>
                    <td class="text-end">
                      <div class="action-buttons">
                        <a class="btn btn-sm btn-primary" href="/tablero/{{ up.id }}">Abrir tablero</a>
                        <a class="btn btn-sm btn-outline-secondary" href="/cargas/{{ up.id }}">Ver estado</a>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    try {
      var totalEl   = document.getElementById("kOppTotal");
      var accEl     = document.getElementById("kOppAccepted");
      var unseenEl  = document.getElementById("kOppUnseen");

      if (!totalEl || !accEl || !unseenEl) return;

      var total = parseInt((totalEl.textContent || "0").trim(), 10);
      if (isNaN(total)) total = 0;

      // Misma clave que usa oportunidades_buscador.js
      var STORAGE_KEY = "wc_opp_decisions_v1_/oportunidades/buscador";
      var raw = window.localStorage ? window.localStorage.getItem(STORAGE_KEY) : null;
      if (!raw) {
        // Si nunca se marcó nada, asumimos todo "no visto"
        accEl.textContent = "0";
        unseenEl.textContent = String(total);
        return;
      }

      var map;
      try {
        map = JSON.parse(raw) || {};
      } catch (e) {
        map = {};
      }

      var accepted = 0;
      var rejected = 0;

      Object.keys(map).forEach(function (k) {
        var v = map[k];
        if (v === "aceptado") accepted++;
        else if (v === "rechazado") rejected++;
      });

      var unseen = total - accepted - rejected;
      if (unseen < 0) unseen = 0;

      accEl.textContent    = String(accepted);
      unseenEl.textContent = String(unseen);
    } catch (err) {
      // En caso de error, no rompemos el panel
      console.error("Error calculando KPIs de oportunidades en Home:", err);
    }
  })();
</script>

{% if (total_all|int == 0) %}
  <div class="alert alert-info mt-3" role="alert">
    {% if r in ['admin','analista','supervisor'] %}
      ¡Bienvenido! Aún no hay cargas. Comenzá con tu primera
      <a href="/cargas/nueva" class="alert-link">Nueva carga</a>.
    {% else %}
      ¡Bienvenido! Aún no hay cargas disponibles para mostrar en tu cuenta.
      Accedé al <a href="/cargas/historial" class="alert-link">Historial</a> para ver procesos cuando existan.
    {% endif %}
  </div>
{% endif %}

{# Modal de reseteo de procesos (solo admin) #}
{% if r == 'admin' %}
<div class="modal fade" id="modalResetUploads" tabindex="-1" aria-labelledby="modalResetUploadsLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="/admin/reset_uploads">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="modalResetUploadsLabel">Resetear procesos</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p class="mb-3">
            Esta acción está pensada para limpiar procesos de prueba o rearmar el entorno.
            Los procesos seleccionados se eliminarán de forma permanente.
          </p>
          <p class="small text-muted mb-3">
            Para continuar, confirmá tu contraseña de administrador.
          </p>
          <div class="mb-3">
            <label for="resetPasswordInput" class="form-label">Contraseña</label>
            <input type="password"
                   class="form-control"
                   id="resetPasswordInput"
                   name="password_confirm"
                   autocomplete="current-password"
                   required>
          </div>
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">
            Sí, resetear procesos
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}
