{% extends "base.html" %}

{% block title %}Tablero ‚Äì Web Comparativas{% endblock %}

{% block extra_head %}
  <!-- Fuente Outfit -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --sa-azul:#064066;
      --sa-azul-btn:#5274ce;
      --sa-gris-soft:#eef2f7;
      --sa-gris-borde:#e5e7eb;
      --sa-blanco:#ffffff;
      --sa-text:#064066;
      --sa-amarillo:#eeede8;

      --search-hit-bg:#e6f8ff;

      /* alturas */
      --chart-bar-height:300px;
      --chart-donut-height:260px;
      --chart-treemap-height:340px;
      --chart-half-height:260px;

      /* Columna descripci√≥n compacta */
      --desc-col-w:160px;

      /* Anchuras para columnas fijas y subcolumnas */
      --col-nro-w:44px;
      --cant-col-w:90px;
      --w-price:110px;
      --w-rel:90px;
      --w-asig:84px;
      --w-prov:180px;

      /* offset din√°mico para segunda fila del thead (se setea por JS) */
      --head-row1-h: 40px;

      /* degrad√© suave */
      --grad-soft: linear-gradient(180deg,#f6f9fc 0%, #ffffff 85%);
    }

    #fitContainer.compact{
      --chart-bar-height:220px;
      --chart-donut-height:200px;
      --chart-treemap-height:260px;
      --chart-half-height:200px;
    }

    /* CONTENEDOR AJUSTABLE (para zoom/fit) */
    .fit-container{
      --fit-scale:1;
      transform-origin: top left;
    }
    .fit-container.scaled{
      transform: scale(var(--fit-scale));
    }

    /* Tipograf√≠a & base */
    body{
      font-family:"Outfit", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color:var(--sa-text);
      font-weight:300
    }

    /* Controles (toolbar arriba) */
    .mini-toggle{background:var(--sa-gris-soft);border:1px solid var(--sa-gris-borde);border-radius:.5rem;padding:.25rem;display:inline-flex;gap:.25rem}
    .mini-toggle .mini-btn{border:0;background:transparent;padding:.35rem .6rem;border-radius:.4rem;font-size:.85rem;color:var(--sa-text);cursor:pointer}
    .mini-toggle .mini-btn.active{background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.06)}

    /* versi√≥n m√°s chiquita para el treemap */
    .mini-toggle.tiny{
      padding:.15rem;
    }
    .mini-toggle.tiny .mini-btn{
      padding:.18rem .45rem;
      font-size:.75rem;
    }

    /* Controles locales en zona de tabla (fallback si no existe el toolbar) */
    .mini-group{
      display: inline-flex;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 9999px;
      overflow: hidden;
    }
    .mini-group .mini-btn{
      border: 0;
      background: transparent;
      padding: 4px 14px;
      font-size: 0.75rem;
      color: #064066;
      cursor: pointer;
    }
    .mini-group .mini-btn.active{
      background: #dce3ee;
      font-weight: 600;
    }

    /* ===== Encabezado ===== */
    .process-header{
      background:#fff;
      border-radius:.9rem;
      box-shadow:0 1px 2px rgba(0,0,0,.06);
      padding:1rem 1.2rem;
      display:grid;
      grid-template-columns:1fr auto;
      gap:.9rem 1rem;
      align-items:start;
      border:1px solid var(--sa-gris-borde)
    }
    @media (max-width:992px){
      .process-header{grid-template-columns:1fr}
    }

    .ph-left{min-width:0}
    .ph-title{display:flex;align-items:baseline;gap:.6rem;flex-wrap:wrap;color:var(--sa-azul)}
    .ph-title .label{font-size:1.05rem;letter-spacing:.02em;text-transform:uppercase;font-weight:800}
    .ph-title .nro{font-size:1rem;font-weight:400;line-height:1}

    /* Metadatos */
    .ph-meta-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:.5rem .9rem;
      margin-top:.35rem
    }
    .ph-kv{display:flex;flex-direction:column}
    .ph-kv .k{
      font-size:.95rem;
      text-transform:uppercase;
      letter-spacing:.04em;
      color:var(--sa-azul);
      font-weight:800
    }
    .ph-kv .v{
      font-size:.9rem;
      font-weight:300;
      color:var(--sa-text)
    }

    /* Botones de la derecha (Vistas | Descargar normalized) */
    .ph-actions{
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:.5rem;
      flex-wrap:nowrap;
    }
    .ph-actions .btn-primary{
      background:var(--sa-azul-btn)!important;
      border-color:var(--sa-azul-btn)!important
    }
    @media (max-width: 768px){
      .ph-actions{flex-wrap:wrap;}
    }

    /* Layout principal */
    .dashboard-grid{
      display:grid;
      grid-template-columns:repeat(12,minmax(0,1fr));
      gap:1rem;
      align-items:stretch
    }
    .span-6{grid-column:span 6}
    @media (max-width:1200px){
      .dashboard-grid{grid-template-columns:repeat(6,minmax(0,1fr))}
      .span-lg-6{grid-column:span 6!important}
    }
    @media (max-width:768px){
      .dashboard-grid{grid-template-columns:repeat(1,minmax(0,1fr))}
      .span-sm-1{grid-column:span 1!important}
    }

    .pane{display:flex;flex-direction:column;gap:1rem}
    .pane-left{border-right:2px dashed var(--sa-gris-borde);padding-right:.5rem}
    .pane-right{padding-left:.5rem}
    @media (max-width:1200px){
      .pane-left{border-right:0;padding-right:0}
      .pane-right{padding-left:0}
    }

    /* KPI */
    .kpi-group{
      background:#fff;
      border-radius:.75rem;
      box-shadow:0 1px 2px rgba(0,0,0,.06);
      border:1px solid var(--sa-gris-borde);
      padding:.75rem 1rem
    }
    .kpi-group .group-title{
      font-size:.85rem;
      text-transform:uppercase;
      letter-spacing:.04em;
      color:var(--sa-azul);
      font-weight:800;
      margin:.1rem .2rem .6rem
    }
    .kpi-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:.6rem}
    .kpi-grid .kpi-card{
      background-image:var(--grad-soft);
      border:1px solid var(--sa-gris-borde);
      border-radius:.6rem;
      padding:.6rem .75rem
    }
    .kpi-grid .kpi-label{font-size:.78rem;color:var(--sa-text);font-weight:600;text-transform:uppercase}
    .kpi-grid .kpi-value{font-size:1.05rem;font-weight:300;color:var(--sa-text)}

    /* Gr√°ficos */
    .chart-box{
      background:#fff;
      border-radius:.75rem;
      box-shadow:0 1px 2px rgba(0,0,0,.06);
      padding:.75rem 1rem;
      position:relative;
      height:100%;
      display:flex;
      flex-direction:column;
      border:1px solid var(--sa-gris-borde)
    }
    .chart-box .title{
      font-size:.9rem;
      color:var(--sa-azul);
      font-weight:800;
      margin-bottom:.5rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.5rem
    }
    .chart-donut{height:var(--chart-donut-height)}
    .chart-bar{height:var(--chart-bar-height)}
    .chart-treemap{
      /* altura m√≠nima para pantallas bajas */
      min-height: var(--chart-treemap-height);
      /* ocupar todo el alto restante del card */
      flex: 1 1 auto;
      height: auto;
    }
    .chart-donut>canvas,
    .chart-bar>canvas,
    .chart-treemap>canvas{
      width:100%!important;
      height:100%!important;
      display:block;
      cursor:pointer
    }

    .charts-row{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:1rem}
    .charts-row .chart-donut,
    .charts-row .chart-bar{height:var(--chart-half-height)}
    @media (max-width:768px){
      .charts-row{grid-template-columns:1fr}
    }

    /* resaltado de b√∫squeda en la tabla */
    .table-wrap mark.sa-hit{
      background: rgba(0, 194, 255, .35);
      color: #064066;
      border-radius: 4px;
      padding: 0 .15rem;
    }

    /* modo suizo: que se note el proveedor */
    .table-wrap.rank-mode-suizo td.is-suizo,
    .table-wrap.rank-mode-suizo td.is-suizo .asignada-badge,
    .table-wrap.rank-mode-suizo td.is-suizo a{
      color: #064066 !important;
      font-weight: 700;
    }

    /* bloque explicaci√≥n p√©rdidas */
    .loss-explainer {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: .8rem;
      padding: .7rem .9rem .65rem;
      margin-bottom: 1rem;
    }
    .loss-title {
      font-weight: 700;
      font-size: .8rem;
      color: #064066;
      margin-bottom: .35rem;
      display: flex;
      gap: .4rem;
      align-items: center;
    }
    .loss-list {
      margin: 0;
      padding-left: 1.1rem;
      font-size: .75rem;
      color: #4b5563;
    }
    .loss-list li + li {
      margin-top: .15rem;
    }
    .loss-hint {
      font-size: .68rem;
      color: #94a3b8;
      margin-top: .35rem;
    }

    /* competidores fuertes */
    .strong-competitors {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: .8rem;
      padding: .6rem .75rem .35rem;
      margin-top: 1rem;
    }
    .strong-competitors h3 {
      font-size: .78rem;
      font-weight: 700;
      color: #064066;
      margin-bottom: .35rem;
    }
    .sc-item {
      display: flex;
      justify-content: space-between;
      gap: .5rem;
      font-size: .7rem;
      margin-bottom: .35rem;
    }
    .sc-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sc-value {
      font-weight: 600;
      color: #0f172a;
    }

    /* micro KPI oportunidad perdida */
    .opportunity-bar {
      font-size: .7rem;
      color: #0f172a;
      background: #eff6ff;
      border: 1px dashed rgba(6,64,102,.35);
      border-radius: .65rem;
      padding: .35rem .6rem;
      display: inline-flex;
      gap: .3rem;
      align-items: center;
    }
    .opportunity-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #ef4444;
    }

    /* Comentarios / vistas */
    .wc-comments-btn {
      position: fixed;
      right: 18px;
      bottom: 18px;
      background: #0b5ed7;
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(0,0,0,.18);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      z-index: 9998;
    }
    .wc-comments-btn:hover {
      filter: brightness(0.95);
    }
    .wc-badge {
      display: none !important;
    }

    .wc-comments-panel {
      position: fixed;
      top: 0;
      right: -420px;
      width: 400px;
      height: 100vh;
      z-index: 9999;
      background: #fff;
      border-left: 1px solid #e5e7eb;
      box-shadow: -8px 0 24px rgba(0,0,0,.08);
      display: flex;
      flex-direction: column;
      transition: right .22s ease;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans";
    }
    .wc-comments-panel.wc-open {
      right: 0;
    }
    .wc-hd {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px;
      border-bottom: 1px solid #e5e7eb;
      background: #f8fafc;
    }
    .wc-hd h3 {
      font-size: 16px;
      margin: 0;
    }
    #wc-comments-close {
      background:transparent;
      border:none;
      font-size: 18px;
      cursor:pointer;
      padding:6px;
      line-height:1;
    }
    #wc-comments-list {
      flex: 1;
      overflow: auto;
      padding: 10px 12px;
      background: #fff;
    }
    .wc-empty {
      color:#6b7280;
      font-size: 14px;
      text-align:center;
      margin-top: 20px;
    }
    .wc-item {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 8px 10px;
      margin-bottom: 10px;
      background: #fff;
    }
    .wc-item-resolved {
      opacity: .8;
      background: #f5f7fa;
    }
    .wc-item-hd {
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 10px;
    }
    .wc-item-author {
      font-weight: 600;
      font-size: 14px;
    }
    .wc-item-meta {
      color:#6b7280;
      font-size: 12px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .wc-parent {
      background:#eef2ff;
      color:#4338ca;
      border-radius: 6px;
      padding:2px 6px;
    }
    .wc-item-body {
      margin-top: 6px;
      white-space: pre-wrap;
      font-size: 14px;
    }
    .wc-item-ft {
      margin-top: 8px;
      display:flex;
      gap: 10px;
    }
    .wc-link {
      background:none;
      border:none;
      color:#0b5ed7;
      cursor:pointer;
      font-size: 13px;
      padding:0;
    }
    .wc-form {
      border-top: 1px solid #e5e7eb;
      padding: 10px 12px;
      background:#fafafa;
    }
    .wc-form textarea {
      width: 100%;
      min-height: 74px;
      resize: vertical;
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
    }
    .wc-form .wc-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top: 8px;
    }
    .wc-btn {
      background:#0b5ed7;
      color:#fff;
      border:none;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 14px;
      cursor:pointer;
    }
    .wc-btn:hover {
      filter: brightness(0.95);
    }
    .wc-replying {
      font-size: 12px;
      color:#4338ca;
      background:#eef2ff;
      border-radius: 6px;
      padding: 4px 8px;
    }
    .wc-hide {
      display:none;
    }

    /* Modal de Vistas */
    .views-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(6, 64, 102, .28);
      backdrop-filter: blur(1px);
      z-index: 1400;
    }
    .views-modal{
      position: fixed;
      top: 90px;
      left: 50%;
      transform: translateX(-50%);
      width: 560px;
      max-width: 96vw;
      background: #ffffff;
      border-radius: 1rem;
      box-shadow: 0 18px 40px rgba(0,0,0,.15);
      border: 1px solid #e5e7eb;
      z-index: 1401;
      display: flex;
      flex-direction: column;
      gap: 0;
      max-height: calc(100vh - 140px);
    }
    .views-modal[hidden],
    .views-backdrop[hidden]{
      display: none !important;
    }
    .views-modal .vm-head{
      padding: .9rem 1rem;
      border-bottom: 1px solid #eef2f7;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .5rem;
    }
    .views-modal .vm-head .ttl{
      font-weight: 700;
      color: #064066;
    }
    .views-modal .vm-body{
      padding: .9rem 1rem 1rem;
      gap: 1rem;
      display: grid;
      grid-template-columns: 1fr;
      overflow-y: auto;
    }
    .views-modal .vm-foot{
      padding: .6rem 1rem .9rem;
      border-top: 1px solid #eef2f7;
      display: flex;
      justify-content: flex-end;
      gap: .5rem;
      background: #fff;
    }
    .views-list .row{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .75rem;
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: .6rem;
      padding: .4rem .6rem;
      margin-bottom: .4rem;
    }
    .views-list .nm{
      font-weight: 600;
      color: #064066;
    }
    .views-list .tag{
      display: inline-block;
      background: #e0ebff;
      color: #064066;
      font-size: .68rem;
      border-radius: 999px;
      padding: 2px 10px;
      margin-left: .25rem;
    }
    .views-list .act button{
      background: none;
      border: none;
      font-size: .7rem;
      cursor: pointer;
      color: #064066;
    }
    .views-list .act button:hover{
      text-decoration: underline;
    }
    @media (max-width: 600px){
      .views-modal{
        top: 68px;
        width: 97vw;
      }
    }

    /* efecto premium KPI */
    .kpi-card {
      background: var(--sa-blanco);
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,.05);
      padding: 24px;
      transition: all .3s ease;
    }
    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(0,0,0,.08);
    }
    .kpi-title {
      font-weight: 600;
      color: var(--sa-text);
      font-size: 0.95rem;
      margin-bottom: 6px;
    }
    .kpi-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--sa-azul-btn);
    }
    .kpi-trend {
      font-size: 0.9rem;
      font-weight: 500;
      color: #22c55e;
      margin-left: 8px;
    }
    .kpi-trend.down {
      color: #ef4444;
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(15px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .fade-up {
      animation: fadeUp .6s ease forwards;
    }

    /* forzar barra superior del tablero */
    .wc-topbar,
    .page-toolbar,
    .app-toolbar,
    header.wc-topbar,
    header.page-toolbar {
      display: flex;
      align-items: center;
      gap: .75rem;
    }
    .topbar-right,
    .toolbar-right,
    .page-toolbar-right,
    .wc-topbar-right {
      margin-left: auto !important;
    }

    /* ===== Resumen ejecutivo / Vista gerente ===== */
    .manager-summary{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:.75rem;
      margin-bottom:1rem;
    }
    @media (max-width:1200px){
      .manager-summary{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }
    @media (max-width:768px){
      .manager-summary{
        grid-template-columns:1fr;
      }
    }
    .ms-card{
      background:#fff;
      border-radius:.9rem;
      border:1px solid var(--sa-gris-borde);
      box-shadow:0 1px 3px rgba(15,23,42,.06);
      padding:.75rem .9rem;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      min-height:90px;
    }
    .ms-card.fade-up{
      /* reutiliza tu animaci√≥n fadeUp ya definida */
    }
    .ms-label{
      font-size:.75rem;
      text-transform:uppercase;
      letter-spacing:.04em;
      color:var(--sa-azul);
      font-weight:800;
      margin-bottom:.35rem;
    }
    .ms-main{
      font-size:1.25rem;
      font-weight:700;
      color:var(--sa-azul-btn);
    }
    .ms-sub{
      font-size:.72rem;
      color:#64748b;
      margin-top:.25rem;
    }
    .ms-status .ms-main{
      display:flex;
      align-items:center;
      gap:.35rem;
    }
    .ms-pill{
      display:inline-flex;
      align-items:center;
      padding:2px 10px;
      border-radius:999px;
      font-size:.7rem;
      font-weight:600;
      background:#e5e7eb;
      color:#0f172a;
    }
    .ms-pill.ok{
      background:#dcfce7;
      color:#15803d;
    }
    .ms-pill.warn{
      background:#fef9c3;
      color:#854d0e;
    }
    .ms-pill.danger{
      background:#fee2e2;
      color:#b91c1c;
    }
  </style>

  <!-- Librer√≠as principales -->
  <script defer src="{{ url_for('static', path='vendor/chart.umd.min.js') }}"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@3/dist/chartjs-chart-treemap.min.js"></script>
  <script defer src="{{ url_for('static', path='js/chart-ux.js') }}"></script>
{% endblock %}

{% block page_skin %}
  <link rel="stylesheet" href="{{ url_for('static', path='css/dashboard.v2.css') }}?v=1">
{% endblock %}

{% block toolbar_actions %}
  <div class="d-flex align-items-center gap-2 flex-wrap" id="toolbarLeft">
    <div class="mini-toggle" id="viewToggle" title="Zoom del tablero" role="group" aria-label="Zoom">
      <button class="mini-btn active" data-view="normal" aria-pressed="true">100%</button>
      <button class="mini-btn" data-view="fit" aria-pressed="false">Ajustar a pantalla</button>
    </div>

    <div class="mini-toggle" id="densityToggle" title="Densidad de la vista" role="group" aria-label="Densidad">
      <button class="mini-btn active" data-density="normal" aria-pressed="true">Normal</button>
      <button class="mini-btn" data-density="compact" aria-pressed="false">Compacto</button>
    </div>
  </div>
{% endblock %}

{% block content %}
  <noscript>
    <div class="alert alert-warning my-2">Este tablero requiere JavaScript para gr√°ficos, filtros y paginaci√≥n.</div>
  </noscript>

  <div id="fitContainer" class="fit-container">
    <div class="dash-v2">
      <!-- Encabezado -->
      <section id="processHeader" class="process-header mb-3" aria-labelledby="phTitle">
        <div class="ph-left">
          <div class="ph-title">
            <span class="label">Proceso</span>
            <h1 id="phTitle" class="nro m-0">{{ upload.proceso_nro }}</h1>

            <!-- contexto que lee comments.js -->
            <div
              id="comments-context"
              data-upload-id="{{ upload_id }}"
              data-process-code="{{ upload.proceso_nro or upload.proceso or upload.proceso_code }}"
              hidden
            ></div>
          </div>

          <div class="ph-meta-grid" role="list" aria-label="Metadatos del proceso">
            <div class="ph-kv" role="listitem">
              <div class="k">Apertura</div>
              <div class="v" id="ph_apertura">{{ upload.apertura_fecha or "‚Äî" }}</div>
            </div>
            <div class="ph-kv" role="listitem">
              <div class="k">Cuenta</div>
              <div class="v">{{ upload.cuenta_nro or "‚Äî" }}</div>
            </div>
            <div class="ph-kv" role="listitem">
              <div class="k">Plataforma</div>
              <div class="v">{{ upload.platform or upload.platform_hint or "‚Äî" }}</div>
            </div>
            <div class="ph-kv" role="listitem">
              <div class="k">Comprador</div>
              <div class="v">{{ upload.buyer or upload.comprador or upload.buyer_hint or "‚Äî" }}</div>
            </div>
            <div class="ph-kv" role="listitem">
              <div class="k">Provincia/Municipio</div>
              <div class="v">{{ upload.province or upload.municipio or upload.province_hint or "‚Äî" }}</div>
            </div>
          </div>
        </div>

        <div class="ph-right">
          <div class="ph-actions">
            <button
              class="btn btn-outline-secondary btn-sm"
              id="btnViews"
              type="button"
              aria-haspopup="dialog"
              aria-controls="viewsModal"
            >
              Vistas
            </button>

            <a
              class="btn btn-primary btn-sm"
              href="/descargas/{{ upload_id }}"
              aria-label="Descargar normalized.xlsx del proceso {{ upload.proceso_nro }}"
            >
              Descargar normalized.xlsx
            </a>
          </div>
        </div>
      </section>

      <!-- Por qu√© perdimos / explicaci√≥n -->
      <section id="lossExplainer" class="loss-explainer" aria-label="Explicaci√≥n de p√©rdidas" hidden>
        <div class="loss-title">
          üìâ Por qu√© perdimos renglones en este proceso
        </div>
        <ul class="loss-list" id="lossList"></ul>
        <div class="loss-hint" id="lossHint"></div>
      </section>

      <!-- Resumen ejecutivo / vista gerente -->
      <section class="manager-summary" aria-label="Resumen ejecutivo del proceso">
        <article class="ms-card fade-up" aria-labelledby="ms_part_monto">
          <div class="ms-label">Participaci√≥n de Suizo en monto adjudicado</div>
          <div class="ms-main" id="ms_part_monto">‚Äî</div>
          <div class="ms-sub">Porcentaje del monto adjudicado que obtuvo Suizo.</div>
        </article>

        <article class="ms-card fade-up" aria-labelledby="ms_ef_reng">
          <div class="ms-label">Efectividad por renglones</div>
          <div class="ms-main" id="ms_ef_reng">‚Äî</div>
          <div class="ms-sub">Renglones adjudicados sobre renglones ofertados.</div>
        </article>

        <article class="ms-card fade-up" aria-labelledby="ms_oportunidad">
          <div class="ms-label">Oportunidad recuperable</div>
          <div class="ms-main" id="ms_oportunidad">‚Äî</div>
          <div class="ms-sub">Renglones perdidos por poca diferencia de precio.</div>
        </article>

        <article class="ms-card fade-up ms-status" id="ms_estado" aria-label="Estado general del proceso">
          <div class="ms-label">Estado general</div>
          <div class="ms-main">
            <span class="ms-pill">En an√°lisis</span>
          </div>
          <div class="ms-sub">Calculado seg√∫n participaci√≥n y efectividad de Suizo.</div>
        </article>
      </section>

      <div class="dashboard-grid mb-4">
        <!-- Izquierda -->
        <div class="pane pane-left span-6 span-lg-6 span-sm-1">
          <section class="kpi-group" aria-labelledby="kpiGenTitle">
            <h2 class="group-title m-0" id="kpiGenTitle">Datos generales de licitaci√≥n</h2>
            <div class="kpi-grid">
              <div class="kpi-card" role="group" aria-label="Presupuesto adjudicado">
                <div class="kpi-label">Presupuesto adjudicado</div>
                <div class="kpi-value" id="treemapTotalKpi">{{ kpis.get('awarded', 0) | peso }}</div>
              </div>
              <div class="kpi-card" role="group" aria-label="Renglones">
                <div class="kpi-label">Renglones</div>
                <div class="kpi-value" id="dg_renglones">{{ kpis.get('items', 0) }}</div>
              </div>
              <div class="kpi-card" role="group" aria-label="Cantidad de competidores">
                <div class="kpi-label">Cantidad de competidores</div>
                <div class="kpi-value" id="dg_competidores">{{ kpis.get('bidders', 0) }}</div>
              </div>
            </div>
          </section>

          <section class="chart-box" aria-labelledby="treemapTitle">
            <div class="title">
              <!-- t√≠tulo + total -->
              <div class="d-flex flex-column">
                <span id="treemapTitle">Proporci√≥n de presupuesto por proveedor</span>
                <div class="small text-muted" id="treemapTotal" aria-live="polite"></div>
              </div>

              <!-- switch de modo de treemap -->
              <div
                class="mini-toggle tiny"
                id="treemapModeToggle"
                role="group"
                aria-label="Modo de treemap"
              >
                <button
                  type="button"
                  class="mini-btn active"
                  data-mode="prov"
                  aria-pressed="true"
                >
                  Proveedor
                </button>
                <button
                  type="button"
                  class="mini-btn"
                  data-mode="item"
                  aria-pressed="false"
                >
                  Rengl√≥n
                </button>
              </div>
            </div>

            <div class="chart-treemap" role="img" aria-label="Treemap de adjudicaciones">
              <canvas id="treemapProveedores"></canvas>
            </div>
          </section>
        </div>

        <!-- Derecha -->
        <div class="pane pane-right span-6 span-lg-6 span-sm-1">
          <section class="kpi-group" aria-labelledby="kpiSuizoTitle">
            <h2 class="group-title m-0" id="kpiSuizoTitle">Efectividad Suizo</h2>
            <div class="kpi-grid">
              <div class="kpi-card" role="group" aria-label="Monto ofertado">
                <div class="kpi-label">Monto ofertado</div>
                <div class="kpi-value" id="es_monto_ofertado">{{ 0 | peso }}</div>
              </div>
              <div class="kpi-card" role="group" aria-label="Monto adjudicado">
                <div class="kpi-label">Monto adjudicado</div>
                <div class="kpi-value" id="es_monto_adjudicado">{{ 0 | peso }}</div>
              </div>
              <div class="kpi-card" role="group" aria-label="Efectividad por monto">
                <div class="kpi-label">Efectividad por monto</div>
                <div class="kpi-value" id="es_efectividad_monto">0%</div>
              </div>
              <div class="kpi-card" role="group" aria-label="Renglones ofertados">
                <div class="kpi-label">Renglones ofertados</div>
                <div class="kpi-value" id="es_renglones_ofertados">0</div>
              </div>
              <div class="kpi-card" role="group" aria-label="Renglones adjudicados">
                <div class="kpi-label">Renglones adjudicados</div>
                <div class="kpi-value" id="es_renglones_adjudicados">0</div>
              </div>
              <div class="kpi-card" role="group" aria-label="Efectividad por renglones">
                <div class="kpi-label">Efectividad por renglones</div>
                <div class="kpi-value" id="es_efectividad_renglones">0%</div>
              </div>
            </div>
          </section>

          <div class="charts-row">
            <section class="chart-box" aria-labelledby="donutTitle">
              <div class="title" id="donutTitle">Efectividad Suizo</div>
              <div class="chart-donut" role="img" aria-label="Efectividad Suizo (Adjudicado vs No adjudicado)">
                <canvas id="donutSuizo"></canvas>
              </div>
            </section>

            <section class="chart-box" aria-labelledby="barTitle">
              <div class="title" id="barTitle">Posiciones</div>
              <div class="chart-bar" role="img" aria-label="Distribuci√≥n de posiciones">
                <canvas id="barPosAgg"></canvas>
              </div>
            </section>
          </div>

          <!-- Competidores fuertes (debajo de los charts) -->
          <section class="strong-competitors" aria-label="Competidores fuertes en este proceso">
            <h3>Competidores fuertes</h3>
            <div id="scList">
              <div class="text-muted" style="font-size:.7rem;">Se completar√° con el ranking‚Ä¶</div>
            </div>
          </section>
        </div>
      </div>

      <!-- RANKING -->
      <section id="rankSection" class="table-wrap mb-4" aria-labelledby="rankTitle">
        <h2 id="rankTitle" class="visually-hidden">Ranking de ofertas</h2>

        <!-- micro KPI oportunidad -->
        <div id="opportunityBar" class="opportunity-bar mb-2" style="display:none;">
          <span class="opportunity-dot"></span>
          <span id="opportunityText">Hay renglones que se perdieron por muy poco.</span>
        </div>

        <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
          <!-- fallback local si no se renderiza el toolbar -->
          <div class="d-flex gap-2 flex-wrap" id="localControls">
            <div class="d-flex gap-2 flex-wrap">
              <div class="mini-group d-none" id="viewToggleLocal" role="group" aria-label="Zoom del tablero">
                <button type="button" class="mini-btn active" data-view="normal" aria-pressed="true">100%</button>
                <button type="button" class="mini-btn" data-view="fit" aria-pressed="false">Ajustar</button>
              </div>

              <div class="mini-group d-none" id="densityToggleLocal" role="group" aria-label="Densidad de filas">
                <button type="button" class="mini-btn active" data-density="normal" aria-pressed="true">Normal</button>
                <button type="button" class="mini-btn" data-density="compact" aria-pressed="false">Compacta</button>
              </div>
            </div>
          </div>

          <div class="segmented" role="tablist" aria-label="Modo de oferentes">
            <button class="seg-btn" data-mode="suizo" id="tabSuizo" role="tab" aria-selected="false">Suizo Argentina</button>
            <button class="seg-btn" data-mode="otros" id="tabOtros" role="tab" aria-selected="false">Otros oferentes</button>
            <button class="seg-btn active" data-mode="todos" id="tabTodos" role="tab" aria-selected="true">Todos</button>
          </div>

          <input
            id="search"
            class="form-control form-control-sm search"
            placeholder="Buscar descripci√≥n o proveedor‚Ä¶"
            aria-label="Buscar en la tabla"
          >

          <div
            class="pos-cols"
            id="posCols"
            title="Filtrar por posiciones (clic). ALT+clic: solo mostrar/ocultar columna"
            role="group"
            aria-label="Columnas por posici√≥n"
          ></div>

          <button
            id="toggleFilters"
            class="btn btn-sm btn-outline-secondary ms-1"
            aria-expanded="true"
            aria-controls="rankHead"
          >
            Filtros
          </button>

          <div class="vr mx-2"></div>

          <label class="small text-subtle" for="pageSize">Filas por p√°gina</label>
          <input
            id="pageSize"
            type="number"
            min="10"
            max="500"
            value="50"
            class="form-control form-control-sm"
            style="width:110px"
            aria-label="Filas por p√°gina"
          >

          <button id="prev" class="btn btn-sm btn-secondary" aria-label="P√°gina anterior">‚Äπ</button>
          <span id="pageInfo" class="small text-subtle" data-page="1" aria-live="polite"></span>
          <button id="next" class="btn btn-sm btn-secondary" aria-label="P√°gina siguiente">‚Ä∫</button>

          <div id="selectionChip" class="ms-2"></div>

          <div class="ms-auto small text-subtle" id="totalInfo" aria-live="polite"></div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-hover" id="rankTable" aria-describedby="rankTitle">
            <caption class="visually-hidden">
              Tabla de renglones con precios por posici√≥n, relaci√≥n, asignaci√≥n y proveedor.
            </caption>
            <thead id="rankHead"></thead>
            <tbody id="rankBody">
              <tr>
                <td class="text-center text-muted py-4">Cargando‚Ä¶</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </div><!-- /.dash-v2 -->
  </div>

  <!-- ===== MODAL / PANEL DE VISTAS ===== -->
  <div class="views-backdrop" id="viewsBackdrop" hidden aria-hidden="true"></div>

  <div
    class="views-modal"
    id="viewsModal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="vmTitle"
    hidden
  >
    <div class="vm-head">
      <div class="ttl" id="vmTitle">Vistas guardadas</div>
      <button id="vmClose" class="btn btn-sm btn-outline-secondary" aria-label="Cerrar modal de vistas">Cerrar</button>
    </div>

    <div class="vm-body">
      <!-- Lista de vistas -->
      <div>
        <div class="form-note mb-2">Tus vistas guardadas para este tablero.</div>
        <div class="views-list" id="viewsList">
          <div class="row">
            <div class="nm text-muted">Sin vistas guardadas a√∫n.</div>
          </div>
        </div>
      </div>

      <!-- Guardar / renombrar -->
      <div>
        <div class="form-note mb-2">
          Guard√° la configuraci√≥n actual (filtros, modo Suizo/Todos, zoom, densidad, columnas visibles y b√∫squeda).
        </div>

        <div class="vm-field">
          <label for="vmName">Nombre</label>
          <input
            type="text"
            id="vmName"
            class="form-control form-control-sm"
            placeholder="Ej: Suizo compacto"
          >
        </div>

        <div class="vm-field inline">
          <input
            type="checkbox"
            id="vmDefault"
            class="form-check-input"
            aria-describedby="vmDefaultHelp"
          >
          <label for="vmDefault" class="m-0">Establecer como mi vista por defecto</label>
        </div>
        <div id="vmDefaultHelp" class="form-note">Se cargar√° autom√°ticamente al abrir este tablero.</div>

        <div class="vm-field">
          <button id="vmSave" class="btn btn-sm btn-primary">Guardar vista</button>
        </div>

        <div class="form-note">Tip: pod√©s sobrescribir una vista si pon√©s el mismo nombre.</div>
      </div>
    </div>

    <div class="vm-foot">
      <button id="vmRefresh" class="btn btn-sm btn-outline-secondary">Actualizar lista</button>
      <button id="vmClose2" class="btn btn-sm btn-secondary">Cerrar</button>
    </div>
  </div>
  <!-- ===== /MODAL VISTAS ===== -->

  <!-- Panel / bot√≥n de comentarios -->
  <button
    id="wc-comments-toggle"
    class="wc-comments-btn"
    aria-expanded="false"
    title="Comentarios"
  >
    Comentarios
  </button>

  <aside
    id="wc-comments-panel"
    class="wc-comments-panel"
    aria-hidden="true"
    data-upload-id="{{ upload_id }}"
    data-user-display="{{ (user and (user.name or user.email)) or 'Yo' }}"
    data-user-role="{{ (user and (user.role or user.rol or ''))|lower }}"
    data-process-code="{{ upload.proceso_nro }}"
  >
    <div class="wc-hd">
      <h3>Comentarios</h3>
      <button id="wc-comments-close" aria-label="Cerrar">‚úï</button>
    </div>

    <div id="wc-comments-list" aria-live="polite" aria-busy="false"></div>

    <form id="wc-comments-form" class="wc-form" autocomplete="off">
      <input type="hidden" name="parent_id" value="">

      <div id="wc-replying" class="wc-replying wc-hide">
        Respondiendo‚Ä¶
        <button id="wc-reply-cancel" class="wc-link" type="button">cancelar</button>
      </div>

      <textarea
        name="body"
        maxlength="5000"
        required
        placeholder="Escribe un comentario‚Ä¶ (Enter para enviar, Shift+Enter para salto de l√≠nea)"
      ></textarea>

      <div class="wc-row">
        <div style="font-size:12px;color:#6b7280;">
          Se publicar√° como:
          <strong>{{ (user and (user.name or user.email)) or 'Yo' }}</strong>
        </div>
        <button class="wc-btn" type="submit">Enviar</button>
      </div>
    </form>
  </aside>
  <!-- fin m√≥dulo comentarios -->
{% endblock %}

{% block extra_js %}
  <script>
    window.__DASH_VERSION__ = 'dashboard-exjs v2025-10-26-b-fix';
    console.info('[dashboard] bundle', window.__DASH_VERSION__);
  </script>

  <!-- 1) Datos iniciales para el treemap (fallback si no hay chart_prov directo) -->
  <script>
    (() => {
      const direct = {{ chart_prov|default([])|tojson }};
      if (Array.isArray(direct) && direct.length) {
        window.CHART_PROV = direct.map(d => ({
          label: String(d.label ?? d.name ?? '‚Äî'),
          value: +d.value || 0
        }));
      } else {
        const L = {{ chart_suppliers_adj_labels|default([])|tojson }};
        const V = {{ chart_suppliers_adj_values|default([])|tojson }};
        const out = [];
        for (let i = 0; i < Math.min(L.length, V.length); i++) {
          out.push({
            label: String(L[i] ?? ''),
            value: +V[i] || 0
          });
        }
        window.CHART_PROV = out;
      }
    })();
  </script>

  <!-- 2) L√≥gica principal (tabla + KPIs + gr√°ficos + vista gerente + competidores fuertes) -->
  <script>
    (function () {
      const SA_AZUL = '#064066',
            SA_GRIS = '#EBEBEB',
            SA_BLANCO = '#ffffff';

      const elOppBar = document.getElementById('opportunityBar');
      const elOppText = document.getElementById('opportunityText');

      const elLossExpl = document.getElementById('lossExplainer');
      const elLossList = document.getElementById('lossList');
      const elLossHint = document.getElementById('lossHint');
      const elStrongCompetitors = document.getElementById('scList');

            const elTreemapTitle = document.getElementById('treemapTitle');
      const elTreemapModeToggle = document.getElementById('treemapModeToggle');

      // total adjudicado ‚Äúbueno‚Äù que viene del backend (incluye parciales)
      window.__KPI_AWARDED_TOTAL = {{ kpis.get('awarded', 0)|tojson }};

      // estado del switch del treemap
      let TREEMAP_VIEW = 'prov'; // 'prov' | 'item'
      let TREEMAP_PROV_DATA = Array.isArray(window.CHART_PROV) ? window.CHART_PROV.slice() : [];
      let TREEMAP_ITEM_DATA = [];

      // etiqueta para el tooltip del treemap (la usa el script 3)
      window.TREEMAP_LABEL = window.TREEMAP_LABEL || 'Proveedor';

      /* ===== Helpers ===== */
      const waitUntil = (testFn, {tries=40, every=120}={}) =>
        new Promise(res => {
          (function loop(n){
            if (testFn()) return res(true);
            if (n <= 0) return res(false);
            setTimeout(() => loop(n - 1), every);
          })(tries);
        });

      // Inicializar defaults Chart cuando est√© cargado
      (async function setupChartDefaults(){
        const ok = await waitUntil(() => !!window.Chart);
        if (!ok) return;

        Chart.defaults.font.family = "Outfit, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial";
        Chart.defaults.color = SA_AZUL;
        Chart.defaults.maintainAspectRatio = false;
        Chart.defaults.animation = false;

        Chart.defaults.plugins.tooltip.enabled = true;
        Chart.defaults.plugins.tooltip.backgroundColor = SA_BLANCO;
        Chart.defaults.plugins.tooltip.borderColor = '#e5e7eb';
        Chart.defaults.plugins.tooltip.borderWidth = 1;
        Chart.defaults.plugins.tooltip.titleColor = SA_AZUL;
        Chart.defaults.plugins.tooltip.bodyColor = SA_AZUL;
        Chart.defaults.plugins.tooltip.cornerRadius = 6;
        Chart.defaults.plugins.tooltip.padding = 8;

        Chart.defaults.plugins.legend.labels.boxWidth = 12;

        Chart.defaults.devicePixelRatio = Math.min(window.devicePixelRatio || 1, 1.5);
      })();

      const toNum = (x) => {
        if (typeof x === 'number') return isFinite(x) ? x : 0;
        const s = String(x ?? '')
          .replace(/\s+/g,'')
          .replace(/[^0-9,.\-]/g,'')
          .replace(/\.(?=\d{3}([\D]|$))/g,'');
        const n = parseFloat(s.replace(',', '.'));
        return isFinite(n) ? n : 0;
      };

      const nfARS = v =>
        new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0})
          .format(+v||0);

      const pctFmt = v =>
        new Intl.NumberFormat('es-AR',{style:'percent',maximumFractionDigits:0})
          .format(+v||0);

      const pctFmt1d = v =>
        new Intl.NumberFormat('es-AR',{style:'percent',maximumFractionDigits:1})
          .format(+v||0.0);

      const fmtDateDMY = s => {
        const m = String(s || '').trim().match(/^0*(\d{1,2})[-\/](\d{1,2})[-\/](\d{2,4})$/);
        if (!m) return s || '';
        const dd = m[1].padStart(2, '0');
        const mm = m[2].padStart(2, '0');
        const yy = m[3].length === 2 ? '20' + m[3] : m[3].padStart(4, '0');
        return dd + '/' + mm + '/' + yy;
      };

      const isSuizo = prov => /suizo/i.test(String(prov||''));

      // normaliza textos para comparaciones
      const norm = function (s) {
        var out = (s || "").toString().toLowerCase();
        if (typeof out.normalize === "function") {
          out = out.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }
        out = out.replace(/[\s_.\-\/]+/g, "");
        return out;
      };

      const esc = function (s) {
        var str = (s == null ? "" : String(s));
        return str.replace(/[&<>"']/g, function (m) {
          switch (m) {
            case "&": return "&amp;";
            case "<": return "&lt;";
            case ">": return "&gt;";
            case "\"": return "&quot;";
            default: return "&#39;";
          }
        });
      };

      const rxEscape = s => String(s||'').replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

      const highlightText = (text, query) => {
        const src = String(text || '');
        const q = String(query || '').trim();
        if (!q) return esc(src);

        const re = new RegExp(rxEscape(q), 'i');
        const m = src.match(re);
        if (!m) return esc(src);

        const i = m.index;
        const match = m[0];
        const after = src.slice(i + match.length);
        const before = src.slice(0, i);

        return esc(before) +
          '<mark class="sa-hit">' + esc(match) + '</mark>' +
          esc(after);
      };

      function pickNumber(obj, keywords){
        if(!obj) return 0;
        const keys = Object.keys(obj||{});
        for(const k of keys){
          const nk = norm(k);
          for(const kw of keywords){
            if(nk.includes(kw)){
              const v = toNum(obj[k]);
              if(v!==0) return v;
            }
          }
        }
        return 0;
      }

      /* ===== Cantidades & precios ===== */
      const unitPriceOf = p => toNum(p?.precio ?? p?.price);

      function rowQty(row){
        const cand = [
          row?.cantidad_solicitada,
          row?.cantidadSolicitada,
          row?.cant_solicitada,
          row?.solicitada,
          row?.cantidad_req,
          row?.cantidad,
          row?.qty,
          row?.q
        ];
        for(const c of cand){
          const v=toNum(c);
          if(v>0) return v;
        }
        return pickNumber(row,[
          'cantidadsolicitada',
          'cantsolicitada',
          'solicitada',
          'unidades',
          'cantidad'
        ])||0;
      }

      function offeredQty(row,p){
        let v = toNum(
          p?.cantidad ??
          p?.cantidad_ofertada ??
          p?.cant_ofertada ??
          p?.qty
        );
        if(v>0) return v;
        return pickNumber(p,[
          'cantidad',
          'ofertada',
          'cant'
        ])||0;
      }

      function effectiveQty(row,p){
        const req=rowQty(row);
        const p1=(row.positions||[]).find(x=>+x.pos===1);
        const q1=offeredQty(row,p1)||0;

        if(+p.pos===1) return Math.min(q1,req);
        if(+p.pos===2){
          const rem=Math.max(0,req-q1);
          const q2=offeredQty(row,p)||0;
          return Math.min(q2,rem);
        }
        return 0;
      }

      const totalOf =(row,p)=>unitPriceOf(p)*offeredQty(row,p);
      const awardValue=(row,p)=>unitPriceOf(p)*effectiveQty(row,p);

      /* ===== visibilidad de ofertas por modo ===== */
      let MODE='todos'; // En "otros" ocultamos Suizo; en el resto mostramos todo y usamos filtros de filas.

      const showOfferByMode = (p) =>
        MODE==='otros' ? !isSuizo(p.proveedor) : true;

      function cheapestPrice(row, {includedOnly=false}={}){
        const arr = (row.positions||[])
          .filter(p => includedOnly ? showOfferByMode(p) : true);

        let min = Infinity;
        for(const p of arr){
          const u=unitPriceOf(p);
          if(u<min) min=u;
        }
        return isFinite(min) && min<Infinity ? min : 0;
      }

      function rankAmong(row, {includedOnly=false}={}){
        const arr = (row.positions||[])
          .filter(p => includedOnly ? showOfferByMode(p) : true)
          .slice()
          .sort((a,b)=>unitPriceOf(a)-unitPriceOf(b));

        const map=new Map();
        arr.forEach((p,i)=> map.set(+p.pos, i+1));
        return map;
      }

      /* ===== Controles zoom/densidad ===== */
      const fitContainer=document.getElementById('fitContainer');
      const viewToggle=document.getElementById('viewToggle');
      const densityToggle=document.getElementById('densityToggle');

      let VIEW_MODE=localStorage.getItem('viewMode')||'normal';
      let DENSITY=localStorage.getItem('density')||'normal';

      function setActive(group,attr,val){
        if (!group) return;
        group.querySelectorAll('.mini-btn').forEach(b=>{
          const active = b.dataset[attr]===val;
          b.classList.toggle('active', active);
          b.setAttribute('aria-pressed', active ? 'true' : 'false');
        });
      }

      function computeFitScale(){
        if (!fitContainer) return 1;
        fitContainer.classList.remove('scaled');
        fitContainer.style.setProperty('--fit-scale','1');
        const natW=fitContainer.scrollWidth || 1,
              natH=fitContainer.scrollHeight || 1;
        const vw=window.innerWidth || 1,
              vh=window.innerHeight || 1;
        return Math.min(1, vw/natW, (vh-12)/natH);
      }

      function applyView(){
        if (!fitContainer) return;
        if(VIEW_MODE==='fit'){
          const s=computeFitScale();
          fitContainer.style.setProperty('--fit-scale',String(s || 1));
          fitContainer.classList.add('scaled');
        } else {
          fitContainer.classList.remove('scaled');
          fitContainer.style.setProperty('--fit-scale','1');
        }
      }

      function applyDensity(){
        if (!fitContainer) return;
        fitContainer.classList.toggle('compact', DENSITY==='compact');
        if(VIEW_MODE==='fit') applyView();
      }

      if (viewToggle){
        viewToggle.addEventListener('click', e=>{
          const b=e.target.closest('.mini-btn');
          if(!b) return;
          VIEW_MODE=b.dataset.view;
          localStorage.setItem('viewMode',VIEW_MODE);
          setActive(viewToggle,'view',VIEW_MODE);
          applyView();
        });
      }

      if (densityToggle){
        densityToggle.addEventListener('click', e=>{
          const b=e.target.closest('.mini-btn');
          if(!b) return;
          DENSITY=b.dataset.density;
          localStorage.setItem('density',DENSITY);
          setActive(densityToggle,'density',DENSITY);
          applyDensity();
        });
      }

      window.addEventListener('resize', ()=>{
        if(VIEW_MODE==='fit') applyView();
      });

      setActive(viewToggle,'view',VIEW_MODE);
      setActive(densityToggle,'density',DENSITY);
      applyView();
      applyDensity();

      // Normalizar fecha visible
      const phAp=document.getElementById('ph_apertura');
      if(phAp) phAp.textContent=fmtDateDMY(phAp.textContent);

      /* ===== Gr√°ficos (donut + barras posiciones) ===== */
      let chartDonutSuizo, chartBarPos;

      const CenterPercent = {
        id:'centerPercent',
        afterDraw(chart, args, opt){
          const d=chart.data.datasets?.[0]?.data??[];
          const tot=d.reduce((a,b)=>a+(+b||0),0);
          if(!tot) return;
          const i=opt?.focusIndex??0;
          const val=+d[i]||0, p=val/tot;

          const meta=chart.getDatasetMeta(0).data?.[0];
          if(!meta) return;

          const {ctx}=chart;
          ctx.save();
          ctx.font='600 14px Outfit, ui-sans-serif, system-ui';
          ctx.fillStyle='#064066';
          ctx.textAlign='center';
          ctx.fillText(pctFmt1d(p), meta.x, meta.y);
          ctx.restore();
        }
      };

      function ensureCharts(){
        if(!window.Chart) return;
        if(!chartDonutSuizo){
          const c = document.getElementById('donutSuizo');
          if (c){
            chartDonutSuizo = new Chart(c.getContext('2d'),{
              type:'doughnut',
              data:{
                labels:['Adjudicado','No adjudicado'],
                datasets:[{
                  data:[0,0],
                  backgroundColor:['#064066','#dce3ee'],
                  borderColor:'#ffffff',
                  borderWidth:2
                }]
              },
              options:{
                cutout:'55%',
                plugins:{
                  legend:{ position:'bottom' },
                  centerPercent:{ focusIndex:0 },
                  tooltip:{
                    callbacks:{
                      label:(ctx)=> {
                        const v = +ctx.raw || 0;
                        return `${ctx.label}: ${nfARS(v)}`;
                      }
                    }
                  }
                }
              },
              plugins:[CenterPercent]
            });
          }
        }

        if(!chartBarPos){
          const c = document.getElementById('barPosAgg');
          if (c){
            chartBarPos = new Chart(c.getContext('2d'),{
              type:'bar',
              data:{
                labels:['1','2','Otras'],
                datasets:[{
                  data:[0,0,0],
                  backgroundColor:['#064066','#dce3ee','#dce3ee'],
                  borderColor:'#ffffff',
                  borderWidth:2
                }]
              },
              options:{
                scales:{
                  y:{ beginAtZero:true, ticks:{ precision:0 } }
                },
                plugins:{
                  legend:{ display:false }
                },
                onClick:(_,els)=>{
                  if(!els?.length) return;
                  const idx=els[0].index;
                  togglePosBuckets(idx===0?'1':idx===1?'2':'otras');
                }
              }
            });
          }
        }
      }

            function refreshTreemapFromData(data){
        if (typeof window.updateTreemap === 'function') {
          window.updateTreemap(data);
        }
      }

      if (Array.isArray(window.CHART_PROV)) refreshTreemapFromData(window.CHART_PROV);

      // Valor ofertado (fallback)
      function offerValue(row, p){
        const price = unitPriceOf(p);
        let qty = offeredQty(row, p);
        if(!(qty > 0)) qty = rowQty(row) || 1;
        const val = (price > 0 ? price * qty : qty) || 1;
        return val;
      }

// Treemap por proveedor (monto adjudicado real, incluyendo parciales y 2¬∞ puesto)
function treemapDataFirstPlace(rows, mode){
  const allow = function (name) {
    if (mode === 'suizo') return isSuizo(name);
    if (mode === 'otros') return !isSuizo(name);
    return true;
  };

  const map = new Map();

  (rows || []).forEach(function (r) {
    (r.positions || []).forEach(function (p) {
      if (!allow(p.proveedor)) return;

      const qAdj = effectiveQty(r, p);
      if (!(qAdj > 0)) return;

      const val = unitPriceOf(p) * qAdj;
      if (!(val > 0)) return;

      const key = String(p.proveedor || '‚Äî');
      map.set(key, (map.get(key) || 0) + val);
    });
  });

  return Array.from(map.entries())
    .sort(function (a, b) { return b[1] - a[1]; })
    .map(function (entry) {
      return { label: entry[0], value: entry[1] };
    });
}

      // Treemap por rengl√≥n (monto adjudicado real del rengl√≥n)
function treemapDataByItemFirstPlace(rows, mode){
  const allow = function (name) {
    if (mode === 'suizo') return isSuizo(name);
    if (mode === 'otros') return !isSuizo(name);
    return true;
  };

  const map = new Map();

  (rows || []).forEach(function (r) {
    const nro = (r.nro != null ? r.nro : r.item);
    const labelBase = (nro !== undefined && nro !== null && nro !== '')
      ? 'Rengl√≥n ' + nro
      : 'Rengl√≥n';

    let rowVal = 0;

    (r.positions || []).forEach(function (p) {
      if (!allow(p.proveedor)) return;

      const qAdj = effectiveQty(r, p);
      if (!(qAdj > 0)) return;

      const val = unitPriceOf(p) * qAdj;
      if (!(val > 0)) return;

      rowVal += val;
    });

    if (rowVal > 0) {
      map.set(labelBase, (map.get(labelBase) || 0) + rowVal);
    }
  });

  return Array.from(map.entries())
    .sort(function (a, b) { return b[1] - a[1]; })
    .map(function (entry) {
      return { label: entry[0], value: entry[1] };
    });
}

      // Treemap por proveedor: monto adjudicado al proveedor en primer lugar
      function treemapDataFirstPlace(rows, mode){
        const allow = (name)=>{
          if(mode==='suizo') return isSuizo(name);
          if(mode==='otros') return !isSuizo(name);
          return true;
        };

        const map = new Map();
        (rows || []).forEach(r=>{
          const p1 = (r.positions||[]).find(p=>+p.pos===1);
          if (!p1 || !allow(p1.proveedor)) return;

          const q1 = effectiveQty(r,p1);
          const v1 = p1 ? unitPriceOf(p1)*q1 : 0;
          if (!(v1 > 0)) return;

          const key = String(p1.proveedor || '‚Äî');
          map.set(key, (map.get(key) || 0) + v1);
        });

        return Array.from(map.entries())
          .sort((a,b)=>b[1]-a[1])
          .map(([label, value]) => ({ label, value }));
      }

      function bindTreemapClickOnce(){
        const cv=document.getElementById('treemapProveedores');
        if(!cv || !window.Chart || !Chart.getChart) return;
        const chart=Chart.getChart(cv);
        if(!chart){
          setTimeout(bindTreemapClickOnce,300);
          return;
        }
        if (cv.__treemapClickBound) return;
        cv.__treemapClickBound = true;

        cv.addEventListener('click',(evt)=>{
          const els=chart.getElementsAtEventForMode(evt,'nearest',{intersect:true},true);
          if(!els.length) return;
          const el=els[0];
          const raw=(el.raw && (el.raw._data || el.raw)) || {};
          const label=raw.label || raw.name || raw.g || '';
          if(label && window.setFilter) window.setFilter('provider',label);
        });
      }
      setTimeout(bindTreemapClickOnce,600);

      /* ===== Ranking + filtros ===== */
      const RANK_API="{{ rank_api_url }}";

      const elHead=document.getElementById('rankHead'),
            elBody=document.getElementById('rankBody');
      const elPageSz=document.getElementById('pageSize'),
            elPrev=document.getElementById('prev'),
            elNext=document.getElementById('next'),
            elInfo=document.getElementById('pageInfo');

      const elTotal=document.getElementById('totalInfo'),
            elSearch=document.getElementById('search'),
            elChip=document.getElementById('selectionChip'),
            elPosCols=document.getElementById('posCols');

      const elRankSection = document.getElementById('rankSection');

      let DATA={rows:[],max_pos:0,total_rows:0};
      let QUERY='';
      const FILTERS={ provider:null, posBuckets:new Set(), visCols:new Set(), header:{} };

      function setMode(m){
        MODE = m;
        document.querySelectorAll('.segmented .seg-btn').forEach(b=>{
          const isActive = b.dataset.mode===m;
          b.classList.toggle('active', isActive);
          b.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });
        if (elRankSection){
          elRankSection.classList.toggle('rank-mode-suizo', m === 'suizo');
        }
        elInfo.dataset.page=1;
        renderAll();
      }

      window.setFilter=(k,v)=>{
        if(k==='provider') FILTERS.provider=v||null;
        elInfo.dataset.page=1;
        renderAll();
        renderChips();
      };

      function buildPosCols(maxPos){
        if (!elPosCols) return;
        elPosCols.innerHTML = Array.from({length:maxPos},(_,i)=>{
          const n=i+1,
                active=FILTERS.posBuckets.has(String(n))?'active':'';
          return `<button class="pos-chip ${active}" data-pos="${n}">${n}¬∞</button>`;
        }).join('');
      }

      function updatePosButtonsUI(){
        if (!elPosCols) return;
        elPosCols.querySelectorAll('.pos-chip').forEach(b=>{
          const key=b.dataset.pos;
          b.classList.toggle('active', FILTERS.posBuckets.has(String(key)));
        });
      }

      function renderChips(){
        const chips=[];
        if(FILTERS.provider) chips.push({key:'provider',label:FILTERS.provider});
        if(FILTERS.posBuckets.size){
          const label=[...FILTERS.posBuckets].map(x=>x+'¬∞').join(', ');
          chips.push({key:'posBuckets',label:'Posiciones: '+label});
        }
        elChip.innerHTML=chips.map(c=>
          `<span class="sel-chip" data-key="${c.key}">${c.label} <button title="Quitar">√ó</button></span>`
        ).join('');
      }

      const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
      const getPageSize=()=>clamp(parseInt(elPageSz.value||'50',10),10,500);

      const hasSuizoRow=row=>row.positions?.some(p=>isSuizo(p.proveedor));

      const rowMatchesQuery=(row,ql)=>{
        if(!ql) return true;
        if(String(row.descripcion||'').toLowerCase().includes(ql)) return true;
        return (row.positions||[]).some(p=>
          String(p.proveedor||'').toLowerCase().includes(ql)
        );
      };

      function togglePosBuckets(b){
        if(FILTERS.posBuckets.has(b)) FILTERS.posBuckets.delete(b);
        else FILTERS.posBuckets.add(b);

        const num=parseInt(b,10);
        if(Number.isFinite(num)){
          if(FILTERS.posBuckets.has(b)) FILTERS.visCols.add(num);
          else FILTERS.visCols.delete(num);
          buildHead(DATA.max_pos||0);
        }
        updatePosButtonsUI();
        elInfo.dataset.page=1;
        renderAll();
        renderChips();
      }

      function posBucketsOk(row){
        if(!FILTERS.posBuckets.size) return true;
        return [...FILTERS.posBuckets].some(b=>
          (row.positions||[]).some(p=>{
            if(!showOfferByMode(p)) return false;
            if(b==='otras') return +p.pos>=3;
            return +p.pos===+b;
          })
        );
      }

      function parseRange(v,isPct=false){
        const s=String(v||'').trim();
        if(!s) return [null,null];
        const m=s.match(/^\s*([+-]?\d+(?:[\.,]\d+)?)?\s*(?:\.\.|-)?\s*([+-]?\d+(?:[\.,]\d+)?)?\s*%?\s*$/);
        if(!m) return [null,null];
        const a=m[1]!=null?parseFloat(String(m[1]).replace(',', '.')):null;
        const b=m[2]!=null?parseFloat(String(m[2]).replace(',', '.')):null;
        return isPct ? [a!=null?a/100:null,b!=null?b/100:null] : [a,b];
      }

      function headerFiltersOk(row){
        const H=FILTERS.header||{};

        // Filtro N¬∞
        if(H.nro){
          const valTxt=String(H.nro).trim();
          const [mn,mx]=parseRange(valTxt,false);
          const nroVal=Number(row.nro ?? row.item);
          if(mn!=null || mx!=null){
            if(isFinite(nroVal)){
              if(mn!=null && !(nroVal>=mn)) return false;
              if(mx!=null && !(nroVal<=mx)) return false;
            } else {
              return false;
            }
          }else{
            if(!String(row.nro ?? row.item ?? '').includes(valTxt)) return false;
          }
        }

        // Filtro descripci√≥n
        if(H.desc){
          const q=String(H.desc).toLowerCase();
          if(!String(row.descripcion||'').toLowerCase().includes(q)) return false;
        }

        // Filtro cantidad
        if(H.cant){
          const [mn,mx]=parseRange(H.cant,false);
          const q=rowQty(row)||0;
          if(mn!=null && !(q>=mn)) return false;
          if(mx!=null && !(q<=mx)) return false;
        }

        // Filtro proveedor (chip)
        if(FILTERS.provider){
          const prov=FILTERS.provider.toLowerCase();
          if(!(row.positions||[]).some(p=>String(p.proveedor||'').toLowerCase()===prov))
            return false;
        }

        // Filtros por posici√≥n
        const baseIncluded = (MODE==='otros');
        const basePrice = cheapestPrice(row, {includedOnly: baseIncluded}) || 0;

        for (const [posStr, confRaw] of Object.entries(H)) {
          if (['nro','desc','cant'].includes(posStr)) continue;
          const pos = +posStr;
          if (!Number.isFinite(pos)) continue;
          if (!FILTERS.visCols.has(pos)) continue;

          const conf = confRaw || {};
          const hasProv = !!String(conf.prov || '').trim();
          const hasRel = !!String(conf.relmax || '').trim();
          if (!hasProv && !hasRel) continue;

          const p = (row.positions || []).find(x => +x.pos === pos);
          if (!p) return false; // se pidi√≥ filtro para una pos que no existe en la fila

          if (hasProv){
            if (!String(p.proveedor || '').toLowerCase().includes(String(conf.prov).toLowerCase()))
              return false;
          }

          if (hasRel && basePrice > 0){
            const [mnPct, mxPct] = parseRange(conf.relmax, true);
            const limit = (mxPct != null) ? mxPct : mnPct;
            if (limit != null){
              const rel = (unitPriceOf(p) / basePrice) - 1;
              if (!(rel <= limit)) return false;
            }
          }
        }
        return true;
      }

      function filteredRows(){
        const ql=(QUERY||'').trim().toLowerCase();
        return (DATA.rows||[]).filter(r=>{
          if(MODE==='suizo' && !hasSuizoRow(r)) return false;
          if(!rowMatchesQuery(r,ql)) return false;
          if(!posBucketsOk(r)) return false;
          if(!headerFiltersOk(r)) return false;
          return true;
        });
      }

      // Altura sticky para fila 1 del thead
      function updateHeadOffsets(){
        if (!elHead) return;
        const topRow = elHead.querySelector('tr:nth-child(1)');
        if(!topRow) return;
        const h = Math.ceil(topRow.getBoundingClientRect().height || 40);
        document.documentElement.style.setProperty('--head-row1-h', `${h}px`);
      }

      /* ========= ENCABEZADO DE TABLA ========= */
      function buildHead(maxPos){
        if (!elHead) return;
        const isVis = pos => FILTERS.visCols.has(pos);

        // Fila 1
        const top = document.createElement('tr');
        top.innerHTML =
          `<th rowspan="2" class="text-center col-nro">N¬∞</th>`+
          `<th rowspan="2" class="col-desc">Descripci√≥n</th>`+
          `<th rowspan="2" class="text-center col-cant">Cant</th>`+
          Array.from({length:maxPos},(_,i)=>{
            const pos=i+1;
            if(!isVis(pos)) return '';
            return `<th colspan="4" class="pos-group-head" data-pos="${pos}">${pos}¬∞</th>`;
          }).join('');

        // Fila 2
        const sub = document.createElement('tr');
        sub.innerHTML = Array.from({length:maxPos},(_,i)=>{
          const pos=i+1;
          if(!isVis(pos)) return '';
          return (
            `<th class="c-price g-start">Precio</th>`+
            `<th class="c-rel">Relac</th>`+
            `<th class="c-asig">Asign</th>`+
            `<th class="c-prov">Proveedor</th>`
          );
        }).join('');

        // Filtros
        const flt = document.createElement('tr');
        flt.className = 'filters-row show';

        let cells =
          `<th class="col-nro"><input id="f_nro" class="form-control form-control-sm f-mini" placeholder="#"></th>`+
          `<th class="col-desc"><input id="f_desc" class="form-control form-control-sm f-mini" placeholder="Descripci√≥n"></th>`+
          `<th class="col-cant"><input id="f_cant" class="form-control form-control-sm f-mini" placeholder="cant."></th>`;

        for(let i=1;i<=maxPos;i++){
          if(!isVis(i)) continue;
          cells +=
            `<th class="c-price g-start"></th>`+
            `<th class="c-rel"><input data-pos="${i}" data-ft="relmax" class="form-control form-control-sm f-range" placeholder="% m√°x."></th>`+
            `<th class="c-asig"></th>`+
            `<th class="c-prov"><input data-pos="${i}" data-ft="prov" class="form-control form-control-sm f-mini" placeholder="Proveedor ${i}¬∞"></th>`;
        }

        flt.innerHTML = cells;

        elHead.innerHTML='';
        elHead.appendChild(top);
        elHead.appendChild(sub);
        elHead.appendChild(flt);
        updateHeadOffsets();

        // Listeners filtros
        const toggleBtn = document.getElementById('toggleFilters');
        if (toggleBtn){
          toggleBtn.onclick = ()=> flt.classList.toggle('show');
        }

        const fNro = elHead.querySelector('#f_nro');
        const fDesc = elHead.querySelector('#f_desc');
        const fCant = elHead.querySelector('#f_cant');

        if (fNro){
          fNro.oninput = e=>{
            FILTERS.header.nro = e.target.value;
            elInfo.dataset.page=1;
            renderAll();
          };
        }
        if (fDesc){
          fDesc.oninput = e=>{
            FILTERS.header.desc = e.target.value;
            elInfo.dataset.page=1;
            renderAll();
          };
        }
        if (fCant){
          fCant.oninput = e=>{
            FILTERS.header.cant = e.target.value;
            elInfo.dataset.page=1;
            renderAll();
          };
        }

        elHead.querySelectorAll('[data-ft]').forEach(inp=>{
          inp.oninput = e=>{
            const pos=+e.target.dataset.pos,
                  ft=e.target.dataset.ft,
                  val=e.target.value;
            if(!FILTERS.header[pos]) FILTERS.header[pos]={};
            FILTERS.header[pos][ft]=val;
            elInfo.dataset.page=1;
            renderAll();
          };
        });
      }

      /* ================= RENDER DE FILAS ================= */
      function renderTable(){
        const rows = filteredRows();
        const total = rows.length;
        const size = getPageSize();
        const pages = Math.max(1, Math.ceil(total / size));
        let page = Number(elInfo.dataset.page || 1);
        page = clamp(page, 1, pages);
        const start = (page - 1) * size;
        const slice = rows.slice(start, start + size);
        const qNorm = norm(QUERY).trim();
        const hasQ = !!qNorm;
        const maxPos = DATA.max_pos || 0;

        if (!slice.length){
          elBody.innerHTML =
            `<tr><td colspan="${3 + maxPos * 4}" class="text-center text-muted py-4">No hay filas para mostrar.</td></tr>`;
        } else {
          elBody.innerHTML = slice.map(row => {
            const nro = row.nro ?? row.item ?? '';
            const desc = String(row.descripcion || '');
            const cant = rowQty(row);

            const descHit = hasQ && norm(desc).includes(qNorm);
            const descMarked = hasQ ? highlightText(desc, QUERY) : esc(desc);

            const posByN = {};
            (row.positions || []).forEach(p => {
              posByN[+p.pos] = p;
            });

            const basePrice = cheapestPrice(row, { includedOnly: MODE === 'otros' }) || 0;
            const rnkMap = rankAmong(row, { includedOnly: MODE === 'otros' });

            const cells = [];
            for (let pos = 1; pos <= maxPos; pos++){
              if (!FILTERS.visCols.has(pos)) continue;
              const p = posByN[pos];
              const visible = !!p && showOfferByMode(p);
              const isS = visible && isSuizo(p.proveedor);
              const sCls = isS ? ' is-suizo' : '';

              // Precio
              const precioHTML = visible ? nfARS(unitPriceOf(p)) : '';

              // Relaci√≥n
              let relHTML = '';
              if (visible){
                const rank = rnkMap.get(pos);
                if (rank === 1 || basePrice <= 0){
                  relHTML = `<span class="rel-cell rel-pos-1 px-1">‚Äî</span>`;
                } else {
                  const rel = (unitPriceOf(p) / basePrice) - 1;
                  if (rank === 2){
                    relHTML = `<span class="rel-cell rel-pos-2 px-1">${pctFmt(rel)}</span>`;
                  } else if (rank === 3){
                    relHTML = `<span class="rel-cell rel-pos-3 px-1">${pctFmt(rel)}</span>`;
                  } else {
                    relHTML = `<span class="rel-cell px-1">${pctFmt(rel)}</span>`;
                  }
                }
              }

              // Asignaci√≥n
              let asigHTML = '';
              if (visible){
                const qAdj = effectiveQty(row, p);
                const req = rowQty(row);
                if (qAdj > 0 && req > 0){
                  if (qAdj >= req){
                    asigHTML = `<span class="asignada-badge asignada-full" title="Asignaci√≥n total">${qAdj.toLocaleString('es-AR')}</span>`;
                  } else {
                    asigHTML = `<span class="asignada-badge asignada-partial" title="Asignaci√≥n parcial">${qAdj.toLocaleString('es-AR')}</span>`;
                  }
                } else if (qAdj > 0){
                  asigHTML = `<span class="asignada-badge asignada-partial">${qAdj.toLocaleString('es-AR')}</span>`;
                } else {
                  asigHTML = `<span class="asignada-badge asignada-na">‚Äì</span>`;
                }
              }

              // Proveedor
              const prov = visible ? (p.proveedor || '') : '';
              const provHit = hasQ && visible && norm(prov).includes(qNorm);
              const provHTML = hasQ ? highlightText(prov, QUERY) : esc(prov);

              cells.push(
                `<td class="text-end c-price g-start${sCls}">${precioHTML}</td>`+
                `<td class="c-rel${sCls}">${relHTML}</td>`+
                `<td class="text-center c-asig${sCls}">${asigHTML}</td>`+
                `<td class="cell-prov c-prov${sCls}${provHit ? ' cell-hit' : ''}" data-pos="${pos}" data-prov="${esc(prov)}">${provHTML}</td>`
              );
            }

            const descHTML =
              `<td class="col-desc${descHit ? ' cell-hit' : ''}">`+
                `<div class="desc-wrap">`+
                  `<span class="desc-trunc">${descMarked}</span>`+
                  `<div class="desc-tip">${descMarked}</div>`+
                `</div>`+
              `</td>`;

            return (
              `<tr>`+
                `<td class="text-center col-nro">${esc(nro)}</td>`+
                descHTML+
                `<td class="text-end col-cant">${cant ? cant.toLocaleString('es-AR') : ''}</td>`+
                cells.join('')+
              `</tr>`
            );
          }).join('');
        }

        elInfo.dataset.page = page;
        elInfo.textContent = `P√°gina ${page} / ${pages}`;
        elTotal.textContent = `${total.toLocaleString('es-AR')} renglones`;
        elPrev.disabled = page <= 1;
        elNext.disabled = page >= pages;
      }

      // aplica el modo actual del treemap (proveedor / rengl√≥n)
      function applyTreemapView(){
        if (TREEMAP_VIEW === 'item'){
          window.TREEMAP_LABEL = 'Rengl√≥n';
          if (elTreemapTitle){
            elTreemapTitle.textContent = 'Proporci√≥n de presupuesto por rengl√≥n';
          }
          refreshTreemapFromData(TREEMAP_ITEM_DATA || []);
        } else {
          window.TREEMAP_LABEL = 'Proveedor';
          if (elTreemapTitle){
            elTreemapTitle.textContent = 'Proporci√≥n de presupuesto por proveedor';
          }
          refreshTreemapFromData(TREEMAP_PROV_DATA || []);
        }
      }

      /* ================= KPIs SUIZO ================= */
      function refreshSuizoKPIs(){
        const rows = filteredRows();
        let renOfer=0, renAdj=0, montoOfer=0, montoAdj=0;

        rows.forEach(r=>{
          const suizo = (r.positions || []).find(p=>isSuizo(p.proveedor));
          if (!suizo) return;

          renOfer += 1;
          montoOfer += totalOf(r, suizo);

          const qAdj = effectiveQty(r, suizo);
          if (qAdj > 0){
            renAdj += 1;
            montoAdj += unitPriceOf(suizo) * qAdj;
          }
        });

        const efMonto = montoOfer ? (montoAdj / montoOfer) : 0;
        const efReng = renOfer ? (renAdj / renOfer) : 0;

        document.getElementById('es_monto_ofertado').textContent = nfARS(montoOfer);
        document.getElementById('es_monto_adjudicado').textContent = nfARS(montoAdj);
        document.getElementById('es_efectividad_monto').textContent = pctFmt1d(efMonto);
        document.getElementById('es_renglones_ofertados').textContent = renOfer.toLocaleString('es-AR');
        document.getElementById('es_renglones_adjudicados').textContent = renAdj.toLocaleString('es-AR');
        document.getElementById('es_efectividad_renglones').textContent = pctFmt(efReng);
      }

      /* ================= GR√ÅFICOS (REFRESH) ================= */
      function refreshCharts(){
        ensureCharts();
        const rows = filteredRows();

        // Donut: Monto ofertado vs adjudicado Suizo
        let montoOferSuizo = 0,
            montoAdjSuizo = 0;

        rows.forEach(r=>{
          const suizo = (r.positions || []).find(p=>isSuizo(p.proveedor));
          if (!suizo) return;

          montoOferSuizo += offerValue(r, suizo);
          const qAdj = effectiveQty(r, suizo);
          if (qAdj > 0){
            montoAdjSuizo += unitPriceOf(suizo) * qAdj;
          }
        });

        const noAdj = Math.max(0, (montoOferSuizo || 0) - (montoAdjSuizo || 0));
        const donutData = [montoAdjSuizo, noAdj];

        if (chartDonutSuizo){
          chartDonutSuizo.options.plugins.centerPercent = { focusIndex: 0 };
          chartDonutSuizo.data.labels = ['Adjudicado','No adjudicado'];
          chartDonutSuizo.data.datasets[0].data = donutData;
          chartDonutSuizo.update('none');
        }

        // Barras posiciones Suizo (s√≥lo cuando el modo no es "otros")
        let pos = [0,0,0];
        if (MODE !== 'otros'){
          rows.forEach(r=>{
            const suizo = (r.positions || []).find(p=>isSuizo(p.proveedor));
            if (!suizo) return;
            const n = +suizo.pos;
            if (n === 1) pos[0]++;
            else if (n === 2) pos[1]++;
            else if (n >= 3) pos[2]++;
          });
        }
        if (chartBarPos){
          chartBarPos.data.datasets[0].data = pos;
          chartBarPos.update('none');
        }

        // Treemap: armamos las dos vistas (proveedor / rengl√≥n)
        TREEMAP_PROV_DATA = treemapDataFirstPlace(rows, MODE);
        TREEMAP_ITEM_DATA = treemapDataByItemFirstPlace(rows, MODE);
        applyTreemapView();

        /* ============== RESUMEN EJECUTIVO / COMPETIDORES ================= */
function computeExecutiveInfo(){
  const rows = filteredRows();

  if (!rows.length){
    return {
      suizo_part_monto: 0,
      suizo_eff_reng: 0,
      oportunidad_monto: 0,
      oportunidad_count: 0,
      perdidas: [],
      total_adj: 0,
      competitors: []
    };
  }

  let suizoAdj = 0;
  let totalAdj = 0;
  let suizoOffRows = 0;
  let suizoAdjRows = 0;
  let oportunidadMonto = 0;
  let oportunidadCount = 0;
  const perdidas = [];
  const compMap = new Map();

  rows.forEach(function (r) {
    const positions = r.positions || [];

    // 1) Sumar adjudicado real (todas las posiciones con cantidad efectiva)
    positions.forEach(function (p) {
      const qAdj = effectiveQty(r, p);
      if (!(qAdj > 0)) return;

      const val = unitPriceOf(p) * qAdj;
      if (!(val > 0)) return;

      totalAdj += val;

      const provName = String(p.proveedor || '‚Äî');
      if (isSuizo(provName)) {
        suizoAdj += val;
      } else {
        const curr = compMap.get(provName) || {
          nombre: provName,
          monto: 0,
          renglones: 0,
          cerroContraSuizo: 0
        };
        curr.monto += val;
        curr.renglones += 1;
        compMap.set(provName, curr);
      }
    });

    // 2) M√©tricas de efectividad Suizo y oportunidades
    const suizo = positions.find(function (p) { return isSuizo(p.proveedor); });
    if (suizo){
      suizoOffRows += 1;
      const qAdjSuizo = effectiveQty(r, suizo);
      if (qAdjSuizo > 0) suizoAdjRows += 1;

      const p1 = positions.find(function (p) { return +p.pos === 1; });
      const basePrice = p1 ? unitPriceOf(p1) : 0;
      const suPrice = unitPriceOf(suizo);

      // Oportunidades: Suizo pierde por menos del 5% contra el m√°s barato
      if (p1 && !isSuizo(p1.proveedor) && basePrice > 0 && suPrice > basePrice){
        const diff = suPrice / basePrice - 1;
        if (diff <= 0.05){
          const rq = rowQty(r) || 1;
          oportunidadCount += 1;
          oportunidadMonto += basePrice * rq * diff;

          perdidas.push({
            desc: r.descripcion || '(sin descripci√≥n)',
            motivo: 'P√©rdida por ' + pctFmt1d(diff) + ' sobre el m√°s barato'
          });

          const key = String(p1.proveedor || '‚Äî');
          const curr = compMap.get(key) || {
            nombre: key,
            monto: 0,
            renglones: 0,
            cerroContraSuizo: 0
          };
          curr.cerroContraSuizo = (curr.cerroContraSuizo || 0) + 1;
          compMap.set(key, curr);
        }
      }
    }
  });

  const competitors = Array.from(compMap.values())
    .sort(function (a, b) { return b.monto - a.monto; })
    .slice(0, 5);

  const suizo_part_monto = totalAdj ? (suizoAdj / totalAdj) : 0;
  const suizo_eff_reng = suizoOffRows ? (suizoAdjRows / suizoOffRows) : 0;

  return {
    suizo_part_monto: suizo_part_monto,
    suizo_eff_reng: suizo_eff_reng,
    oportunidad_monto: oportunidadMonto,
    oportunidad_count: oportunidadCount,
    perdidas: perdidas,
    total_adj: totalAdj,
    competitors: competitors
  };
}

        function renderStrongCompetitors(info){
          if (!elStrongCompetitors) return;
          if (info.competitors && info.competitors.length){
            elStrongCompetitors.innerHTML = info.competitors.map(c =>
              `<div class="sc-item">
                <div class="sc-name" title="${esc(c.nombre)}">${esc(c.nombre)}</div>
                <div class="sc-value">${nfARS(c.monto)}</div>
                <div class="sc-meta">
                  ${c.cerroContraSuizo ? `${c.cerroContraSuizo}√ó vs Suizo` : `${c.renglones} rengl.`}
                </div>
              </div>`
            ).join('');
          } else {
            elStrongCompetitors.innerHTML =
              `<div class="text-muted" style="font-size:.7rem;">No se detectaron competidores fuertes en este proceso.</div>`;
          }
        }

        function renderExecutive(info){
          if (!info) return;
          const m1 = document.getElementById('ms_part_monto');
          const m2 = document.getElementById('ms_ef_reng');
          const m3 = document.getElementById('ms_oportunidad');
          const m4 = document.getElementById('ms_estado');

          if (m1) m1.textContent = pctFmt1d(info.suizo_part_monto);
          if (m2) m2.textContent = pctFmt1d(info.suizo_eff_reng);
          if (m3){
            m3.textContent = info.oportunidad_count > 0
              ? `${nfARS(info.oportunidad_monto)} (${info.oportunidad_count} reng.)`
              : 'Sin oportunidades claras';
          }

          if (elOppBar){
            elOppBar.style.display = 'inline-flex';
            if (info.oportunidad_count > 0){
              elOppText.textContent =
                `Se perdieron ${info.oportunidad_count} renglones por menos del 5%. `+
                `Monto recuperable aprox: ${nfARS(info.oportunidad_monto)}.`;
            } else {
              elOppText.textContent =
                'No se detectaron renglones perdidos por poca diferencia.';
            }
          }

          if (m4){
            const pill = m4.querySelector('.ms-pill');
            if (pill){
              pill.classList.remove('ok','warn','danger');
              if (info.total_adj === 0){
                pill.textContent = 'Sin adjudicar';
                pill.classList.add('warn');
              } else if (info.suizo_part_monto >= 0.5 || info.suizo_eff_reng >= 0.5){
                pill.textContent = 'Bueno';
                pill.classList.add('ok');
              } else if (info.suizo_part_monto > 0 || info.suizo_eff_reng > 0){
                pill.textContent = 'Competitivo';
                pill.classList.add('warn');
              } else {
                pill.textContent = 'Perdido';
                pill.classList.add('danger');
              }
            }
          }

          renderStrongCompetitors(info);

          if (elLossExpl && elLossList && elLossHint){
            if (info.perdidas && info.perdidas.length){
              elLossExpl.hidden = false;
              elLossList.innerHTML = info.perdidas.slice(0,7)
                .map(p=>`<li>${esc(p.desc)} ‚Äî ${esc(p.motivo)}</li>`).join('');
              elLossHint.textContent = info.perdidas.length > 7
                ? `+ ${info.perdidas.length - 7} m√°s‚Ä¶`
                : `Se analizaron ${info.perdidas.length} renglones con oportunidad.`;
            } else {
              elLossExpl.hidden = true;
              elLossList.innerHTML = '';
              elLossHint.textContent = '';
            }
          }
        }

        const info = computeExecutiveInfo();
        renderExecutive(info);
      }

      /* ================= RENDER GLOBAL ================= */
      function renderAll(){
        renderTable();
        refreshSuizoKPIs();
        refreshCharts();
      }

      /* ================= UI & EVENTOS ================= */
      const setTabs = (btn) => {
        document.querySelectorAll('.segmented .seg-btn').forEach(b=>{
          const active = b === btn;
          b.classList.toggle('active', active);
          b.setAttribute('aria-selected', active ? 'true' : 'false');
        });
      };

      document.getElementById('tabSuizo').onclick = (e)=>{
        e.preventDefault();
        setTabs(e.currentTarget);
        setMode('suizo');
      };
      document.getElementById('tabOtros').onclick = (e)=>{
        e.preventDefault();
        setTabs(e.currentTarget);
        setMode('otros');
      };
      document.getElementById('tabTodos').onclick = (e)=>{
        e.preventDefault();
        setTabs(e.currentTarget);
        setMode('todos');
      };

      // switch "Proveedor / Rengl√≥n" del treemap
      if (elTreemapModeToggle){
        elTreemapModeToggle.addEventListener('click', (e)=>{
          const btn = e.target.closest('button[data-mode]');
          if (!btn) return;
          const mode = btn.dataset.mode === 'item' ? 'item' : 'prov';
          TREEMAP_VIEW = mode;

          // actualizar estado visual del switch
          elTreemapModeToggle.querySelectorAll('.mini-btn').forEach(b=>{
            const active = b === btn;
            b.classList.toggle('active', active);
            b.setAttribute('aria-pressed', active ? 'true' : 'false');
          });

          applyTreemapView();
        });
      }

      const debounce = (fn,ms)=>{
        let t;
        return (...a)=>{
          clearTimeout(t);
          t = setTimeout(()=>fn(...a), ms);
        };
      };

      elPrev.onclick = ()=>{
        elInfo.dataset.page = String((+elInfo.dataset.page || 1) - 1);
        renderAll();
      };
      elNext.onclick = ()=>{
        elInfo.dataset.page = String((+elInfo.dataset.page || 1) + 1);
        renderAll();
      };
      elPageSz.onchange = ()=>{
        elInfo.dataset.page = 1;
        renderAll();
      };

      elSearch.oninput = debounce(()=>{
        QUERY = elSearch.value || '';
        elInfo.dataset.page = 1;
        renderAll();
      },150);

      // Quitar chips
      elChip.addEventListener('click', e=>{
        const btn = e.target.closest('button');
        if (!btn) return;
        const chip = btn.closest('.sel-chip');
        const key = chip?.dataset.key;
        if (!key) return;

        if (key === 'provider') FILTERS.provider = null;
        if (key === 'posBuckets'){
          FILTERS.posBuckets.clear();
          const max = DATA.max_pos || 0;
          FILTERS.visCols = new Set([1,2,3].filter(n=>n<=max));
          buildHead(max);
          updatePosButtonsUI();
        }
        renderChips();
        elInfo.dataset.page = 1;
        renderAll();
      });

      // Click proveedor -> filtro
      elBody.addEventListener('click', e=>{
        const td = e.target.closest('td.cell-prov');
        if (!td) return;
        const prov = (td.dataset.prov || '').trim();
        if (prov) window.setFilter('provider', prov);
      });

      // Chips posiciones
      elPosCols.addEventListener('click', e=>{
        const b = e.target.closest('.pos-chip');
        if (!b) return;
        const p = +b.dataset.pos;
        const key = String(p);

        if (e.altKey){
          if (FILTERS.visCols.has(p)) FILTERS.visCols.delete(p);
          else FILTERS.visCols.add(p);
          buildHead(DATA.max_pos || 0);
          renderTable();
          updateHeadOffsets();
          return;
        }

        if (FILTERS.posBuckets.has(key)){
          FILTERS.posBuckets.delete(key);
          FILTERS.visCols.delete(p);
        } else {
          FILTERS.posBuckets.add(key);
          FILTERS.visCols.add(p);
        }
        updatePosButtonsUI();
        buildHead(DATA.max_pos || 0);
        updateHeadOffsets();
        elInfo.dataset.page = 1;
        renderAll();
        renderChips();
      });

      window.addEventListener('resize', updateHeadOffsets);

      /* ================= CARGA DE DATOS ================= */
      async function loadRanking(){
        elBody.innerHTML = '<tr><td class="text-center text-muted py-4">Cargando‚Ä¶</td></tr>';
        let data = null;
        try{
          const res = await fetch(RANK_API, { headers:{'accept':'application/json'} });
          if (res && res.ok) data = await res.json();
        }catch(_){}

        if (!data){
          elBody.innerHTML = '<tr><td class="text-center text-danger py-4">No se pudo cargar el ranking</td></tr>';
          return;
        }

        if (Array.isArray(data.rows) && data.rows.length && data.rows[0].positions){
          DATA = {
            rows: data.rows,
            max_pos: Number(data.max_pos || 3),
            total_rows: Number(data.total_rows || data.rows.length)
          };
        } else {
          // Fallback tabular gen√©rico
          const cols = data.columns || [];
          const findIdx = name =>
            cols.findIndex(c => String(c).toLowerCase() === String(name).toLowerCase());
          const tryIdx = cands => {
            for (const n of cands){
              const i = findIdx(n);
              if (i !== -1) return i;
            }
            return -1;
          };

          const rows = (data.rows || []).map(arr => {
            const obj = {
              nro: arr[tryIdx(['N¬∞','Nro','N¬∫','Item'])],
              descripcion: arr[tryIdx(['Descripci√≥n','Descripcion','Descripci√≥n del rengl√≥n','Descripci√≥n rengl√≥n'])],
              cantidad_solicitada: arr[tryIdx(['Cantidad solicitada','Cant. solicitada','Cantidad requerida','Cantidad','Cant.','Qty','Unidades'])],
              positions: []
            };

            let pos = 1;
            while (true){
              const iProv = tryIdx([`${pos}¬∞ Proveedor`, `${pos}¬∞ proveedor`]);
              if (iProv === -1) break;
              const iPrice = tryIdx([`${pos}¬∞ Precio unitario`, `${pos}¬∞ Precio`, `${pos}¬∞ Precio Unitario`]);
              if (iPrice === -1) break;
              const iQtyOff = tryIdx([`${pos}¬∞ Cantidad ofertada`, `${pos}¬∞ Cantidad`, `${pos}¬∞ Cant.`]);

              obj.positions.push({
                pos,
                proveedor: arr[iProv],
                precio: arr[iPrice],
                cantidad: iQtyOff !== -1 ? arr[iQtyOff] : undefined
              });
              pos++;
            }
            return obj;
          });

          DATA = {
            rows,
            max_pos: Math.max(0, ...rows.map(r=>r.positions.length)) || 3,
            total_rows: rows.length
          };
        }

        const max = DATA.max_pos || 0;
        FILTERS.visCols = new Set([1,2,3].filter(n=>n<=max));
        buildHead(max);
        buildPosCols(max);
        elInfo.dataset.page = 1;
        renderChips();
        renderAll();
        updateHeadOffsets();
      }

      loadRanking();

      // Refrescar treemap si CHART_PROV lleg√≥ antes
      setTimeout(()=>{
        if (Array.isArray(window.CHART_PROV)){
          refreshTreemapFromData(window.CHART_PROV);
        }
      },600);
    })();
  </script>

  <!-- 3) Treemap proveedores -->
  <script>
    (function(){
      const SA_AZUL='#064066',
            SA_GRIS='#dce3ee',
            SA_BLANCO='#ffffff';

      let treemapChart=null;
      let buildLock=null;

      const isSuizo = s => /suizo/i.test(String(s||''));
      const nfARS = v =>
        new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0})
          .format(+v||0);

      const waitUntil = (testFn,{tries=200,every=50}={}) =>
        new Promise(res=>{
          (function loop(n){
            if (testFn()) return res(true);
            if (n <= 0) return res(false);
            setTimeout(()=>loop(n-1), every);
          })(tries);
        });

      const buildDataset = (data) => ({
        tree: (data || []).map(d => ({
          g: String(d.label || d.name || '‚Äî'),
          v: +d.value || 0
        })),
        groups: ['g'],
        key: 'v',
        spacing: 1,
        borderWidth: 2,
        borderColor: SA_BLANCO,
        labels: {
          display: true,
          overflow: 'hidden',
          position: 'center',
          padding: 3,
          color: ctx => isSuizo(ctx.raw?.g) ? '#ffffff' : SA_AZUL,
          font: ctx => {
            const box = ctx.raw && ctx.raw._data;
            const h = box ? (box.y1 - box.y0) : 0;
            const size = h ? Math.max(9, Math.min(14, Math.floor(h / 2.8))) : 12;
            return { weight: 600, size };
          },
          formatter: ctx => {
            const g = ctx.raw?.g || '‚Äî';
            const v = +ctx.raw?.v || 0;
            const box = ctx.raw && ctx.raw._data;
            const w = box ? (box.x1 - box.x0) : 999;
            let name = g;
            if (w < 80 && name.length > 14) name = name.slice(0,13) + '‚Ä¶';
            else if (w < 120 && name.length > 22) name = name.slice(0,21) + '‚Ä¶';
            else if (name.length > 30) name = name.slice(0,29) + '‚Ä¶';

            const h = box ? (box.y1 - box.y0) : 999;
            if (h < 38) return name;

            const c = new Intl.NumberFormat('es-AR', {
              notation: 'compact',
              compactDisplay: 'short',
              maximumFractionDigits: 1
            });
            return [name, c.format(v)];
          }
        },
        backgroundColor: ctx => isSuizo(ctx.raw?.g) ? SA_AZUL : SA_GRIS
      });

      function createBarFallback(ctx, data){
        const L = (data || []).map(d=>String(d.label||d.name||'‚Äî'));
        const V = (data || []).map(d=>+d.value||0);
        return new Chart(ctx,{
          type:'bar',
          data:{
            labels:L,
            datasets:[{
              data:V,
              backgroundColor:SA_GRIS,
              borderColor:'#fff',
              borderWidth:2
            }]
          },
          options:{
            indexAxis:'y',
            maintainAspectRatio:false,
            plugins:{ legend:{ display:false } },
            layout:{ padding:2 }
          }
        });
      }

      function attachClick(canvas, chart){
        if (!canvas || !chart) return;
        if (canvas.__treemapClickBound) return;
        canvas.__treemapClickBound = true;

        canvas.addEventListener('click',evt=>{
          const els = chart.getElementsAtEventForMode(evt,'nearest',{intersect:true},true);
          if (!els.length) return;
          const i = els[0].index ?? 0;
          let label = '';
          if (chart.config.type === 'bar'){
            label = chart.data.labels?.[i] || '';
          } else {
            const ds = chart.data.datasets[0];
            label = (ds.tree?.[i]?.g) || '';
          }
          if (label && window.setFilter) window.setFilter('provider', label);
        });
      }

      async function buildOrUpgrade(canvas){
        if (window.Chart && Chart.getChart){
          const existing = Chart.getChart(canvas);
          if (existing){
            attachClick(canvas, existing);
            treemapChart = existing;
            return existing;
          }
        }

        const ctx = canvas.getContext('2d');
        const hasTreemap = !!(Chart?.registry?.getController?.('treemap'));
        if (!hasTreemap){
          const fb = createBarFallback(ctx, window.CHART_PROV || []);

          (async ()=>{
            const ok = await waitUntil(()=>!!(Chart?.registry?.getController?.('treemap')), {tries:120,every:100});
            if (!ok) return;

            const exists = Chart.getChart(canvas);
            if (exists){
              try{ fb.destroy(); }catch(_){}
              treemapChart = exists;
              attachClick(canvas, exists);
              return;
            }

            try{ fb.destroy(); }catch(_){}
            treemapChart = new Chart(ctx,{
              type:'treemap',
              data:{ datasets:[buildDataset(window.CHART_PROV || [])] },
              options:{
                responsive:true,
                maintainAspectRatio:false,
                layout:{ padding:2 },
                plugins:{
                  legend:{ display:false },
                  tooltip:{
                    callbacks:{
                      title:()=> (window.TREEMAP_LABEL || 'Proveedor'),
                      label:tt=>`${tt.raw?.g || '‚Äî'}: ${nfARS(+tt.raw?.v || 0)}`
                    }
                  }
                }
              }
            });
            attachClick(canvas, treemapChart);
          })();

          return fb;
        }

        const existing = Chart.getChart(canvas);
        if (existing){
          attachClick(canvas, existing);
          treemapChart = existing;
          return existing;
        }

        const chart = new Chart(ctx,{
          type:'treemap',
          data:{ datasets:[buildDataset(window.CHART_PROV || [])] },
          options:{
            responsive:true,
            maintainAspectRatio:false,
            layout:{ padding:2 },
            plugins:{
              legend:{ display:false },
              tooltip:{
                callbacks:{
                  title:()=> (window.TREEMAP_LABEL || 'Proveedor'),
                  label:tt=>`${tt.raw?.g || '‚Äî'}: ${nfARS(+tt.raw?.v || 0)}`
                }
              }
            }
          }
        });
        attachClick(canvas, chart);
        treemapChart = chart;
        return chart;
      }

      async function ensureChart(){
        const canvas = document.getElementById('treemapProveedores');
        if (!canvas) return null;
        const ok = await waitUntil(()=>!!window.Chart);
        if (!ok) return null;

        if (buildLock) return buildLock;
        buildLock = buildOrUpgrade(canvas)
          .then(c => (treemapChart = c))
          .finally(()=>{ buildLock = null; });
        return buildLock;
      }

            window.updateTreemap = async function(data){
        window.CHART_PROV = Array.isArray(data) ? data : [];
        const chart = await ensureChart();
        if (!chart) return;

        // Actualizamos s√≥lo la gr√°fica
        if (chart.config?.type === 'bar'){
          chart.data.labels = (window.CHART_PROV || []).map(d => String(d.label || d.name || '‚Äî'));
          chart.data.datasets[0].data = (window.CHART_PROV || []).map(d => +d.value || 0);
          chart.update('none');
        } else {
          chart.data.datasets[0] = buildDataset(window.CHART_PROV || []);
          chart.update('none');
        }

        // === TOTAL ADJUDICADO (KPI + texto "Adjudicado") ===
        const totalFromData = (window.CHART_PROV || [])
          .reduce((s, x) => s + (+x.value || 0), 0);

        // Si el backend nos dio un total ‚Äúbueno‚Äù, usamos ese (incluye parciales).
        const globalTotal = (window.__KPI_AWARDED_TOTAL != null
          ? +window.__KPI_AWARDED_TOTAL
          : null);

        const finalTotal = (globalTotal && globalTotal > 0) ? globalTotal : totalFromData;

        const lbl = document.getElementById('treemapTotal');
        const kpi = document.getElementById('treemapTotalKpi');

        if (lbl) lbl.textContent = finalTotal ? `Adjudicado: ${nfARS(finalTotal)}` : '';
        if (kpi) kpi.textContent = nfARS(finalTotal || 0);
      };

      if (Array.isArray(window.CHART_PROV)){
        window.updateTreemap(window.CHART_PROV);
      } else {
        ensureChart();
      }
    })();
  </script>

  <!-- 4) Vistas guardadas (localStorage, solo front) -->
  <script>
    (function () {
      const VIEW_ID = 'dashboard';
      const CONTEXT_ID = String({{ upload_id|tojson }});
      const LS_KEY = `views:${VIEW_ID}:${CONTEXT_ID}`;

      const $ = (sel, root=document) => root.querySelector(sel);
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

      const waitUntil = (testFn,{tries=40,every=200}={}) =>
        new Promise(resolve=>{
          (function loop(n){
            if (testFn()) return resolve(true);
            if (n <= 0) return resolve(false);
            setTimeout(()=>loop(n-1), every);
          })(tries);
        });

      const dispatchInput = (el,type='input')=>{
        if (!el) return;
        el.dispatchEvent(new Event(type,{bubbles:true,cancelable:true}));
      };

      function readViews(){
        try{
          const raw = localStorage.getItem(LS_KEY);
          if (!raw) return [];
          const arr = JSON.parse(raw);
          return Array.isArray(arr) ? arr : [];
        }catch{ return []; }
      }

      function writeViews(list){
        try{
          localStorage.setItem(LS_KEY, JSON.stringify(list || []));
        }catch{}
      }

      function saveViewLS({id=null,name,is_default=false,payload}){
        const list = readViews();
        const now = new Date().toISOString();
        if (!id){
          id = Date.now().toString(36) + Math.random().toString(36).slice(2,8);
          list.push({id,name,is_default,payload,updated_at:now});
        } else {
          const idx = list.findIndex(v=>v.id===id);
          if (idx >= 0){
            list[idx] = {...list[idx],name,is_default,payload,updated_at:now};
          } else {
            list.push({id,name,is_default,payload,updated_at:now});
          }
        }

        if (is_default){
          list.forEach(v=>{
            if(v.id !== id) v.is_default = false;
          });
        }

        writeViews(list);
        return list.find(v=>v.id===id);
      }

      function deleteViewLS(id){
        writeViews(readViews().filter(v=>v.id!==id));
      }

      function setDefaultLS(id){
        writeViews(readViews().map(v=>({...v,is_default:v.id===id})));
      }

      function clearDefaultLS(id){
        writeViews(readViews().map(v=>({...v,is_default:v.id===id?false:v.is_default})));
      }

      function getDefaultLS(){
        return readViews().find(v=>v.is_default) || null;
      }

      const btnViews = $('#btnViews');
      const mod = $('#viewsModal');
      const bd = $('#viewsBackdrop');
      const btnClose = $('#vmClose');
      const btnClose2 = $('#vmClose2');
      const btnSave = $('#vmSave');
      const btnRefresh = $('#vmRefresh');
      const inputName = $('#vmName');
      const inputDefault= $('#vmDefault');
      const listBox = $('#viewsList');

      function collectCurrentView(){
        const supplier_filter = $('.segmented .seg-btn.active')?.dataset.mode || 'todos';

        const fitBtn = $('#viewToggle .mini-btn.active');
        const fit_mode = fitBtn?.dataset.view === 'fit' ? 'fit' : 'normal';

        const densBtn = $('#densityToggle .mini-btn.active');
        const density = densBtn?.dataset.density || 'normal';

        const search_query = $('#search')?.value || '';
        const page_size = Number($('#pageSize')?.value || 50) || 50;

        const vis_cols = $$('#rankHead .pos-group-head')
          .map(th => +th.dataset.pos)
          .filter(n => Number.isFinite(n));

        const pos_buckets = $$('#posCols .pos-chip.active')
          .map(b => b.dataset.pos);

        const header_filters = {
          nro: $('#f_nro')?.value || '',
          desc: $('#f_desc')?.value || '',
          cant: $('#f_cant')?.value || ''
        };

        vis_cols.forEach(pos=>{
          const rel = $(`#rankHead [data-pos="${pos}"][data-ft="relmax"]`)?.value || '';
          const prov = $(`#rankHead [data-pos="${pos}"][data-ft="prov"]`)?.value || '';
          header_filters[pos] = { relmax:rel, prov:prov };
        });

        let provider = null;
        const provChip = $('#selectionChip .sel-chip[data-key="provider"]');
        if (provChip){
          provider = (provChip.textContent || '').replace('√ó','').trim();
        }

        return {
          supplier_filter,
          fit_mode,
          density,
          vis_cols,
          pos_buckets,
          header_filters,
          provider,
          search_query,
          page_size
        };
      }

      async function applyViewPayload(payload){
        if (!payload || typeof payload !== 'object') return;
        const ok = await waitUntil(()=>$('#rankHead') && $('#posCols'));
        if (!ok) return;
        await waitUntil(()=>$('#rankHead input#f_desc'));

        if (payload.supplier_filter === 'suizo') $('#tabSuizo')?.click();
        else if (payload.supplier_filter === 'otros') $('#tabOtros')?.click();
        else $('#tabTodos')?.click();

        if (payload.fit_mode === 'fit') $('#viewToggle .mini-btn[data-view="fit"]')?.click();
        else $('#viewToggle .mini-btn[data-view="normal"]')?.click();

        if (payload.density === 'compact') $('#densityToggle .mini-btn[data-density="compact"]')?.click();
        else $('#densityToggle .mini-btn[data-density="normal"]')?.click();

        if ($('#pageSize') && payload.page_size){
          $('#pageSize').value = String(payload.page_size);
          dispatchInput($('#pageSize'),'change');
        }

        if (Array.isArray(payload.vis_cols) && payload.vis_cols.length){
          const want = new Set(payload.vis_cols.map(String));
          await waitUntil(() => $$('#posCols .pos-chip').length > 0);

          $$('#posCols .pos-chip').forEach(chip=>{
            const pos = chip.dataset.pos;
            const headExists = !!document.querySelector(
              `#rankHead .pos-group-head[data-pos="${pos}"]`
            );
            const should = want.has(pos);
            if (headExists !== should){
              chip.dispatchEvent(
                new MouseEvent('click',{bubbles:true,altKey:true})
              );
            }
          });
        }

        if (Array.isArray(payload.pos_buckets)){
          const wantBuckets = new Set(payload.pos_buckets.map(String));
          await waitUntil(()=>$$('#posCols .pos-chip').length > 0);

          $$('#posCols .pos-chip').forEach(chip=>{
            const pos = chip.dataset.pos;
            const isActive = chip.classList.contains('active');
            const should = wantBuckets.has(pos);
            if (isActive !== should){
              chip.click();
            }
          });
        }

        const H = payload.header_filters || {};
        if ($('#f_nro') && H.nro != null){
          $('#f_nro').value = H.nro;
          dispatchInput($('#f_nro'));
        }
        if ($('#f_desc') && H.desc != null){
          $('#f_desc').value = H.desc;
          dispatchInput($('#f_desc'));
        }
        if ($('#f_cant') && H.cant != null){
          $('#f_cant').value = H.cant;
          dispatchInput($('#f_cant'));
        }

        if (Array.isArray(payload.vis_cols)){
          payload.vis_cols.forEach(pos=>{
            const conf = H[pos] || {};
            const r = document.querySelector(
              `#rankHead [data-pos="${pos}"][data-ft="relmax"]`
            );
            const p = document.querySelector(
              `#rankHead [data-pos="${pos}"][data-ft="prov"]`
            );
            if (r){
              r.value = conf.relmax || '';
              dispatchInput(r);
            }
            if (p){
              p.value = conf.prov || '';
              dispatchInput(p);
            }
          });
        }

        if (payload.provider && typeof window.setFilter === 'function'){
          window.setFilter('provider', payload.provider);
        } else {
          const clearProv = $('#selectionChip .sel-chip[data-key="provider"] button');
          if (clearProv) clearProv.click();
        }

        if ($('#search')){
          $('#search').value = payload.search_query || '';
          dispatchInput($('#search'));
        }
      }

      function renderViewsList(views){
        if (!Array.isArray(views) || !views.length){
          listBox.innerHTML =
            '<div class="row"><div class="nm text-muted">Sin vistas guardadas a√∫n.</div></div>';
          return;
        }
        listBox.innerHTML = views.map(v =>
          `<div class="row" data-id="${v.id}">
            <div>
              <span class="nm">${v.name || 'Sin nombre'}</span>
              ${v.is_default ? '<span class="tag">por defecto</span>' : ''}
              ${
                v.updated_at
                  ? `<span class="text-muted small ms-2">${new Date(v.updated_at).toLocaleString('es-AR')}</span>`
                  : ''
              }
            </div>
            <div class="act">
              <button data-act="apply">Aplicar</button>
              ${
                v.is_default
                  ? '<button data-act="nodefault">Quitar defecto</button>'
                  : '<button data-act="default">Establecer por defecto</button>'
              }
              <button data-act="delete" style="color:#b91c1c">Eliminar</button>
            </div>
          </div>`
        ).join('');
      }

      function refreshList(){
        renderViewsList(readViews());
      }

      function openModal(){
        refreshList();
        mod.hidden = false;
        bd.hidden = false;
      }
      function closeModal(){
        mod.hidden = true;
        bd.hidden = true;
        inputName.value = '';
        inputDefault.checked = false;
      }

      btnViews && btnViews.addEventListener('click', openModal);
      btnClose && btnClose.addEventListener('click', closeModal);
      btnClose2 && btnClose2.addEventListener('click', closeModal);
      bd && bd.addEventListener('click', closeModal);
      btnRefresh&& btnRefresh.addEventListener('click', refreshList);

      btnSave && btnSave.addEventListener('click', async ()=>{
        const name = (inputName.value || '').trim() || 'Mi vista';
        const is_default = !!inputDefault.checked;
        await waitUntil(()=>$('#rankHead tr.filters-row'));
        const payload = collectCurrentView();
        saveViewLS({ name, is_default, payload });
        refreshList();
        inputName.value = '';
        inputDefault.checked = false;
      });

      listBox && listBox.addEventListener('click', async e=>{
        const btn = e.target.closest('button[data-act]');
        if (!btn) return;
        const row = btn.closest('.row');
        const id = row?.dataset.id;
        if (!id) return;
        const act = btn.dataset.act;
        const all = readViews();
        const item = all.find(v=>v.id===id);
        if (!item) return;

        if (act === 'apply'){
          await applyViewPayload(item.payload || {});
          closeModal();
        }
        if (act === 'delete'){
          if (confirm('¬øEliminar esta vista?')){
            deleteViewLS(id);
            refreshList();
          }
        }
        if (act === 'default'){
          setDefaultLS(id);
          refreshList();
        }
        if (act === 'nodefault'){
          clearDefaultLS(id);
          refreshList();
        }
      });

      (async function autoApplyDefault(){
        const def = getDefaultLS();
        if (!def) return;
        const ok = await waitUntil(()=>$('#rankHead') && $('#posCols'));
        if (!ok) return;
        await applyViewPayload(def.payload || {});
      })();

      window.__collectView = collectCurrentView;
      window.__applyView = applyViewPayload;
    })();
  </script>

  <!-- Comentarios -->
  <script defer src="{{ url_for('static', path='js/comments.js') }}?v=2025-10-27-2"></script>
{% endblock %}
