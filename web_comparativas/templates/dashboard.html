{% extends "base.html" %}

{% block title %}Tablero ‚Äì Web Comparativas{% endblock %}

{% block extra_head %}
  <!-- Fuente Outfit -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --sa-azul:#064066;
      --sa-azul-btn:#5274ce;
      --sa-gris-soft:#eef2f7;
      --sa-gris-borde:#e5e7eb;
      --sa-blanco:#ffffff;
      --sa-text:#064066;
      --sa-amarillo:#eeede8;

      --search-hit-bg:#e6f8ff;

      /* alturas */
      --chart-bar-height:300px;
      --chart-donut-height:260px;
      --chart-treemap-height:340px;
      --chart-half-height:260px;

      /* Columna descripci√≥n compacta */
      --desc-col-w:160px;

      /* Anchuras para columnas fijas y subcolumnas */
      --col-nro-w:44px;
      --cant-col-w:90px;
      --w-price:110px;
      --w-rel:90px;
      --w-asig:84px;
      --w-prov:180px;

      /* offset din√°mico para segunda fila del thead (se setea por JS) */
      --head-row1-h: 40px;

      /* degrad√© suave */
      --grad-soft: linear-gradient(180deg,#f6f9fc 0%, #ffffff 85%);
    }

    #fitContainer.compact{
      --chart-bar-height:220px;
      --chart-donut-height:200px;
      --chart-treemap-height:260px;
      --chart-half-height:200px;
    }

    /* CONTENEDOR AJUSTABLE (para zoom/fit) */
    .fit-container{
      --fit-scale:1;
      transform-origin: top left;
    }
    .fit-container.scaled{
      transform: scale(var(--fit-scale));
    }

    /* Tipograf√≠a & base */
    body{
      font-family:"Outfit", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color:var(--sa-text);
      font-weight:300
    }

    /* Controles (toolbar arriba) */
    .mini-toggle{background:var(--sa-gris-soft);border:1px solid var(--sa-gris-borde);border-radius:.5rem;padding:.25rem;display:inline-flex;gap:.25rem}
    .mini-toggle .mini-btn{border:0;background:transparent;padding:.35rem .6rem;border-radius:.4rem;font-size:.85rem;color:var(--sa-text);cursor:pointer}
    .mini-toggle .mini-btn.active{background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.06)}

    /* versi√≥n m√°s chiquita para el treemap */
    .mini-toggle.tiny{
      padding:.15rem;
    }
    .mini-toggle.tiny .mini-btn{
      padding:.18rem .45rem;
      font-size:.75rem;
    }

    /* Controles locales en zona de tabla (fallback si no existe el toolbar) */
    .mini-group{
      display: inline-flex;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 9999px;
      overflow: hidden;
    }
    .mini-group .mini-btn{
      border: 0;
      background: transparent;
      padding: 4px 14px;
      font-size: 0.75rem;
      color: #064066;
      cursor: pointer;
    }
    .mini-group .mini-btn.active{
      background: #dce3ee;
      font-weight: 600;
    }

    /* ===== Encabezado ===== */
    .process-header{
      background:#fff;
      border-radius:.9rem;
      box-shadow:0 1px 2px rgba(0,0,0,.06);
      padding:1rem 1.2rem;
      display:grid;
      grid-template-columns:1fr auto;
      gap:.9rem 1rem;
      align-items:start;
      border:1px solid var(--sa-gris-borde)
    }
    @media (max-width:992px){
      .process-header{grid-template-columns:1fr}
    }

    .ph-left{min-width:0}
    .ph-title{display:flex;align-items:baseline;gap:.6rem;flex-wrap:wrap;color:var(--sa-azul)}
    .ph-title .label{font-size:1.05rem;letter-spacing:.02em;text-transform:uppercase;font-weight:800}
    .ph-title .nro{font-size:1rem;font-weight:400;line-height:1}

    /* Metadatos */
    .ph-meta-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:.5rem .9rem;
      margin-top:.35rem
    }
    .ph-kv{display:flex;flex-direction:column}
    .ph-kv .k{
      font-size:.95rem;
      text-transform:uppercase;
      letter-spacing:.04em;
      color:var(--sa-azul);
      font-weight:800
    }
    .ph-kv .v{
      font-size:.9rem;
      font-weight:300;
      color:var(--sa-text)
    }

    /* Botones de la derecha (Vistas | Descargar normalized) */
    .ph-actions{
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:.5rem;
      flex-wrap:nowrap;
    }
    .ph-actions .btn-primary{
      background:var(--sa-azul-btn)!important;
      border-color:var(--sa-azul-btn)!important
    }
    @media (max-width: 768px){
      .ph-actions{flex-wrap:wrap;}
    }

    /* Layout principal */
    .dashboard-grid{
      display:grid;
      grid-template-columns:repeat(12,minmax(0,1fr));
      gap:1rem;
      align-items:stretch
    }
    .span-6{grid-column:span 6}
    @media (max-width:1200px){
      .dashboard-grid{grid-template-columns:repeat(6,minmax(0,1fr))}
      .span-lg-6{grid-column:span 6!important}
    }
    @media (max-width:768px){
      .dashboard-grid{grid-template-columns:repeat(1,minmax(0,1fr))}
      .span-sm-1{grid-column:span 1!important}
    }

    .pane{display:flex;flex-direction:column;gap:1rem}
    .pane-left{border-right:2px dashed var(--sa-gris-borde);padding-right:.5rem}
    .pane-right{padding-left:.5rem}
    @media (max-width:1200px){
      .pane-left{border-right:0;padding-right:0}
      .pane-right{padding-left:0}
    }

    /* KPI */
    .kpi-group{
      background:#fff;
      border-radius:.75rem;
      box-shadow:0 1px 2px rgba(0,0,0,.06);
      border:1px solid var(--sa-gris-borde);
      padding:.75rem 1rem
    }
    .kpi-group .group-title{
      font-size:.85rem;
      text-transform:uppercase;
      letter-spacing:.04em;
      color:var(--sa-azul);
      font-weight:800;
      margin:.1rem .2rem .6rem
    }
    .kpi-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:.6rem}
    .kpi-grid .kpi-card{
      background-image:var(--grad-soft);
      border:1px solid var(--sa-gris-borde);
      border-radius:.6rem;
      padding:.6rem .75rem
    }
    .kpi-grid .kpi-label{font-size:.78rem;color:var(--sa-text);font-weight:600;text-transform:uppercase}
    .kpi-grid .kpi-value{font-size:1.05rem;font-weight:300;color:var(--sa-text)}

    /* Gr√°ficos */
    .chart-box{
      background:#fff;
      border-radius:.75rem;
      box-shadow:0 1px 2px rgba(0,0,0,.06);
      padding:.75rem 1rem;
      position:relative;
      height:100%;
      display:flex;
      flex-direction:column;
      border:1px solid var(--sa-gris-borde)
    }
    .chart-box .title{
      font-size:.9rem;
      color:var(--sa-azul);
      font-weight:800;
      margin-bottom:.5rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.5rem
    }
    .chart-donut{height:var(--chart-donut-height)}
    .chart-bar{height:var(--chart-bar-height)}
    .chart-treemap{
      /* altura m√≠nima para pantallas bajas */
      min-height: var(--chart-treemap-height);
      /* ocupar todo el alto restante del card */
      flex: 1 1 auto;
      height: auto;
    }
    .chart-donut>canvas,
    .chart-bar>canvas,
    .chart-treemap>canvas{
      width:100%!important;
      height:100%!important;
      display:block;
      cursor:pointer
    }

    .charts-row{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:1rem}
    .charts-row .chart-donut,
    .charts-row .chart-bar{height:var(--chart-half-height)}
    @media (max-width:768px){
      .charts-row{grid-template-columns:1fr}
    }

    /* resaltado de b√∫squeda en la tabla */
    .table-wrap mark.sa-hit{
      background: rgba(0, 194, 255, .35);
      color: #064066;
      border-radius: 4px;
      padding: 0 .15rem;
    }

    /* modo suizo: que se note el proveedor */
    .table-wrap.rank-mode-suizo td.is-suizo,
    .table-wrap.rank-mode-suizo td.is-suizo .asignada-badge,
    .table-wrap.rank-mode-suizo td.is-suizo a{
      color: #064066 !important;
      font-weight: 700;
    }

    /* bloque explicaci√≥n p√©rdidas */
    .loss-explainer {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: .8rem;
      padding: .7rem .9rem .65rem;
      margin-bottom: 1rem;
    }
    .loss-title {
      font-weight: 700;
      font-size: .8rem;
      color: #064066;
      margin-bottom: .35rem;
      display: flex;
      gap: .4rem;
      align-items: center;
    }
    .loss-list {
      margin: 0;
      padding-left: 1.1rem;
      font-size: .75rem;
      color: #4b5563;
    }
    .loss-list li + li {
      margin-top: .15rem;
    }
    .loss-hint {
      font-size: .68rem;
      color: #94a3b8;
      margin-top: .35rem;
    }

    /* competidores fuertes */
    .strong-competitors {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: .8rem;
      padding: .6rem .75rem .35rem;
      margin-top: 1rem;
    }
    .strong-competitors h3 {
      font-size: .78rem;
      font-weight: 700;
      color: #064066;
      margin-bottom: .35rem;
    }
    .sc-item {
      display: flex;
      justify-content: space-between;
      gap: .5rem;
      font-size: .7rem;
      margin-bottom: .35rem;
    }
    .sc-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sc-value {
      font-weight: 600;
      color: #0f172a;
    }

    /* micro KPI oportunidad perdida */
    .opportunity-bar {
      font-size: .7rem;
      color: #0f172a;
      background: #eff6ff;
      border: 1px dashed rgba(6,64,102,.35);
      border-radius: .65rem;
      padding: .35rem .6rem;
      display: inline-flex;
      gap: .3rem;
      align-items: center;
    }
    .opportunity-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #ef4444;
    }

    /* Comentarios / vistas */
    .wc-comments-btn {
      position: fixed;
      right: 18px;
      bottom: 18px;
      background: #0b5ed7;
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(0,0,0,.18);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      z-index: 9998;
    }
    .wc-comments-btn:hover {
      filter: brightness(0.95);
    }
    .wc-badge {
      display: none !important;
    }

    .wc-comments-panel {
      position: fixed;
      top: 0;
      right: -420px;
      width: 400px;
      height: 100vh;
      z-index: 9999;
      background: #fff;
      border-left: 1px solid #e5e7eb;
      box-shadow: -8px 0 24px rgba(0,0,0,.08);
      display: flex;
      flex-direction: column;
      transition: right .22s ease;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans";
    }
    .wc-comments-panel.wc-open {
      right: 0;
    }
    .wc-hd {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px;
      border-bottom: 1px solid #e5e7eb;
      background: #f8fafc;
    }
    .wc-hd h3 {
      font-size: 16px;
      margin: 0;
    }
    #wc-comments-close {
      background:transparent;
      border:none;
      font-size: 18px;
      cursor:pointer;
      padding:6px;
      line-height:1;
    }
    #wc-comments-list {
      flex: 1;
      overflow: auto;
      padding: 10px 12px;
      background: #fff;
    }
    .wc-empty {
      color:#6b7280;
      font-size: 14px;
      text-align:center;
      margin-top: 20px;
    }
    .wc-item {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 8px 10px;
      margin-bottom: 10px;
      background: #fff;
    }
    .wc-item-resolved {
      opacity: .8;
      background: #f5f7fa;
    }
    .wc-item-hd {
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 10px;
    }
    .wc-item-author {
      font-weight: 600;
      font-size: 14px;
    }
    .wc-item-meta {
      color:#6b7280;
      font-size: 12px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .wc-parent {
      background:#eef2ff;
      color:#4338ca;
      border-radius: 6px;
      padding:2px 6px;
    }
    .wc-item-body {
      margin-top: 6px;
      white-space: pre-wrap;
      font-size: 14px;
    }
    .wc-item-ft {
      margin-top: 8px;
      display:flex;
      gap: 10px;
    }
    .wc-link {
      background:none;
      border:none;
      color:#0b5ed7;
      cursor:pointer;
      font-size: 13px;
      padding:0;
    }
    .wc-form {
      border-top: 1px solid #e5e7eb;
      padding: 10px 12px;
      background:#fafafa;
    }
    .wc-form textarea {
      width: 100%;
      min-height: 74px;
      resize: vertical;
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
    }
    .wc-form .wc-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top: 8px;
    }
    .wc-btn {
      background:#0b5ed7;
      color:#fff;
      border:none;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 14px;
      cursor:pointer;
    }
    .wc-btn:hover {
      filter: brightness(0.95);
    }
    .wc-replying {
      font-size: 12px;
      color:#4338ca;
      background:#eef2ff;
      border-radius: 6px;
      padding: 4px 8px;
    }
    .wc-hide {
      display:none;
    }

    /* Modal de Vistas */
    .views-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(6, 64, 102, .28);
      backdrop-filter: blur(1px);
      z-index: 1400;
    }
    .views-modal{
      position: fixed;
      top: 90px;
      left: 50%;
      transform: translateX(-50%);
      width: 560px;
      max-width: 96vw;
      background: #ffffff;
      border-radius: 1rem;
      box-shadow: 0 18px 40px rgba(0,0,0,.15);
      border: 1px solid #e5e7eb;
      z-index: 1401;
      display: flex;
      flex-direction: column;
      gap: 0;
      max-height: calc(100vh - 140px);
    }
    .views-modal[hidden],
    .views-backdrop[hidden]{
      display: none !important;
    }
    .views-modal .vm-head{
      padding: .9rem 1rem;
      border-bottom: 1px solid #eef2f7;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .5rem;
    }
    .views-modal .vm-head .ttl{
      font-weight: 700;
      color: #064066;
    }
    .views-modal .vm-body{
      padding: .9rem 1rem 1rem;
      gap: 1rem;
      display: grid;
      grid-template-columns: 1fr;
      overflow-y: auto;
    }
    .views-modal .vm-foot{
      padding: .6rem 1rem .9rem;
      border-top: 1px solid #eef2f7;
      display: flex;
      justify-content: flex-end;
      gap: .5rem;
      background: #fff;
    }
    .views-list .row{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .75rem;
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: .6rem;
      padding: .4rem .6rem;
      margin-bottom: .4rem;
    }
    .views-list .nm{
      font-weight: 600;
      color: #064066;
    }
    .views-list .tag{
      display: inline-block;
      background: #e0ebff;
      color: #064066;
      font-size: .68rem;
      border-radius: 999px;
      padding: 2px 10px;
      margin-left: .25rem;
    }
    .views-list .act button{
      background: none;
      border: none;
      font-size: .7rem;
      cursor: pointer;
      color: #064066;
    }
    .views-list .act button:hover{
      text-decoration: underline;
    }
    @media (max-width: 600px){
      .views-modal{
        top: 68px;
        width: 97vw;
      }
    }

    /* efecto premium KPI */
    .kpi-card {
      background: var(--sa-blanco);
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,.05);
      padding: 24px;
      transition: all .3s ease;
    }
    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(0,0,0,.08);
    }
    .kpi-title {
      font-weight: 600;
      color: var(--sa-text);
      font-size: 0.95rem;
      margin-bottom: 6px;
    }
    .kpi-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--sa-azul-btn);
    }
    .kpi-trend {
      font-size: 0.9rem;
      font-weight: 500;
      color: #22c55e;
      margin-left: 8px;
    }
    .kpi-trend.down {
      color: #ef4444;
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(15px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .fade-up {
      animation: fadeUp .6s ease forwards;
    }

    /* forzar barra superior del tablero */
    .wc-topbar,
    .page-toolbar,
    .app-toolbar,
    header.wc-topbar,
    header.page-toolbar {
      display: flex;
      align-items: center;
      gap: .75rem;
    }
    .topbar-right,
    .toolbar-right,
    .page-toolbar-right,
    .wc-topbar-right {
      margin-left: auto !important;
    }

    /* ===== Resumen ejecutivo / Vista gerente ===== */
    .manager-summary{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:.75rem;
      margin-bottom:1rem;
    }
    @media (max-width:1200px){
      .manager-summary{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }
    @media (max-width:768px){
      .manager-summary{
        grid-template-columns:1fr;
      }
    }
    .ms-card{
      background:#fff;
      border-radius:.9rem;
      border:1px solid var(--sa-gris-borde);
      box-shadow:0 1px 3px rgba(15,23,42,.06);
      padding:.75rem .9rem;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      min-height:90px;
    }
    .ms-card.fade-up{
      /* reutiliza tu animaci√≥n fadeUp ya definida */
    }
    .ms-label{
      font-size:.75rem;
      text-transform:uppercase;
      letter-spacing:.04em;
      color:var(--sa-azul);
      font-weight:800;
      margin-bottom:.35rem;
    }
    .ms-main{
      font-size:1.25rem;
      font-weight:700;
      color:var(--sa-azul-btn);
    }
    .ms-sub{
      font-size:.72rem;
      color:#64748b;
      margin-top:.25rem;
    }
    .ms-status .ms-main{
      display:flex;
      align-items:center;
      gap:.35rem;
    }
    .ms-pill{
      display:inline-flex;
      align-items:center;
      padding:2px 10px;
      border-radius:999px;
      font-size:.7rem;
      font-weight:600;
      background:#e5e7eb;
      color:#0f172a;
    }
    .ms-pill.ok{
      background:#dcfce7;
      color:#15803d;
    }
    .ms-pill.warn{
      background:#fef9c3;
      color:#854d0e;
    }
    .ms-pill.danger{
      background:#fee2e2;
      color:#b91c1c;
    }
  </style>

  <!-- Librer√≠as principales -->
  <script defer src="{{ url_for('static', path='vendor/chart.umd.min.js') }}"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@3/dist/chartjs-chart-treemap.min.js"></script>
  <script defer src="{{ url_for('static', path='js/chart-ux.js') }}"></script>
{% endblock %}

{% block page_skin %}
  <link rel="stylesheet" href="{{ url_for('static', path='css/dashboard.v2.css') }}?v=1">
{% endblock %}

{% block toolbar_actions %}
  <div class="d-flex align-items-center gap-2 flex-wrap" id="toolbarLeft">
    <div class="mini-toggle" id="viewToggle" title="Zoom del tablero" role="group" aria-label="Zoom">
      <button class="mini-btn active" data-view="normal" aria-pressed="true">100%</button>
      <button class="mini-btn" data-view="fit" aria-pressed="false">Ajustar a pantalla</button>
    </div>

    <div class="mini-toggle" id="densityToggle" title="Densidad de la vista" role="group" aria-label="Densidad">
      <button class="mini-btn active" data-density="normal" aria-pressed="true">Normal</button>
      <button class="mini-btn" data-density="compact" aria-pressed="false">Compacto</button>
    </div>
  </div>
{% endblock %}

{% block content %}
  <noscript>
    <div class="alert alert-warning my-2">Este tablero requiere JavaScript para gr√°ficos, filtros y paginaci√≥n.</div>
  </noscript>

  <div id="fitContainer" class="fit-container">
    <div class="dash-v2">
      <!-- Encabezado -->
      <section id="processHeader" class="process-header mb-3" aria-labelledby="phTitle">
        <div class="ph-left">
          <div class="ph-title">
            <span class="label">Proceso</span>
            <h1 id="phTitle" class="nro m-0">{{ upload.proceso_nro }}</h1>

            <!-- contexto que lee comments.js -->
            <div
              id="comments-context"
              data-upload-id="{{ upload_id }}"
              data-process-code="{{ upload.proceso_nro or upload.proceso or upload.proceso_code }}"
              hidden
            ></div>
          </div>

          <div class="ph-meta-grid" role="list" aria-label="Metadatos del proceso">
            <div class="ph-kv" role="listitem">
              <div class="k">Apertura</div>
              <div class="v" id="ph_apertura">{{ upload.apertura_fecha or "‚Äî" }}</div>
            </div>
            <div class="ph-kv" role="listitem">
              <div class="k">Cuenta</div>
              <div class="v">{{ upload.cuenta_nro or "‚Äî" }}</div>
            </div>
            <div class="ph-kv" role="listitem">
              <div class="k">Plataforma</div>
              <div class="v">{{ upload.platform or upload.platform_hint or "‚Äî" }}</div>
            </div>
            <div class="ph-kv" role="listitem">
              <div class="k">Comprador</div>
              <div class="v">{{ upload.buyer or upload.comprador or upload.buyer_hint or "‚Äî" }}</div>
            </div>
            <div class="ph-kv" role="listitem">
              <div class="k">Provincia/Municipio</div>
              <div class="v">{{ upload.province or upload.municipio or upload.province_hint or "‚Äî" }}</div>
            </div>
          </div>
        </div>

        <div class="ph-right">
          <div class="ph-actions">
            <button
              class="btn btn-outline-secondary btn-sm"
              id="btnViews"
              type="button"
              aria-haspopup="dialog"
              aria-controls="viewsModal"
            >
              Vistas
            </button>

            <a
              class="btn btn-primary btn-sm"
              href="/descargas/{{ upload_id }}"
              aria-label="Descargar normalized.xlsx del proceso {{ upload.proceso_nro }}"
            >
              Descargar normalized.xlsx
            </a>
          </div>
        </div>
      </section>

      <!-- Por qu√© perdimos / explicaci√≥n -->
      <section id="lossExplainer" class="loss-explainer" aria-label="Explicaci√≥n de p√©rdidas" hidden>
        <div class="loss-title">
          üìâ Por qu√© perdimos renglones en este proceso
        </div>
        <ul class="loss-list" id="lossList"></ul>
        <div class="loss-hint" id="lossHint"></div>
      </section>

      <!-- Resumen ejecutivo / vista gerente -->
      <section class="manager-summary" aria-label="Resumen ejecutivo del proceso">
        <article class="ms-card fade-up" aria-labelledby="ms_part_monto">
          <div class="ms-label">Participaci√≥n de Suizo en monto adjudicado</div>
          <div class="ms-main" id="ms_part_monto">‚Äî</div>
          <div class="ms-sub">Porcentaje del monto adjudicado que obtuvo Suizo.</div>
        </article>

        <article class="ms-card fade-up" aria-labelledby="ms_ef_reng">
          <div class="ms-label">Efectividad por renglones</div>
          <div class="ms-main" id="ms_ef_reng">‚Äî</div>
          <div class="ms-sub">Renglones adjudicados sobre renglones ofertados.</div>
        </article>

        <article class="ms-card fade-up" aria-labelledby="ms_oportunidad">
          <div class="ms-label">Oportunidad recuperable</div>
          <div class="ms-main" id="ms_oportunidad">‚Äî</div>
          <div class="ms-sub">Renglones perdidos por poca diferencia de precio.</div>
        </article>

        <article class="ms-card fade-up ms-status" id="ms_estado" aria-label="Estado general del proceso">
          <div class="ms-label">Estado general</div>
          <div class="ms-main">
            <span class="ms-pill">En an√°lisis</span>
          </div>
          <div class="ms-sub">Calculado seg√∫n participaci√≥n y efectividad de Suizo.</div>
        </article>
      </section>

      <div class="dashboard-grid mb-4">
        <!-- Izquierda -->
        <div class="pane pane-left span-6 span-lg-6 span-sm-1">
          <section class="kpi-group" aria-labelledby="kpiGenTitle">
            <h2 class="group-title m-0" id="kpiGenTitle">Datos generales de licitaci√≥n</h2>
            <div class="kpi-grid">
              <div class="kpi-card" role="group" aria-label="Presupuesto adjudicado">
                <div class="kpi-label">Presupuesto adjudicado</div>
                <div class="kpi-value" id="treemapTotalKpi">{{ kpis.get('awarded', 0) | peso }}</div>
              </div>
              <div class="kpi-card" role="group" aria-label="Renglones">
                <div class="kpi-label">Renglones</div>
                <div class="kpi-value" id="dg_renglones">{{ kpis.get('items', 0) }}</div>
              </div>
              <div class="kpi-card" role="group" aria-label="Cantidad de competidores">
                <div class="kpi-label">Cantidad de competidores</div>
                <div class="kpi-value" id="dg_competidores">{{ kpis.get('bidders', 0) }}</div>
              </div>
            </div>
          </section>

          <section class="chart-box" aria-labelledby="treemapTitle">
            <div class="title">
              <!-- t√≠tulo + total -->
              <div class="d-flex flex-column">
                <span id="treemapTitle">Proporci√≥n de presupuesto por proveedor</span>
                <div class="small text-muted" id="treemapTotal" aria-live="polite"></div>
              </div>

              <!-- switch de modo de treemap -->
              <div
                class="mini-toggle tiny"
                id="treemapModeToggle"
                role="group"
                aria-label="Modo de treemap"
              >
                <button
                  type="button"
                  class="mini-btn active"
                  data-mode="prov"
                  aria-pressed="true"
                >
                  Proveedor
                </button>
                <button
                  type="button"
                  class="mini-btn"
                  data-mode="item"
                  aria-pressed="false"
                >
                  Rengl√≥n
                </button>
              </div>
            </div>

            <div class="chart-treemap" role="img" aria-label="Treemap de adjudicaciones">
              <canvas id="treemapProveedores"></canvas>
            </div>
          </section>
        </div>

        <!-- Derecha -->
        <div class="pane pane-right span-6 span-lg-6 span-sm-1">
          <section class="kpi-group" aria-labelledby="kpiSuizoTitle">
            <h2 class="group-title m-0" id="kpiSuizoTitle">Efectividad Suizo</h2>
            <div class="kpi-grid">
              <div class="kpi-card" role="group" aria-label="Monto ofertado">
                <div class="kpi-label">Monto ofertado</div>
                <div class="kpi-value" id="es_monto_ofertado">{{ 0 | peso }}</div>
              </div>
              <div class="kpi-card" role="group" aria-label="Monto adjudicado">
                <div class="kpi-label">Monto adjudicado</div>
                <div class="kpi-value" id="es_monto_adjudicado">{{ 0 | peso }}</div>
              </div>
              <div class="kpi-card" role="group" aria-label="Efectividad por monto">
                <div class="kpi-label">Efectividad por monto</div>
                <div class="kpi-value" id="es_efectividad_monto">0%</div>
              </div>
              <div class="kpi-card" role="group" aria-label="Renglones ofertados">
                <div class="kpi-label">Renglones ofertados</div>
                <div class="kpi-value" id="es_renglones_ofertados">0</div>
              </div>
              <div class="kpi-card" role="group" aria-label="Renglones adjudicados">
                <div class="kpi-label">Renglones adjudicados</div>
                <div class="kpi-value" id="es_renglones_adjudicados">0</div>
              </div>
              <div class="kpi-card" role="group" aria-label="Efectividad por renglones">
                <div class="kpi-label">Efectividad por renglones</div>
                <div class="kpi-value" id="es_efectividad_renglones">0%</div>
              </div>
            </div>
          </section>

          <div class="charts-row">
            <section class="chart-box" aria-labelledby="donutTitle">
              <div class="title" id="donutTitle">Efectividad Suizo</div>
              <div class="chart-donut" role="img" aria-label="Efectividad Suizo (Adjudicado vs No adjudicado)">
                <canvas id="donutSuizo"></canvas>
              </div>
            </section>

            <section class="chart-box" aria-labelledby="barTitle">
              <div class="title" id="barTitle">Posiciones</div>
              <div class="chart-bar" role="img" aria-label="Distribuci√≥n de posiciones">
                <canvas id="barPosAgg"></canvas>
              </div>
            </section>
          </div>

          <!-- Competidores fuertes (debajo de los charts) -->
          <section class="strong-competitors" aria-label="Competidores fuertes en este proceso">
            <h3>Competidores fuertes</h3>
            <div id="scList">
              <div class="text-muted" style="font-size:.7rem;">Se completar√° con el ranking‚Ä¶</div>
            </div>
          </section>
        </div>
      </div>

      <!-- RANKING -->
      <section id="rankSection" class="table-wrap mb-4" aria-labelledby="rankTitle">
        <h2 id="rankTitle" class="visually-hidden">Ranking de ofertas</h2>

        <!-- micro KPI oportunidad -->
        <div id="opportunityBar" class="opportunity-bar mb-2" style="display:none;">
          <span class="opportunity-dot"></span>
          <span id="opportunityText">Hay renglones que se perdieron por muy poco.</span>
        </div>

        <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
          <!-- fallback local si no se renderiza el toolbar -->
          <div class="d-flex gap-2 flex-wrap" id="localControls">
            <div class="d-flex gap-2 flex-wrap">
              <div class="mini-group d-none" id="viewToggleLocal" role="group" aria-label="Zoom del tablero">
                <button type="button" class="mini-btn active" data-view="normal" aria-pressed="true">100%</button>
                <button type="button" class="mini-btn" data-view="fit" aria-pressed="false">Ajustar</button>
              </div>

              <div class="mini-group d-none" id="densityToggleLocal" role="group" aria-label="Densidad de filas">
                <button type="button" class="mini-btn active" data-density="normal" aria-pressed="true">Normal</button>
                <button type="button" class="mini-btn" data-density="compact" aria-pressed="false">Compacta</button>
              </div>
            </div>
          </div>

          <div class="segmented" role="tablist" aria-label="Modo de oferentes">
            <button class="seg-btn" data-mode="suizo" id="tabSuizo" role="tab" aria-selected="false">Suizo Argentina</button>
            <button class="seg-btn" data-mode="otros" id="tabOtros" role="tab" aria-selected="false">Otros oferentes</button>
            <button class="seg-btn active" data-mode="todos" id="tabTodos" role="tab" aria-selected="true">Todos</button>
          </div>

          <input
            id="search"
            class="form-control form-control-sm search"
            placeholder="Buscar descripci√≥n o proveedor‚Ä¶"
            aria-label="Buscar en la tabla"
          >

          <div
            class="pos-cols"
            id="posCols"
            title="Filtrar por posiciones (clic). ALT+clic: solo mostrar/ocultar columna"
            role="group"
            aria-label="Columnas por posici√≥n"
          ></div>

          <button
            id="toggleFilters"
            class="btn btn-sm btn-outline-secondary ms-1"
            aria-expanded="true"
            aria-controls="rankHead"
          >
            Filtros
          </button>

          <div class="vr mx-2"></div>

          <label class="small text-subtle" for="pageSize">Filas por p√°gina</label>
          <input
            id="pageSize"
            type="number"
            min="10"
            max="500"
            value="50"
            class="form-control form-control-sm"
            style="width:110px"
            aria-label="Filas por p√°gina"
          >

          <button id="prev" class="btn btn-sm btn-secondary" aria-label="P√°gina anterior">‚Äπ</button>
          <span id="pageInfo" class="small text-subtle" data-page="1" aria-live="polite"></span>
          <button id="next" class="btn btn-sm btn-secondary" aria-label="P√°gina siguiente">‚Ä∫</button>

          <div id="selectionChip" class="ms-2"></div>

          <div class="ms-auto small text-subtle" id="totalInfo" aria-live="polite"></div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-hover" id="rankTable" aria-describedby="rankTitle">
            <caption class="visually-hidden">
              Tabla de renglones con precios por posici√≥n, relaci√≥n, asignaci√≥n y proveedor.
            </caption>
            <thead id="rankHead"></thead>
            <tbody id="rankBody">
              <tr>
                <td class="text-center text-muted py-4">Cargando‚Ä¶</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </div><!-- /.dash-v2 -->
  </div>

  <!-- ===== MODAL / PANEL DE VISTAS ===== -->
  <div class="views-backdrop" id="viewsBackdrop" hidden aria-hidden="true"></div>

  <div
    class="views-modal"
    id="viewsModal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="vmTitle"
    hidden
  >
    <div class="vm-head">
      <div class="ttl" id="vmTitle">Vistas guardadas</div>
      <button id="vmClose" class="btn btn-sm btn-outline-secondary" aria-label="Cerrar modal de vistas">Cerrar</button>
    </div>

    <div class="vm-body">
      <!-- Lista de vistas -->
      <div>
        <div class="form-note mb-2">Tus vistas guardadas para este tablero.</div>
        <div class="views-list" id="viewsList">
          <div class="row">
            <div class="nm text-muted">Sin vistas guardadas a√∫n.</div>
          </div>
        </div>
      </div>

      <!-- Guardar / renombrar -->
      <div>
        <div class="form-note mb-2">
          Guard√° la configuraci√≥n actual (filtros, modo Suizo/Todos, zoom, densidad, columnas visibles y b√∫squeda).
        </div>

        <div class="vm-field">
          <label for="vmName">Nombre</label>
          <input
            type="text"
            id="vmName"
            class="form-control form-control-sm"
            placeholder="Ej: Suizo compacto"
          >
        </div>

        <div class="vm-field inline">
          <input
            type="checkbox"
            id="vmDefault"
            class="form-check-input"
            aria-describedby="vmDefaultHelp"
          >
          <label for="vmDefault" class="m-0">Establecer como mi vista por defecto</label>
        </div>
        <div id="vmDefaultHelp" class="form-note">Se cargar√° autom√°ticamente al abrir este tablero.</div>

        <div class="vm-field">
          <button id="vmSave" class="btn btn-sm btn-primary">Guardar vista</button>
        </div>

        <div class="form-note">Tip: pod√©s sobrescribir una vista si pon√©s el mismo nombre.</div>
      </div>
    </div>

    <div class="vm-foot">
      <button id="vmRefresh" class="btn btn-sm btn-outline-secondary">Actualizar lista</button>
      <button id="vmClose2" class="btn btn-sm btn-secondary">Cerrar</button>
    </div>
  </div>
  <!-- ===== /MODAL VISTAS ===== -->

  <!-- Panel / bot√≥n de comentarios -->
  <button
    id="wc-comments-toggle"
    class="wc-comments-btn"
    aria-expanded="false"
    title="Comentarios"
  >
    Comentarios
  </button>

  <aside
    id="wc-comments-panel"
    class="wc-comments-panel"
    aria-hidden="true"
    data-upload-id="{{ upload_id }}"
    data-user-display="{{ (user and (user.name or user.email)) or 'Yo' }}"
    data-user-role="{{ (user and (user.role or user.rol or ''))|lower }}"
    data-process-code="{{ upload.proceso_nro }}"
  >
    <div class="wc-hd">
      <h3>Comentarios</h3>
      <button id="wc-comments-close" aria-label="Cerrar">‚úï</button>
    </div>

    <div id="wc-comments-list" aria-live="polite" aria-busy="false"></div>

    <form id="wc-comments-form" class="wc-form" autocomplete="off">
      <input type="hidden" name="parent_id" value="">

      <div id="wc-replying" class="wc-replying wc-hide">
        Respondiendo‚Ä¶
        <button id="wc-reply-cancel" class="wc-link" type="button">cancelar</button>
      </div>

      <textarea
        name="body"
        maxlength="5000"
        required
        placeholder="Escribe un comentario‚Ä¶ (Enter para enviar, Shift+Enter para salto de l√≠nea)"
      ></textarea>

      <div class="wc-row">
        <div style="font-size:12px;color:#6b7280;">
          Se publicar√° como:
          <strong>{{ (user and (user.name or user.email)) or 'Yo' }}</strong>
        </div>
        <button class="wc-btn" type="submit">Enviar</button>
      </div>
    </form>
  </aside>
  <!-- fin m√≥dulo comentarios -->
{% endblock %}
{% block extra_js %}
<script>
(function(){
  "use strict";

  // ==========================
  // Helpers generales
  // ==========================
  function formatPeso(value){
    if(value == null || isNaN(value)) return "‚Äî";
    try{
      return new Intl.NumberFormat("es-AR", {
        style: "currency",
        currency: "ARS",
        maximumFractionDigits: 0
      }).format(value);
    } catch(e){
      return "$" + (Math.round(Number(value)) || 0).toLocaleString("es-AR");
    }
  }

  function formatPct(value){
    if(value == null || !isFinite(value)) return "‚Äî";
    return value.toFixed(1).replace(".", ",") + " %";
  }

  function safeNum(v){
    var n = Number(v);
    return isNaN(n) ? 0 : n;
  }

  // ==========================
  // Detecci√≥n Suizo / ganador
  // ==========================
  function isSuizoRow(row){
    if(!row) return false;

    if("is_suizo" in row) return !!row.is_suizo;
    if("es_suizo" in row) return !!row.es_suizo;
    if("suizo"    in row) return !!row.suizo;

    var prov = (row.proveedor || row.provider || row.proveedor_ganador || "").toString().toLowerCase();
    return prov.includes("suizo");
  }

  function isWinner(row){
    if(!row) return false;

    if("adjudicado" in row) return !!row.adjudicado;
    if("is_winner"  in row) return !!row.is_winner;
    if("ganador"    in row) return !!row.ganador;

    if("pos" in row)       return Number(row.pos) === 1;
    if("posicion" in row)  return Number(row.posicion) === 1;

    return false;
  }

  function getAwardedAmount(row){
    if(!row) return 0;

    if(row.monto_adjudicado != null) return safeNum(row.monto_adjudicado);
    if(row.awarded_amount   != null) return safeNum(row.awarded_amount);
    if(row.monto_ganador    != null) return safeNum(row.monto_ganador);
    if(row.total            != null) return safeNum(row.total);

    return 0;
  }

  function getOfferedAmount(row){
    if(!row) return 0;

    if(row.monto_ofertado  != null) return safeNum(row.monto_ofertado);
    if(row.offered_amount  != null) return safeNum(row.offered_amount);
    if(row.oferta_total    != null) return safeNum(row.oferta_total);

    return 0;
  }

  // ==========================
  // KPIs generales
  // ==========================
  function computeGeneralKpis(rows){
    rows = rows || [];

    var totalAward = 0;
    var itemSet   = new Set();
    var provSet   = new Set();

    rows.forEach(function(r){
      if(isWinner(r)){
        totalAward += getAwardedAmount(r);
      }

      var itemKey = r.renglon || r.item || r.codigo || r.id || r.nro_renglon;
      if(itemKey != null){
        itemSet.add(String(itemKey));
      }

      var provName = (r.proveedor || r.provider || r.proveedor_ganador || "").toString().trim();
      if(provName){
        provSet.add(provName);
      }
    });

    return {
      awarded : totalAward,
      items   : itemSet.size || rows.length,
      bidders : provSet.size || 0
    };
  }

  // ==========================
  // KPIs Suizo (fijos, no dependen de modo)
  // ==========================
  function computeSuizoKpis(rows){
    rows = rows || [];

    var suizoRows = rows.filter(isSuizoRow);

    var offered = 0;
    var awarded = 0;
    var itemsSet    = new Set();
    var wonItemsSet = new Set();

    suizoRows.forEach(function(r){
      offered += getOfferedAmount(r);

      if(isWinner(r)){
        awarded += getAwardedAmount(r);
      }

      var itemKey = r.renglon || r.item || r.codigo || r.id || r.nro_renglon;
      if(itemKey != null){
        var keyStr = String(itemKey);
        itemsSet.add(keyStr);
        if(isWinner(r)){
          wonItemsSet.add(keyStr);
        }
      }
    });

    var renglonesOf  = itemsSet.size || suizoRows.length;
    var renglonesAdj = wonItemsSet.size;

    var effMonto = offered > 0 ? (awarded / offered * 100) : null;
    var effReng  = renglonesOf > 0 ? (renglonesAdj / renglonesOf * 100) : null;

    return {
      offered       : offered,
      awarded       : awarded,
      effMonto      : effMonto,
      renglonesOf   : renglonesOf,
      renglonesAdj  : renglonesAdj,
      effReng       : effReng
    };
  }

  // ==========================
  // Treemap: agrupar por proveedor o por rengl√≥n
  // ==========================
  function groupTreemap(rows, grouping){
    rows = rows || [];
    var map = {};

    rows.forEach(function(r){
      if(!isWinner(r)) return;

      var key;
      if(grouping === "item"){
        key = r.renglon || r.item || r.codigo || r.id || "Rengl√≥n";
      } else {
        key = r.proveedor || r.provider || r.proveedor_ganador || "Sin proveedor";
      }

      key = String(key);
      var amt = getAwardedAmount(r);

      if(!map[key]) map[key] = 0;
      map[key] += amt;
    });

    var total = 0;
    Object.keys(map).forEach(function(k){
      total += map[k];
    });

    var nodes = Object.keys(map).map(function(k){
      return { label: k, value: map[k] };
    });

    return { total: total, nodes: nodes };
  }

  // Exponer helpers para el resto de los scripts (PARTE 3)
  window.__WC_DASH_HELPERS__ = {
    formatPeso,
    formatPct,
    safeNum,
    isSuizoRow,
    isWinner,
    getAwardedAmount,
    getOfferedAmount,
    computeGeneralKpis,
    computeSuizoKpis,
    groupTreemap
  };
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  // =======================
  // Helpers expuestos en la PARTE 2
  // =======================
  const H = window.__WC_DASH_HELPERS__ || {};
  const {
    formatPeso,
    formatPct,
    safeNum,
    isSuizoRow,
    isWinner,
    getAwardedAmount,
    getOfferedAmount,
    computeGeneralKpis,
    computeSuizoKpis,
    groupTreemap
  } = H;

  // Si por alg√∫n motivo no est√°n los helpers, no rompemos
  if (!computeGeneralKpis || !computeSuizoKpis) {
    console.warn('[dashboard] Helpers de KPIs no disponibles');
    return;
  }

  // =======================
  // Config / estado global
  // =======================
  const RANK_API = {{ rank_api_url|tojson }};
  let ALL_SIMPLE_ROWS = [];     // filas "planas" (1 por proveedor / rengl√≥n)
  let MODE = 'todos';           // 'suizo' | 'otros' | 'todos'

  // gr√°ficos
  let donutChart = null;
  let barChart   = null;

  // =======================
  // DOM helpers
  // =======================
  const $  = (sel, root) => (root || document).querySelector(sel);
  const $$ = (sel, root) => Array.from((root || document).querySelectorAll(sel));

  const elTabSuizo = $('#tabSuizo');
  const elTabOtros = $('#tabOtros');
  const elTabTodos = $('#tabTodos');

  const elTreemapTotalKpi = $('#treemapTotalKpi');
  const elTreemapTotalLbl = $('#treemapTotal');
  const elRengKpi         = $('#dg_renglones');
  const elCompKpi         = $('#dg_competidores');
  const elTreemapModeTg   = $('#treemapModeToggle');
  const elTreemapTitle    = $('#treemapTitle');

  const elES_monto_of   = $('#es_monto_ofertado');
  const elES_monto_adj  = $('#es_monto_adjudicado');
  const elES_ef_monto   = $('#es_efectividad_monto');
  const elES_ren_of     = $('#es_renglones_ofertados');
  const elES_ren_adj    = $('#es_renglones_adjudicados');
  const elES_ef_reng    = $('#es_efectividad_renglones');

  const elDonutCanvas = $('#donutSuizo');
  const elBarCanvas   = $('#barPosAgg');

  // =======================
  // Normalizaci√≥n de datos de ranking
  // =======================
  function toNumber(x) {
    if (x == null) return 0;
    if (typeof x === 'number' && isFinite(x)) return x;
    const s = String(x)
      .replace(/\s+/g, '')
      .replace(/[^0-9,.\-]/g, '')
      .replace(/\.(?=\d{3}([\D]|$))/g, '');
    const n = parseFloat(s.replace(',', '.'));
    return isFinite(n) ? n : 0;
  }

  function normalizeRankData(raw) {
    if (!raw) return [];
    const rows = Array.isArray(raw.rows) ? raw.rows : (Array.isArray(raw) ? raw : []);

    if (!rows.length) return [];

    // Caso 1: estructura con positions (tu API actual del dashboard)
    if (Array.isArray(rows[0].positions)) {
      const out = [];

      rows.forEach((r) => {
        const baseQty =
          toNumber(r.cantidad_solicitada ?? r.cantidad ?? r.qty ?? r.q ?? 0);
        const itemKey =
          r.renglon ?? r.item ?? r.nro ?? r.Nro ?? r.codigo ?? r.id ?? null;

        (r.positions || []).forEach((p) => {
          const provRaw = p.proveedor ?? p.provider ?? '';
          const prov    = String(provRaw || '').trim();
          const esSuizo = /suizo/i.test(prov);

          const pos = Number(p.pos ?? p.position ?? 0) || 0;

          const priceRaw =
            p.precio_unitario ?? p.precio ?? p.price ?? p.unit_price ?? 0;
          const price = toNumber(priceRaw);

          const qtyOffRaw =
            p.cantidad_ofertada ??
            p.cant_ofertada     ??
            p.cantidad          ??
            p.qty               ??
            baseQty             ??
            1;
          const qtyOff = toNumber(qtyOffRaw) || (baseQty || 1);

          const offeredVal = price > 0 ? price * qtyOff : 0;

          const winFlag = !!(p.adjudicado || p.is_winner || p.ganador);

          let qtyAdjRaw =
            p.cantidad_adjudicada ??
            p.cant_adjudicada     ??
            p.cantidad_asignada   ??
            null;
          let qtyAdj = 0;
          if (qtyAdjRaw != null) {
            qtyAdj = toNumber(qtyAdjRaw);
          } else if (winFlag || pos === 1) {
            qtyAdj = baseQty || qtyOff || 0;
          }

          const awardedVal = price > 0 ? price * qtyAdj : 0;
          const ganador    = awardedVal > 0 || winFlag;

          out.push({
            proveedor: prov,
            suizo: esSuizo,
            ganador: ganador,
            pos: pos,
            renglon: itemKey,
            monto_ofertado: offeredVal,
            monto_adjudicado: awardedVal
          });
        });
      });

      return out;
    }

    // Caso 2: ya viene plano -> s√≥lo completamos flags
    return rows.map((r) => {
      const provRaw = r.proveedor ?? r.provider ?? r.proveedor_ganador ?? '';
      const prov    = String(provRaw || '').trim();
      const esSuizo = /suizo/i.test(prov);

      let ganador = false;
      if (typeof isWinner === 'function') {
        ganador = !!isWinner(r);
      } else {
        ganador = !!(r.ganador || r.adjudicado || r.is_winner);
      }

      return Object.assign({}, r, {
        proveedor: prov,
        suizo: esSuizo,
        ganador: ganador,
        monto_ofertado: getOfferedAmount ? getOfferedAmount(r) : safeNum(r.monto_ofertado),
        monto_adjudicado: getAwardedAmount ? getAwardedAmount(r) : safeNum(r.monto_adjudicado)
      });
    });
  }

  // =======================
  // Segmentaci√≥n Suizo / Otros / Todos
  // =======================
  function rowsForMode(mode) {
    if (mode === 'suizo') {
      return ALL_SIMPLE_ROWS.filter((r) => {
        if (typeof isSuizoRow === 'function') return isSuizoRow(r);
        return !!r.suizo;
      });
    }
    if (mode === 'otros') {
      return ALL_SIMPLE_ROWS.filter((r) => {
        if (typeof isSuizoRow === 'function') return !isSuizoRow(r);
        return !r.suizo;
      });
    }
    // todos
    return ALL_SIMPLE_ROWS.slice();
  }

  function setMode(newMode) {
    MODE = newMode;

    const btns = {
      suizo: elTabSuizo,
      otros: elTabOtros,
      todos: elTabTodos
    };

    Object.keys(btns).forEach((key) => {
      const b = btns[key];
      if (!b) return;
      const active = (key === newMode);
      b.classList.toggle('active', active);
      b.setAttribute('aria-selected', active ? 'true' : 'false');
    });

    updateAll();
  }

  // =======================
  // Gr√°ficos (donut + barras)
  // =======================
  function initChartsIfNeeded() {
    if (!window.Chart) return;

    if (elDonutCanvas && !donutChart) {
      donutChart = new Chart(elDonutCanvas.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: ['Adjudicado', 'No adjudicado'],
          datasets: [{
            data: [0, 0],
            backgroundColor: ['#064066', '#dce3ee'],
            borderColor: '#ffffff',
            borderWidth: 2
          }]
        },
        options: {
          cutout: '55%',
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    if (elBarCanvas && !barChart) {
      barChart = new Chart(elBarCanvas.getContext('2d'), {
        type: 'bar',
        data: {
          labels: ['1', '2', 'Otras'],
          datasets: [{
            data: [0, 0, 0],
            backgroundColor: ['#064066', '#dce3ee', '#dce3ee'],
            borderColor: '#ffffff',
            borderWidth: 2
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true, ticks: { precision: 0 } }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }
  }

  // =======================
  // Actualizar "Datos generales" + Treemap
  // =======================
  function updateGeneralSection() {
    const rows = rowsForMode(MODE);
    const gk = computeGeneralKpis(rows) || { awarded: 0, items: 0, bidders: 0 };

    const totalAward = safeNum(gk.awarded);

    if (elTreemapTotalKpi) {
      elTreemapTotalKpi.textContent = formatPeso
        ? formatPeso(totalAward)
        : totalAward.toLocaleString('es-AR');
    }
    if (elTreemapTotalLbl) {
      elTreemapTotalLbl.textContent = totalAward
        ? 'Adjudicado: ' + (formatPeso ? formatPeso(totalAward) : totalAward.toLocaleString('es-AR'))
        : '';
    }
    if (elRengKpi) {
      elRengKpi.textContent = (gk.items || 0).toLocaleString('es-AR');
    }
    if (elCompKpi) {
      elCompKpi.textContent = (gk.bidders || 0).toLocaleString('es-AR');
    }

    // Treemap: agrupamos seg√∫n el toggle (Proveedor / Rengl√≥n) si existe
    let grouping = 'prov';
    if (elTreemapModeTg) {
      const activeBtn = elTreemapModeTg.querySelector('.mini-btn.active');
      if (activeBtn && activeBtn.dataset.mode === 'item') {
        grouping = 'item';
      }
    }

    if (groupTreemap) {
      const info = groupTreemap(rows, grouping) || { total: totalAward, nodes: [] };
      const data = (info.nodes || []).map(d => ({ label: d.label, value: d.value }));

      // Si existe updateTreemap (script espec√≠fico del treemap), lo usamos
      if (typeof window.updateTreemap === 'function') {
        window.updateTreemap(data);
      }

      const finalTotal = safeNum(info.total || totalAward || 0);
      if (elTreemapTotalKpi && formatPeso) {
        elTreemapTotalKpi.textContent = formatPeso(finalTotal);
      }
      if (elTreemapTotalLbl && formatPeso) {
        elTreemapTotalLbl.textContent = finalTotal
          ? 'Adjudicado: ' + formatPeso(finalTotal)
          : '';
      }

      if (elTreemapTitle) {
        elTreemapTitle.textContent =
          (grouping === 'item')
            ? 'Proporci√≥n de presupuesto por rengl√≥n'
            : 'Proporci√≥n de presupuesto por proveedor';
      }
    }
  }

  // =======================
  // Actualizar "Efectividad Suizo" + donut + barras
  // =======================
  function updateSuizoSection() {
    // Siempre calculado SOLO con las filas de Suizo
    const rowsSuizo = rowsForMode('suizo');
    const sk = computeSuizoKpis(rowsSuizo) || {
      offered: 0,
      awarded: 0,
      effMonto: null,
      renglonesOf: 0,
      renglonesAdj: 0,
      effReng: null
    };

    if (elES_monto_of) {
      elES_monto_of.textContent = formatPeso
        ? formatPeso(sk.offered || 0)
        : (safeNum(sk.offered || 0)).toLocaleString('es-AR');
    }
    if (elES_monto_adj) {
      elES_monto_adj.textContent = formatPeso
        ? formatPeso(sk.awarded || 0)
        : (safeNum(sk.awarded || 0)).toLocaleString('es-AR');
    }
    if (elES_ef_monto) {
      elES_ef_monto.textContent = (sk.effMonto != null)
        ? (formatPct ? formatPct(sk.effMonto) : (sk.effMonto.toFixed(1) + ' %'))
        : '0 %';
    }
    if (elES_ren_of) {
      elES_ren_of.textContent = (sk.renglonesOf || 0).toLocaleString('es-AR');
    }
    if (elES_ren_adj) {
      elES_ren_adj.textContent = (sk.renglonesAdj || 0).toLocaleString('es-AR');
    }
    if (elES_ef_reng) {
      elES_ef_reng.textContent = (sk.effReng != null)
        ? (formatPct ? formatPct(sk.effReng) : (sk.effReng.toFixed(1) + ' %'))
        : '0 %';
    }

    // Gr√°ficos (solo Suizo)
    initChartsIfNeeded();

    if (donutChart) {
      const adj   = safeNum(sk.awarded || 0);
      const off   = safeNum(sk.offered || 0);
      const noAdj = Math.max(0, off - adj);

      donutChart.data.labels = ['Adjudicado Suizo', 'No adjudicado Suizo'];
      donutChart.data.datasets[0].data = [adj, noAdj];
      donutChart.update('none');
    }

    if (barChart) {
      const buckets = [0, 0, 0]; // 1¬∞, 2¬∞, otras
      rowsSuizo.forEach((r) => {
        if (!r.ganador) return;
        const pos = Number(r.pos || 0);
        if (pos === 1)      buckets[0] += 1;
        else if (pos === 2) buckets[1] += 1;
        else if (pos >= 3)  buckets[2] += 1;
      });

      barChart.data.datasets[0].data = buckets;
      barChart.update('none');
    }
  }

  // =======================
  // Refresco global
  // =======================
  function updateAll() {
    if (!ALL_SIMPLE_ROWS.length) return;
    updateGeneralSection(); // respeta el modo actual (Suizo / Otros / Todos)
    updateSuizoSection();   // SIEMPRE Suizo, independiente del modo visible
  }

  // =======================
  // Listeners de tabs
  // =======================
  if (elTabSuizo) {
    elTabSuizo.addEventListener('click', function (e) {
      e.preventDefault();
      setMode('suizo');
    });
  }
  if (elTabOtros) {
    elTabOtros.addEventListener('click', function (e) {
      e.preventDefault();
      setMode('otros');
    });
  }
  if (elTabTodos) {
    elTabTodos.addEventListener('click', function (e) {
      e.preventDefault();
      setMode('todos');
    });
  }

  // Cambio proveedor/rengl√≥n del treemap
  if (elTreemapModeTg) {
    elTreemapModeTg.addEventListener('click', function (e) {
      const btn = e.target.closest('button[data-mode]');
      if (!btn) return;

      elTreemapModeTg.querySelectorAll('.mini-btn').forEach((b) => {
        const active = b === btn;
        b.classList.toggle('active', active);
        b.setAttribute('aria-pressed', active ? 'true' : 'false');
      });

      // Recalcular treemap seg√∫n nuevo agrupamiento
      updateGeneralSection();
    });
  }

  // =======================
  // Carga de datos
  // =======================
  async function loadData() {
    try {
      const res = await fetch(RANK_API, { headers: { 'accept': 'application/json' } });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();

      ALL_SIMPLE_ROWS = normalizeRankData(data) || [];
      console.info('[dashboard] filas normalizadas para KPIs/treemap:', ALL_SIMPLE_ROWS.length);

      // Modo por defecto: TODOS
      setMode('todos');
    } catch (err) {
      console.error('[dashboard] Error cargando ranking para KPIs:', err);
    }
  }

  loadData();
});
</script>
{% endblock %}
